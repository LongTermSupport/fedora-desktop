# Git Account Management - Hybrid Implementation Plan

## Overview

Implement automatic git account detection and identity management using a hybrid Bash/Python approach. The solution will transparently detect which GitHub account to use based on repository remote URLs and automatically apply the correct SSH keys and git identity.

## Architecture

```
┌─────────────────────────────────────┐
│  Bash Functions (shell wrappers)   │
│  Location: ~/.bashrc-includes/     │
│           gh-aliases.inc.bash       │
│                                     │
│  - git() wrapper                    │
│  - git-ec(), git-lts(), etc.        │
│  - git-which-account()              │
│  - git-accounts()                   │
└──────────────┬──────────────────────┘
               │ calls
               ▼
┌─────────────────────────────────────┐
│  Python CLI Tool                    │
│  Location: ~/.local/bin/            │
│           git-account-helper        │
│                                     │
│  Commands:                          │
│  - detect [repo-path]               │
│  - email <username>                 │
│  - info <repo-path>                 │
└─────────────────────────────────────┘
```

## Design Principles

1. **Transparent**: Plain `git` commands auto-detect account from remote URL
2. **Safe**: Private functions use `_` prefix
3. **No repo modification**: Never modify local git config
4. **Override capability**: `git-<alias>` commands available for explicit control
5. **Non-GitHub compatible**: Other remotes work normally

## Components

### 1. Python Helper Script

**File**: `files/home/.local/bin/git-account-helper`

**Responsibilities**:
- Parse git remote URLs to extract account alias
- Cache and retrieve email addresses for GitHub accounts
- Provide structured repo information (JSON output)
- Read account configuration from Ansible-generated config file

**Commands**:
```bash
git-account-helper detect [path]     # Output: alias or exit 1
git-account-helper email <username>  # Output: email address
git-account-helper info [path]       # Output: JSON with full info
```

**Account Configuration**:
- Read from: `~/.config/git-account-helper/accounts.json`
- Generated by Ansible from `github_accounts` variable
- Format: `{"alias": "username", ...}`

**Email Caching**:
- Location: `~/.cache/git-account-helper/<username>.email`
- Fetch from gh API, cache for performance
- Fallback: `<username>@users.noreply.github.com`

### 2. Bash Functions

**File**: `~/.bashrc-includes/gh-aliases.inc.bash` (extended)

#### Main Git Wrapper
```bash
function git() {
    # Outside repo: use plain git
    # Inside repo: detect account, route to appropriate handler
    # No account detected: check command type, guide user
}
```

#### Private Internal Functions
```bash
function _git_detect_account() {
    git-account-helper detect 2>/dev/null
}

function _git_ec_internal() {
    # Execute git with ec account SSH + identity
}

# ... similar for each account
```

#### Public Override Functions
```bash
function git-ec() {
    # Check for mismatch, prompt confirmation
    # Execute via internal function
}

# ... similar for each account
```

#### Info Functions
```bash
function git-which-account() {
    # Show current repo account detection
}

function git-accounts() {
    # List all available accounts
}
```

### 3. Ansible Playbook Updates

**File**: `playbooks/imports/optional/common/play-github-cli-multi.yml`

**New Tasks**:

1. Generate Python script from template
   - Template: `files/home/.local/bin/git-account-helper.j2`
   - Destination: `/home/{{ user_login }}/.local/bin/git-account-helper`
   - Mode: `0755`

2. Generate accounts config for Python
   - Destination: `/home/{{ user_login }}/.config/git-account-helper/accounts.json`
   - Content: JSON representation of `github_accounts`
   - Mode: `0644`

3. Create cache directory
   - Path: `/home/{{ user_login }}/.cache/git-account-helper`
   - Mode: `0755`

4. Update bash functions template
   - Extend existing `gh-aliases.inc.bash` generation
   - Add git wrapper and helper functions
   - Generate account-specific functions from loop

## Implementation Steps

### Phase 1: Python Helper Script

1. Create Python script template at `files/home/.local/bin/git-account-helper.j2`
2. Implement account detection logic (regex on remote URL)
3. Implement email caching with gh API integration
4. Implement info command with JSON output
5. Add error handling and fallbacks

### Phase 2: Bash Functions

1. Update `play-github-cli-multi.yml` bash function generation
2. Add main `git()` wrapper with detection logic
3. Add private `_git_<alias>_internal()` functions
4. Add public `git-<alias>()` override functions with confirmation
5. Add helper functions (git-which-account, git-accounts)
6. Handle command categorization (local vs network vs identity-required)

### Phase 3: Ansible Integration

1. Add task to deploy Python script
2. Add task to generate accounts config JSON
3. Add task to create cache directory
4. Update bash function generation block
5. Update completion message with new commands

### Phase 4: Testing

1. Test account detection in various scenarios
2. Test email caching and retrieval
3. Test plain git command routing
4. Test explicit git-<alias> overrides
5. Test non-GitHub remotes
6. Test repos without remotes
7. Test confirmation prompts

## Command Behavior Matrix

| Scenario | Command | Behavior |
|----------|---------|----------|
| Repo with `git@github.com-ec:` | `git status` | Auto-detect ec, use ec identity |
| Repo with `git@github.com-ec:` | `git commit` | Auto-detect ec, use ec identity |
| Repo with `git@github.com-ec:` | `git push` | Auto-detect ec, use ec SSH key |
| Repo with `git@github.com-ec:` | `git-lts push` | Prompt confirmation, use lts identity |
| Repo with `git@github.com:` | `git push` | Error: cannot detect, show guidance |
| Repo with GitLab remote | `git push` | Use plain git (pass-through) |
| Repo with no remote | `git commit` | Error: use git-<alias> |
| Outside repo | `git status` | Plain git (pass-through) |
| New repo | `git init` | Error: use git-<alias> init |

## File Structure

```
/workspace/
├── playbooks/imports/optional/common/
│   └── play-github-cli-multi.yml          # Updated with new tasks
├── files/
│   └── home/.local/bin/
│       └── git-account-helper.j2           # New: Python script template
└── .claude/plan/
    └── git-account-management-hybrid.md    # This file

After deployment:
~/.local/bin/git-account-helper             # Executable Python script
~/.config/git-account-helper/accounts.json  # Account configuration
~/.cache/git-account-helper/*.email         # Email cache files
~/.bashrc-includes/gh-aliases.inc.bash      # Extended bash functions
```

## Edge Cases & Error Handling

1. **Multiple remotes**: Check origin first, then first available remote
2. **Unknown alias in URL**: Warn but allow (pass to plain git)
3. **gh CLI not authenticated**: Fall back to noreply email
4. **Python script missing**: Bash functions should detect and error gracefully
5. **Accounts config missing**: Python should error with helpful message
6. **Non-GitHub GitHub (GHE)**: Currently out of scope, use plain git
7. **SSH vs HTTPS remotes**: Only handle SSH (git@github.com-*)

## Success Criteria

1. ✅ Plain `git commit/push` works transparently in properly configured repos
2. ✅ Account detection works for all configured accounts
3. ✅ Email caching reduces API calls
4. ✅ Override functions work with confirmation prompts
5. ✅ Non-GitHub repos still work normally
6. ✅ Clear error messages guide proper configuration
7. ✅ Private functions use `_` prefix
8. ✅ No modification of repository git config

## Future Enhancements (Out of Scope)

- Tab completion for git-<alias> commands
- Support for HTTPS remotes (currently SSH-only)
- Support for GitHub Enterprise
- Bulk repository reconfiguration tool
- GUI/TUI for account management
- Support for other git hosting providers (GitLab, Bitbucket)
