#!/bin/bash
#
# Claude Code Hooks - Status Line
#
# Forwards Status event to daemon via Unix socket and outputs plain text.
# This hook is called by Claude Code to populate the status line display.
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../init.sh"

# Ensure daemon is running (lazy startup)
if ! ensure_daemon; then
    # ERROR: Daemon failed to start - make it visible
    echo "⚠️ DAEMON FAILED"
    exit 1
fi

# Pipe JSON directly through socket
# Add hook_event_name to input, then wrap in standard request format
# Note: Status event returns context array that needs to be joined
jq -c '. + {hook_event_name: "Status"} | {event: "Status", hook_input: .}' | send_request_stdin | jq -r '
  if .error then
    "⚠️ ERROR: " + .error
  elif .result.context and (.result.context | length > 0) then
    .result.context | join(" ")
  else
    "⚠️ NO STATUS DATA"
  end
'
