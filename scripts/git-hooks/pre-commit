#!/bin/bash
#
# Pre-commit hook: Prevent committing sensitive information to public repository
# This hook scans staged changes for patterns that might leak private information
#

set -e

# ANSI color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Sensitive patterns to detect (using generic patterns, no actual sensitive data)
# Each pattern has format: "pattern::description" (using :: to avoid conflicts with | in regex)
declare -a SENSITIVE_PATTERNS=(
    # Email domains that might be personal/company-specific (exclude common examples)
    "@[a-z0-9-]+\\.(dev|internal|corp|local)::Private email domain"

    # Common username patterns with company/personal identifiers
    # Will exclude example_user, test_user, etc. in the script logic below
    "[a-z]{3,}_[a-z]{3,}\\.(token|key|credential)::Specific username in credential filename"

    # SSH/API key patterns (actual keys, not references)
    "ssh-rsa [A-Za-z0-9+/=]{50,}::SSH public key"
    "ssh-ed25519 [A-Za-z0-9+/=]{50,}::SSH Ed25519 public key"
    "sk-ant-[a-z0-9-]{50,}::Anthropic API token"
    "ghp_[A-Za-z0-9]{36,}::GitHub personal access token"
    "gho_[A-Za-z0-9]{36,}::GitHub OAuth token"

    # AWS credentials
    "AKIA[0-9A-Z]{16}::AWS access key ID"

    # Home directory paths (but allow {{ user_login }} and generic 'username')
    "/home/[a-z][a-z0-9_-]{2,}[^}]::Hardcoded username in path (use {{ user_login }})"

    # Private IP addresses (specific ones, not documentation)
    "192\\.168\\.[0-9]{1,3}\\.[0-9]{1,3}::Private IP address (192.168.x.x)"
    "10\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}::Private IP address (10.x.x.x)"
)

echo "ğŸ” Scanning staged changes for sensitive information..."

# Get list of staged files (exclude deletions)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=d 2>/dev/null || true)

if [ -z "$STAGED_FILES" ]; then
    echo "âœ“ No files staged for commit"
    exit 0
fi

FOUND_ISSUES=0

# Check each staged file
for FILE in $STAGED_FILES; do
    # Skip binary files
    if git diff --cached --numstat "$FILE" | grep -q '^-'; then
        continue
    fi

    # Get the staged content
    STAGED_CONTENT=$(git show ":$FILE" 2>/dev/null || true)

    if [ -z "$STAGED_CONTENT" ]; then
        continue
    fi

    # Check each pattern
    for PATTERN_DESC in "${SENSITIVE_PATTERNS[@]}"; do
        PATTERN="${PATTERN_DESC%%::*}"
        DESCRIPTION="${PATTERN_DESC##*::}"

        # Search for pattern
        if echo "$STAGED_CONTENT" | grep -qE "$PATTERN"; then
            # Skip if it's a known-safe placeholder pattern
            if echo "$PATTERN" | grep -q "credential" && \
               echo "$STAGED_CONTENT" | grep -E "$PATTERN" | grep -qE "(example_|test_|sample_|demo_|user_name|company_name)"; then
                continue
            fi
            # Skip Jinja2/Ansible method calls like github_accounts.keys()
            if echo "$PATTERN" | grep -q "credential" && \
               echo "$STAGED_CONTENT" | grep -E "$PATTERN" | grep -qE "\\.keys\\(\\)|\\.values\\(\\)|\\.items\\(\\)"; then
                continue
            fi
            # Skip if it's the repository files/home/ directory structure (not system paths)
            if echo "$PATTERN" | grep -q "/home/" && \
               echo "$STAGED_CONTENT" | grep -E "$PATTERN" | grep -qE "files/home/(bashrc-includes|[a-z-]+)"; then
                continue
            fi
            if [ $FOUND_ISSUES -eq 0 ]; then
                echo ""
                echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
                echo -e "${RED}âš   SENSITIVE INFORMATION DETECTED${NC}"
                echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
                echo ""
                echo "This is a PUBLIC REPOSITORY. Never commit:"
                echo "  â€¢ Personal information (names, emails, usernames)"
                echo "  â€¢ Credentials (API keys, tokens, passwords)"
                echo "  â€¢ Local paths with usernames"
                echo "  â€¢ Company/infrastructure references"
                echo ""
            fi

            echo -e "${YELLOW}File: $FILE${NC}"
            echo -e "${YELLOW}Issue: $DESCRIPTION${NC}"

            # Show context (up to 3 matching lines)
            echo "$STAGED_CONTENT" | grep -nE "$PATTERN" | head -3 | while IFS=: read -r LINE_NUM LINE_CONTENT; do
                echo "  Line $LINE_NUM: ${LINE_CONTENT:0:100}"
            done
            echo ""

            FOUND_ISSUES=1
        fi
    done
done

if [ $FOUND_ISSUES -eq 1 ]; then
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}COMMIT REJECTED${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "Actions to take:"
    echo "  1. Remove or replace the sensitive information with generic placeholders"
    echo "  2. Use Ansible variables ({{ user_login }}) instead of hardcoded values"
    echo "  3. Add truly sensitive data to Ansible Vault"
    echo "  4. Review CLAUDE.md 'PUBLIC REPOSITORY WARNING' section"
    echo ""
    echo "To bypass this check (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

echo "âœ“ No sensitive patterns detected in staged changes"
exit 0
