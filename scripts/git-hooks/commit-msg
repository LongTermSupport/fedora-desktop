#!/bin/bash
#
# Commit-msg hook: Prevent committing messages with sensitive information
# This hook scans the commit message for patterns that might leak private information
#

set -e

# ANSI color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

COMMIT_MSG_FILE="$1"

if [ ! -f "$COMMIT_MSG_FILE" ]; then
    echo "ERROR: Commit message file not found: $COMMIT_MSG_FILE"
    exit 1
fi

# Read commit message
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip merge commits (they often contain branch names with potential identifiers)
if echo "$COMMIT_MSG" | grep -q "^Merge branch"; then
    exit 0
fi

# Sensitive patterns specific to commit messages
# Format: "pattern::description::suggested_fix" (using :: to avoid conflicts with | in regex)
declare -a MESSAGE_PATTERNS=(
    # Specific username patterns
    # Will exclude example_user, test_user, etc. in script logic below
    "[a-z]{3,}_[a-z]{3,}\\.(token|key|json)::Specific username in filename::Use: example_user.token"

    # Email addresses (except generic examples and noreply)
    "@.*\\.(dev|internal|corp|local)::Private email domain::Use: @example.com"

    # Real usernames in paths (not {{ variables }} or 'username')
    "/home/[a-z][a-z0-9_-]{2,}[^}]::Hardcoded username in path::Use: {{ user_login }} or generic placeholder"

    # Private IP addresses (specific format, not x.x.x.x placeholders)
    "192\\.168\\.[0-9]{1,3}\\.[0-9]{1,3}::Private IP address::Use: 192.168.x.x"
    "10\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}::Private IP address::Use: 10.x.x.x"

    # Real API tokens/keys (long enough to be real, not examples)
    "sk-ant-[a-z0-9-]{50,}::Anthropic API token::Remove or redact"
    "ghp_[A-Za-z0-9]{36,}::GitHub token::Remove or redact"
)

FOUND_ISSUES=0

# Check each pattern
for PATTERN_INFO in "${MESSAGE_PATTERNS[@]}"; do
    PATTERN="${PATTERN_INFO%%::*}"
    REMAINDER="${PATTERN_INFO#*::}"
    DESCRIPTION="${REMAINDER%%::*}"
    SUGGESTION="${REMAINDER#*::}"

    if echo "$COMMIT_MSG" | grep -qE "$PATTERN"; then
        # Skip if it's a known-safe placeholder pattern
        if echo "$PATTERN" | grep -q "token|key|json" && \
           echo "$COMMIT_MSG" | grep -E "$PATTERN" | grep -qE "(example_|test_|sample_|demo_|user_name|company_name)"; then
            continue
        fi
        # Skip if it's the repository files/home/ directory structure (not system paths)
        if echo "$PATTERN" | grep -q "/home/" && \
           echo "$COMMIT_MSG" | grep -E "$PATTERN" | grep -qE "files/home/(bashrc-includes|[a-z-]+)"; then
            continue
        fi
        if [ $FOUND_ISSUES -eq 0 ]; then
            echo ""
            echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
            echo -e "${RED}⚠  SENSITIVE INFORMATION IN COMMIT MESSAGE${NC}"
            echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
            echo ""
            echo "This commit message contains information that should NOT be in a public repository."
            echo ""
        fi

        echo -e "${YELLOW}Issue: $DESCRIPTION${NC}"
        echo -e "Suggestion: $SUGGESTION"

        # Show matching lines
        echo "$COMMIT_MSG" | grep -nE "$PATTERN" | head -3 | while IFS=: read -r LINE_NUM LINE_CONTENT; do
            echo "  Line $LINE_NUM: ${LINE_CONTENT:0:80}"
        done
        echo ""

        FOUND_ISSUES=1
    fi
done

if [ $FOUND_ISSUES -eq 1 ]; then
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}COMMIT REJECTED${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "Actions to take:"
    echo "  1. Edit your commit message to remove/replace sensitive information"
    echo "  2. Use generic placeholders (example_user, company-infra, 192.168.x.x)"
    echo "  3. Remove any hardcoded usernames, emails, or tokens"
    echo ""
    echo "To edit the commit message:"
    echo "  git commit --edit --file=$COMMIT_MSG_FILE"
    echo ""
    echo "To bypass this check (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

echo "✓ Commit message looks clean"
exit 0
