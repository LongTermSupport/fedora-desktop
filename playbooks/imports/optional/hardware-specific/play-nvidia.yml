---
#!/usr/bin/env ansible-playbook
# Install NVIDIA drivers using RPM Fusion (recommended method for Fedora 42)
# For RTX 500 Ada Generation and other modern NVIDIA GPUs
#
# Vulkan support is installed by default (required for modern gaming, AI apps, GPU compute)
# To disable, add to host_vars/localhost.yml: nvidia_install_vulkan: false
- hosts: desktop
  become: true
  vars:
    root_dir: "{{ inventory_dir }}/../../"
  vars_files:
    - "{{ root_dir }}/vars/fedora-version.yml"
  tasks:
    - name: Enable RPM Fusion repositories
      ansible.builtin.dnf:
        name:
          - "https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-{{ fedora_version }}.noarch.rpm"
          - "https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-{{ fedora_version }}.noarch.rpm"
        state: present
        disable_gpg_check: true

    - name: Update system packages
      ansible.builtin.dnf:
        name: "*"
        state: latest

    - name: Install NVIDIA driver packages
      ansible.builtin.dnf:
        name:
          - akmod-nvidia
          - xorg-x11-drv-nvidia-cuda # For CUDA/NVDEC/NVENC support
          - xorg-x11-drv-nvidia-cuda-libs
          - xorg-x11-drv-nvidia-power
          - nvidia-vaapi-driver # For hardware video acceleration
        state: present

    - name: Install Vulkan Support for NVIDIA
      ansible.builtin.dnf:
        name:
          # Core Vulkan runtime
          - vulkan-loader
          - vulkan-tools # For vulkaninfo, vulkan-smoketest
          # NVIDIA-specific Vulkan driver (ICD - Installable Client Driver)
          - xorg-x11-drv-nvidia-libs
          - nvidia-gpu-firmware
        state: present
      when: nvidia_install_vulkan | default(true) | bool

    # =========================================================================
    # Secure Boot MOK Signing Support
    # =========================================================================

    - name: Check if Secure Boot is enabled
      ansible.builtin.shell: mokutil --sb-state
      register: secure_boot_state
      changed_when: false
      failed_when: false

    - name: Install MOK prerequisites
      ansible.builtin.dnf:
        name:
          - mokutil
          - expect
          - kernel-devel
          - kernel-headers
        state: present

    - name: Validate MOK password is in vault
      ansible.builtin.assert:
        that:
          - mok_password is defined
        fail_msg: |
          ERROR: MOK password not found in vault!

          Please add 'mok_password' to your vault configuration:
          ansible-vault edit environment/localhost/host_vars/localhost.yml

          Add: mok_password: "your-password"

          This password will be used once during boot to enroll the MOK key.
      when: "'SecureBoot enabled' in secure_boot_state.stdout"

    - name: Generate akmods MOK signing key
      ansible.builtin.command: kmodgenca -a
      args:
        creates: /etc/pki/akmods/certs/public_key.der
      when: "'SecureBoot enabled' in secure_boot_state.stdout"

    - name: Check if akmods MOK key exists
      ansible.builtin.stat:
        path: /etc/pki/akmods/certs/public_key.der
      register: akmods_mok_key

    - name: Check if MOK is already enrolled
      ansible.builtin.shell: mokutil --test-key /etc/pki/akmods/certs/public_key.der
      register: mok_enrolled
      changed_when: false
      failed_when: false
      when:
        - "'SecureBoot enabled' in secure_boot_state.stdout"
        - akmods_mok_key.stat.exists

    - name: Import MOK key for enrollment
      ansible.builtin.shell: |
        expect -c "
        spawn mokutil --import /etc/pki/akmods/certs/public_key.der
        expect \"input password:\"
        send \"{{ mok_password }}\r\"
        expect \"input password again:\"
        send \"{{ mok_password }}\r\"
        expect eof
        "
      when:
        - "'SecureBoot enabled' in secure_boot_state.stdout"
        - akmods_mok_key.stat.exists
        - "'is not enrolled' in mok_enrolled.stdout | default('')"
      register: mok_import

    - name: Display MOK enrollment password
      ansible.builtin.pause:
        prompt: |2

          ========================================================================
          IMPORTANT: SECURE BOOT MOK ENROLLMENT REQUIRED
          ========================================================================

          Your MOK enrollment password is: {{ mok_password }}

          MEMORIZE THIS PASSWORD NOW!

          After reboot:
          1. You will see a blue MOK Manager screen
          2. Select "Enroll MOK"
          3. Select "Continue"
          4. Select "Yes"
          5. Enter the password shown above: {{ mok_password }}
          6. Select "Reboot"

          The password will ONLY be needed this one time during enrollment.

          Press ENTER only after you have memorized the password...
          ========================================================================
      when:
        - "'SecureBoot enabled' in secure_boot_state.stdout"
        - mok_import is changed

    # =========================================================================
    # Kernel Module Build
    # =========================================================================

    - name: Wait for kernel module to build
      ansible.builtin.pause:
        prompt: |2

          ============================================
          NVIDIA KERNEL MODULE BUILDING
          ============================================

          The NVIDIA kernel module is now building.
          This can take up to 5 minutes.

          To check if it's complete, run in another terminal:
          modinfo -F version nvidia

          This should output the driver version (e.g., 580.76)
          If you see "Module nvidia not found", wait longer.

          Press ENTER when the module is built...

    - name: Force rebuild kernel modules if needed
      ansible.builtin.shell: |
        akmods --force
        dracut --force
      register: rebuild_result
      changed_when: rebuild_result.rc == 0

    - name: Important post-installation instructions
      ansible.builtin.pause:
        prompt: |2-

          ========================================================================
          NVIDIA DRIVER INSTALLATION COMPLETE
          ========================================================================

          {% if 'SecureBoot enabled' in secure_boot_state.stdout and mok_import is changed %}
          ⚠️  ACTION REQUIRED: MOK ENROLLMENT

          1. Reboot your system now: sudo reboot
          2. Enroll the MOK key using the password you memorized ({{ mok_password }})
          3. After successful enrollment, NVIDIA drivers will work automatically

          After reboot and MOK enrollment, verify with:
          - nvidia-smi                              # Check driver/GPU status
          - lsmod | grep nvidia                     # Check kernel module
          {% if nvidia_install_vulkan | default(true) | bool %}
          - vulkaninfo | grep -i 'device name'     # Check Vulkan GPU
          - vulkaninfo --summary                    # Vulkan devices list
          {% endif %}

          {% elif 'SecureBoot enabled' in secure_boot_state.stdout and 'is already enrolled' in mok_enrolled.stdout | default('') %}
          ✅ MOK key is already enrolled. NVIDIA drivers are configured.

          REBOOT REQUIRED to load new drivers!

          After reboot, verify with:
          - nvidia-smi                              # Check driver/GPU status
          - lsmod | grep nvidia                     # Check kernel module
          {% if nvidia_install_vulkan | default(true) | bool %}
          - vulkaninfo | grep -i 'device name'     # Check Vulkan GPU
          - vulkaninfo --summary                    # Vulkan devices list
          {% endif %}

          {% else %}
          ✅ Secure Boot is disabled. NVIDIA drivers are configured.

          IMPORTANT: You must REBOOT for drivers to load!

          After reboot, verify with:
          - nvidia-smi                              # Check driver/GPU status
          - lsmod | grep nvidia                     # Check kernel module
          {% if nvidia_install_vulkan | default(true) | bool %}
          - vulkaninfo | grep -i 'device name'     # Check Vulkan GPU
          - vulkaninfo --summary                    # Vulkan devices list
          {% endif %}
          {% endif %}

          Packages installed:
          - NVIDIA proprietary drivers (akmod-nvidia)
          - CUDA/NVENC/NVDEC support
          - VA-API hardware video acceleration
          {% if nvidia_install_vulkan | default(true) | bool %}
          - Vulkan GPU compute/graphics support
          {% else %}
          - Vulkan support: SKIPPED (nvidia_install_vulkan: false)
          {% endif %}
          {% if 'SecureBoot enabled' in secure_boot_state.stdout %}
          - Secure Boot MOK signing configured
          {% endif %}

          Configuration options:
          - To disable Vulkan: nvidia_install_vulkan: false (in host_vars/localhost.yml)
          - Secure Boot status: mokutil --sb-state

          Press ENTER to acknowledge...
          ========================================================================
