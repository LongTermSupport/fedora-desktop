---
#!/usr/bin/env ansible-playbook
# DisplayLink is used by USB Docks for Extra Monitors
# Handles Secure Boot by enrolling MOK key for kernel module signing
- hosts: desktop
  become: true
  vars:
    root_dir: "{{ inventory_dir }}/../../"
    # Version configuration
    displaylink_version: "v6.1.1-4"
    evdi_version: "1.14.11"
    # Set to true to bypass version check (use with caution)
    force_install: false
  tasks:
    - name: Check if Secure Boot is enabled
      ansible.builtin.shell: mokutil --sb-state
      register: secure_boot_state
      changed_when: false
      failed_when: false

    - name: Validate MOK password is in vault
      ansible.builtin.assert:
        that:
          - mok_password is defined
        fail_msg: |
          ERROR: MOK password not found in vault!

          Please add 'mok_password' to your vault configuration:
          ansible-vault edit environment/localhost/host_vars/localhost.yml

          Add: mok_password: "your-password"

          This password will be used once during boot to enroll the MOK key.
      when: "'SecureBoot enabled' in secure_boot_state.stdout"

    - name: Install prerequisites for DisplayLink
      ansible.builtin.dnf:
        name:
          - mokutil
          - dkms
          - kernel-devel
          - kernel-headers
          - expect
        state: present

    - name: Fetch latest DisplayLink release from GitHub
      ansible.builtin.uri:
        url: https://api.github.com/repos/displaylink-rpm/displaylink-rpm/releases/latest
        return_content: true
      register: github_release
      changed_when: false
      failed_when: false

    - name: Parse latest version information
      ansible.builtin.set_fact:
        latest_version: "{{ github_release.json.tag_name | default('unknown') }}"
        version_check_failed: "{{ github_release.status != 200 }}"
      when: github_release is defined

    - name: Display version information
      ansible.builtin.debug:
        msg:
          - "Playbook version: {{ displaylink_version }}"
          - "Latest GitHub version: {{ latest_version | default('Unable to fetch') }}"
          - "Status: {{ 'UP TO DATE' if (latest_version | default('') == displaylink_version) else ('VERSION CHECK FAILED' if version_check_failed else 'NOT UP TO
            DATE') }}"
          - "{{ 'Installation: FORCED (bypassing version check)' if (force_install and latest_version | default('') != displaylink_version and not version_check_failed)
            else '' }}"

    - name: Validate DisplayLink package version is current
      ansible.builtin.assert:
        that:
          - force_install or version_check_failed or (latest_version == displaylink_version)
        fail_msg: |
          ERROR: DisplayLink package version is outdated!

          Playbook version: {{ displaylink_version }}
          Latest version:   {{ latest_version }}

          This playbook is using an outdated DisplayLink package which may not be
          compatible with your current kernel version.

          To fix this issue:

          1. Update the playbook with the latest version:
             - Edit: playbooks/imports/optional/hardware-specific/play-displaylink.yml
             - Update 'displaylink_version' variable to: {{ latest_version }}
             - Update the download URL in 'Install DisplayLink RPM' task

          2. Check the latest release at:
             https://github.com/displaylink-rpm/displaylink-rpm/releases/latest

          3. To force installation anyway (NOT RECOMMENDED), run with:
             ansible-playbook playbooks/imports/optional/hardware-specific/play-displaylink.yml \
               -e force_install=true

          Note: Installing an outdated version may fail to build against newer kernels.
        success_msg: "DisplayLink package version is current: {{ displaylink_version }}"
      when: not version_check_failed

    - name: Warning about version check failure
      ansible.builtin.debug:
        msg:
          - "WARNING: Unable to verify DisplayLink package version against GitHub"
          - "Proceeding with installation of version: {{ displaylink_version }}"
          - "If installation fails, manually check for updates at:"
          - "https://github.com/displaylink-rpm/displaylink-rpm/releases"
      when: version_check_failed

    - name: Install DisplayLink RPM
      ansible.builtin.dnf:
      #  name: "https://github.com/displaylink-rpm/displaylink-rpm/releases/download/{{ displaylink_version }}/fedora-42-displaylink-{{ evdi_version }}-1.github_evdi.x86_64.rpm"
        name: "https://github.com/displaylink-rpm/displaylink-rpm/releases/download/v6.1.1-4/fedora-42-displaylink-1.14.12-1.github_evdi.x86_64.rpm"
        disable_gpg_check: true
      register: displaylink_install

    - name: Check if DKMS MOK key exists
      ansible.builtin.stat:
        path: /var/lib/dkms/mok.pub
      register: mok_key

    - name: Check if MOK is already enrolled
      ansible.builtin.shell: mokutil --test-key /var/lib/dkms/mok.pub
      register: mok_enrolled
      changed_when: false
      failed_when: false
      when:
        - "'SecureBoot enabled' in secure_boot_state.stdout"
        - mok_key.stat.exists

    - name: Import MOK key for enrollment
      ansible.builtin.shell: |
        expect -c "
        spawn mokutil --import /var/lib/dkms/mok.pub
        expect \"input password:\"
        send \"{{ mok_password }}\r\"
        expect \"input password again:\"
        send \"{{ mok_password }}\r\"
        expect eof
        "
      when:
        - "'SecureBoot enabled' in secure_boot_state.stdout"
        - mok_key.stat.exists
        - "'is not enrolled' in mok_enrolled.stdout | default('')"
      register: mok_import

    - name: Display MOK enrollment password
      ansible.builtin.pause:
        prompt: |2

          ========================================================================
          IMPORTANT: SECURE BOOT MOK ENROLLMENT REQUIRED
          ========================================================================

          Your MOK enrollment password is: {{ mok_password }}

          MEMORIZE THIS PASSWORD NOW!

          After reboot:
          1. You will see a blue MOK Manager screen
          2. Select "Enroll MOK"
          3. Select "Continue"
          4. Select "Yes"
          5. Enter the password shown above: {{ mok_password }}
          6. Select "Reboot"

          The password will ONLY be needed this one time during enrollment.

          Press ENTER only after you have memorized the password...
          ========================================================================
      when:
        - "'SecureBoot enabled' in secure_boot_state.stdout"
        - mok_import is changed

    - name: Run DKMS autoinstall
      ansible.builtin.command: dkms autoinstall
      when:
        - "'SecureBoot enabled' in secure_boot_state.stdout"
        - "'is already enrolled' in mok_enrolled.stdout | default('')"

    # Configure suspend/resume handling for DisplayLink
    # This prevents display configuration getting stuck after suspend/resume cycles
    # The service restarts cause GNOME to lose monitor layout because EVDI recreates
    # virtual DRM devices with new IDs, breaking ~/.config/monitors.xml references
    # Alternative approaches:
    # 1. Save/restore monitor config: gdbus call to Mutter DisplayConfig
    # 2. USB power management: disable autosuspend for DisplayLink devices
    # 3. EVDI persistence: options evdi initial_device_count=N in modprobe.d
    - name: Create DisplayLink suspend/resume check script
      ansible.builtin.copy:
        content: |
          #!/bin/bash
          # Check if DisplayLink needs recovery after suspend

          # Wait for system to stabilize
          sleep 5

          # Check if DisplayLink USB device exists
          if ! lsusb | grep -qi displaylink; then
              echo "No DisplayLink device connected"
              exit 0
          fi

          # Check if EVDI module is loaded
          if ! lsmod | grep -q evdi; then
              echo "EVDI module not loaded - restarting service"
              systemctl restart displaylink-driver.service
              exit 0
          fi

          # Check if DisplayLinkManager process is running
          if ! pgrep -f DisplayLinkManager > /dev/null; then
              echo "DisplayLinkManager not running - restarting service"
              systemctl restart displaylink-driver.service
              exit 0
          fi

          # Check for EVDI errors in kernel log (last 10 seconds)
          if journalctl -k --since "10 seconds ago" | grep -q "evdi.*error\|evdi.*fail"; then
              echo "EVDI errors detected - restarting service"
              systemctl restart displaylink-driver.service
              exit 0
          fi

          # Check if any connected DisplayLink monitor lost its display output
          # This checks if EVDI cards exist but aren't properly connected
          for card in /sys/class/drm/card*/status; do
              if [[ -e "$card" ]] && grep -q "evdi" "${card%/status}/device/driver" 2>/dev/null; then
                  status=$(cat "$card")
                  if [[ "$status" != "connected" ]]; then
                      echo "EVDI card disconnected - restarting service"
                      systemctl restart displaylink-driver.service
                      exit 0
                  fi
              fi
          done

          echo "DisplayLink appears healthy - no restart needed"
        dest: /usr/local/bin/displaylink-resume-check.sh
        mode: "0755"

    - name: Create DisplayLink suspend/resume service
      ansible.builtin.copy:
        content: |
          [Unit]
          Description=DisplayLink Suspend/Resume Handler
          After=suspend.target hibernate.target hybrid-sleep.target suspend-then-hibernate.target

          [Service]
          Type=oneshot
          # Only restart DisplayLink if there are actual issues detected
          ExecStart=/usr/local/bin/displaylink-resume-check.sh

          [Install]
          WantedBy=suspend.target hibernate.target hybrid-sleep.target suspend-then-hibernate.target
        dest: /etc/systemd/system/displaylink-suspend.service
        mode: "0644"
      register: suspend_service

    - name: Enable DisplayLink suspend service
      ansible.builtin.systemd:
        name: displaylink-suspend.service
        enabled: true
        daemon_reload: "{{ suspend_service.changed }}"

    - name: Ensure DisplayLink service is started
      ansible.builtin.systemd:
        name: displaylink-driver
        state: started
        enabled: true
      when: "'is already enrolled' in mok_enrolled.stdout | default('') or 'SecureBoot disabled' in secure_boot_state.stdout"

    - name: Verify DisplayLink installation
      ansible.builtin.command: "{{ root_dir }}/scripts/check-displaylink-status.sh --check"
      register: displaylink_check
      failed_when: displaylink_check.rc != 0
      changed_when: false
      when: "'SecureBoot disabled' in secure_boot_state.stdout or 'is already enrolled' in mok_enrolled.stdout | default('')"

    - name: Final instructions
      ansible.builtin.pause:
        prompt: |2

          ========================================================================
          DisplayLink Installation Status
          ========================================================================

          {% if 'SecureBoot enabled' in secure_boot_state.stdout and mok_import is changed %}
          ACTION REQUIRED: MOK ENROLLMENT

          1. Reboot your system now
          2. Enroll the MOK key using the password you memorized
          3. After successful enrollment, DisplayLink will work automatically

          To reboot now, run: sudo reboot
          {% elif 'SecureBoot enabled' in secure_boot_state.stdout and 'is already enrolled' in mok_enrolled.stdout | default('') %}
          ✅ MOK key is already enrolled. DisplayLink is configured and verified.
          {% else %}
          ✅ Secure Boot is disabled. DisplayLink is configured and verified.
          {% endif %}

          Press ENTER to continue...
          ========================================================================
