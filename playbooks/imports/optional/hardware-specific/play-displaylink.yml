#!/usr/bin/env ansible-playbook
# DisplayLink is used by USB Docks for Extra Monitors
# Handles Secure Boot by enrolling MOK key for kernel module signing
- hosts: desktop
  become: true
  vars:
    root_dir: "{{ inventory_dir }}/../../"
  tasks:
    - name: Check if Secure Boot is enabled
      shell: mokutil --sb-state
      register: secure_boot_state
      changed_when: false
      failed_when: false

    - name: Validate MOK password is in vault
      assert:
        that:
          - mok_password is defined
        fail_msg: |
          ERROR: MOK password not found in vault!
          
          Please add 'mok_password' to your vault configuration:
          ansible-vault edit environment/localhost/host_vars/localhost.yml
          
          Add: mok_password: "your-password"
          
          This password will be used once during boot to enroll the MOK key.
      when: "'SecureBoot enabled' in secure_boot_state.stdout"

    - name: Install prerequisites for DisplayLink
      package:
        name:
          - mokutil
          - dkms
          - kernel-devel
          - kernel-headers
          - expect
        state: present

    - name: Install DisplayLink RPM
      dnf:
        name: "https://github.com/displaylink-rpm/displaylink-rpm/releases/download/v6.1.1-1/fedora-42-displaylink-1.14.10-1.github_evdi.x86_64.rpm"
        disable_gpg_check: true
      register: displaylink_install

    - name: Check if DKMS MOK key exists
      stat:
        path: /var/lib/dkms/mok.pub
      register: mok_key

    - name: Check if MOK is already enrolled
      shell: mokutil --test-key /var/lib/dkms/mok.pub
      register: mok_enrolled
      changed_when: false
      failed_when: false
      when: 
        - "'SecureBoot enabled' in secure_boot_state.stdout"
        - mok_key.stat.exists

    - name: Import MOK key for enrollment
      shell: |
        expect -c "
        spawn mokutil --import /var/lib/dkms/mok.pub
        expect \"input password:\"
        send \"{{ mok_password }}\r\"
        expect \"input password again:\"
        send \"{{ mok_password }}\r\"
        expect eof
        "
      when:
        - "'SecureBoot enabled' in secure_boot_state.stdout"
        - mok_key.stat.exists
        - "'is not enrolled' in mok_enrolled.stdout | default('')"
      register: mok_import

    - name: Display MOK enrollment password
      pause:
        prompt: |
          
          ========================================================================
          IMPORTANT: SECURE BOOT MOK ENROLLMENT REQUIRED
          ========================================================================
          
          Your MOK enrollment password is: {{ mok_password }}
          
          MEMORIZE THIS PASSWORD NOW!
          
          After reboot:
          1. You will see a blue MOK Manager screen
          2. Select "Enroll MOK"
          3. Select "Continue"
          4. Select "Yes"
          5. Enter the password shown above: {{ mok_password }}
          6. Select "Reboot"
          
          The password will ONLY be needed this one time during enrollment.
          
          Press ENTER only after you have memorized the password...
          ========================================================================
      when:
        - "'SecureBoot enabled' in secure_boot_state.stdout"
        - mok_import is changed

    - name: Run DKMS autoinstall
      command: dkms autoinstall
      when:
        - "'SecureBoot enabled' in secure_boot_state.stdout"
        - "'is already enrolled' in mok_enrolled.stdout | default('')"

    # Configure suspend/resume handling for DisplayLink
    # This prevents display configuration getting stuck after suspend/resume cycles
    # The service restarts cause GNOME to lose monitor layout because EVDI recreates
    # virtual DRM devices with new IDs, breaking ~/.config/monitors.xml references
    # Alternative approaches:
    # 1. Save/restore monitor config: gdbus call to Mutter DisplayConfig
    # 2. USB power management: disable autosuspend for DisplayLink devices
    # 3. EVDI persistence: options evdi initial_device_count=N in modprobe.d
    - name: Create DisplayLink suspend/resume check script
      copy:
        content: |
          #!/bin/bash
          # Check if DisplayLink needs recovery after suspend
          
          # Wait for system to stabilize
          sleep 5
          
          # Check if DisplayLink USB device exists
          if ! lsusb | grep -qi displaylink; then
              echo "No DisplayLink device connected"
              exit 0
          fi
          
          # Check if EVDI module is loaded
          if ! lsmod | grep -q evdi; then
              echo "EVDI module not loaded - restarting service"
              systemctl restart displaylink-driver.service
              exit 0
          fi
          
          # Check if DisplayLinkManager process is running
          if ! pgrep -f DisplayLinkManager > /dev/null; then
              echo "DisplayLinkManager not running - restarting service"
              systemctl restart displaylink-driver.service
              exit 0
          fi
          
          # Check for EVDI errors in kernel log (last 10 seconds)
          if journalctl -k --since "10 seconds ago" | grep -q "evdi.*error\|evdi.*fail"; then
              echo "EVDI errors detected - restarting service"
              systemctl restart displaylink-driver.service
              exit 0
          fi
          
          # Check if any connected DisplayLink monitor lost its display output
          # This checks if EVDI cards exist but aren't properly connected
          for card in /sys/class/drm/card*/status; do
              if [[ -e "$card" ]] && grep -q "evdi" "${card%/status}/device/driver" 2>/dev/null; then
                  status=$(cat "$card")
                  if [[ "$status" != "connected" ]]; then
                      echo "EVDI card disconnected - restarting service"
                      systemctl restart displaylink-driver.service
                      exit 0
                  fi
              fi
          done
          
          echo "DisplayLink appears healthy - no restart needed"
        dest: /usr/local/bin/displaylink-resume-check.sh
        mode: '0755'

    - name: Create DisplayLink suspend/resume service
      copy:
        content: |
          [Unit]
          Description=DisplayLink Suspend/Resume Handler
          After=suspend.target hibernate.target hybrid-sleep.target suspend-then-hibernate.target

          [Service]
          Type=oneshot
          # Only restart DisplayLink if there are actual issues detected
          ExecStart=/usr/local/bin/displaylink-resume-check.sh
          
          [Install]
          WantedBy=suspend.target hibernate.target hybrid-sleep.target suspend-then-hibernate.target
        dest: /etc/systemd/system/displaylink-suspend.service
        mode: '0644'
      register: suspend_service

    - name: Enable DisplayLink suspend service
      systemd:
        name: displaylink-suspend.service
        enabled: yes
        daemon_reload: "{{ suspend_service.changed }}"

    - name: Ensure DisplayLink service is started
      systemd:
        name: displaylink-driver
        state: started
        enabled: yes
      when: "'is already enrolled' in mok_enrolled.stdout | default('') or 'SecureBoot disabled' in secure_boot_state.stdout"

    - name: Verify DisplayLink installation
      command: "{{ root_dir }}/scripts/check-displaylink-status.sh --check"
      register: displaylink_check
      failed_when: displaylink_check.rc != 0
      changed_when: false
      when: "'SecureBoot disabled' in secure_boot_state.stdout or 'is already enrolled' in mok_enrolled.stdout | default('')"

    - name: Final instructions
      pause:
        prompt: |
          
          ========================================================================
          DisplayLink Installation Status
          ========================================================================
          
          {% if 'SecureBoot enabled' in secure_boot_state.stdout and mok_import is changed %}
          ACTION REQUIRED: MOK ENROLLMENT
          
          1. Reboot your system now
          2. Enroll the MOK key using the password you memorized
          3. After successful enrollment, DisplayLink will work automatically
          
          To reboot now, run: sudo reboot
          {% elif 'SecureBoot enabled' in secure_boot_state.stdout and 'is already enrolled' in mok_enrolled.stdout | default('') %}
          ✅ MOK key is already enrolled. DisplayLink is configured and verified.
          {% else %}
          ✅ Secure Boot is disabled. DisplayLink is configured and verified.
          {% endif %}
          
          Press ENTER to continue...
          ========================================================================
