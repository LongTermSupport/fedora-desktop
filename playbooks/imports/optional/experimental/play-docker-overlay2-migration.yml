---
#!/usr/bin/env ansible-playbook
# Docker Storage Driver Migration: fuse-overlayfs -> native overlay2
#
# ⚠️  DISABLED - DO NOT USE ⚠️
#
# This playbook is DISABLED because Docker explicitly does not support
# rootless + overlay2 + SELinux. The combination was intentionally blocked
# in Docker/Moby PR #42462.
#
# See: https://github.com/LongTermSupport/fedora-desktop/issues/8
#
# Alternatives:
#   1. Use Podman instead (supports native overlay2 + SELinux in rootless mode)
#   2. Keep using fuse-overlayfs (works but has CPU overhead)
#   3. Disable SELinux (not recommended)
#
# Original description:
# This playbook migrates rootless Docker from fuse-overlayfs to native overlay2.
# Native overlay2 has significantly lower CPU overhead.
#
# Prerequisites:
#   - Kernel 5.13+ (for SELinux compatibility)
#   - overlay kernel module loaded
#   - Rootless Docker already configured
#
# WARNING: This will delete all existing Docker data (images, containers, volumes)
# The user will be prompted for confirmation before any destructive action.
#
- hosts: desktop
  name: Migrate Docker to Native overlay2
  become: false
  vars:
    root_dir: "{{ inventory_dir }}/../../"
    min_kernel_version: "5.13.0"
    user_home: "/home/{{ user_login }}"
    docker_root: "/home/{{ user_login }}/.local/share/docker"
    docker_config_dir: "/home/{{ user_login }}/.config/docker"
  tasks:

    # ═══════════════════════════════════════════════════════════════════════
    # DISABLED - PLAYBOOK CANNOT BE RUN
    # ═══════════════════════════════════════════════════════════════════════

    - name: STOP - This Playbook is Disabled
      ansible.builtin.fail:
        msg: |
          ════════════════════════════════════════════════════════════════════════════════
          ⚠️  THIS PLAYBOOK IS DISABLED ⚠️
          ════════════════════════════════════════════════════════════════════════════════

          Docker explicitly does not support rootless + overlay2 + SELinux.
          This combination was intentionally blocked in Docker/Moby PR #42462.

          The error you would see is:
            "overlay is not supported for Rootless with SELinux"

          Alternatives:
            1. Use Podman instead (supports native overlay2 + SELinux in rootless)
            2. Keep using fuse-overlayfs (works but has ~2x CPU overhead on I/O)
            3. Disable SELinux entirely (not recommended)

          For more information, see:
            - https://github.com/moby/moby/issues/42333
            - https://github.com/moby/moby/pull/42462

          ════════════════════════════════════════════════════════════════════════════════

    # ═══════════════════════════════════════════════════════════════════════
    # SANITY CHECKS (disabled - unreachable)
    # ═══════════════════════════════════════════════════════════════════════

    - name: Get Kernel Version
      ansible.builtin.command: uname -r
      register: kernel_version_raw
      changed_when: false

    - name: Parse Kernel Version
      ansible.builtin.set_fact:
        kernel_version: "{{ kernel_version_raw.stdout.split('-')[0] }}"

    - name: Check Kernel Version Meets Minimum
      ansible.builtin.assert:
        that:
          - kernel_version is version(min_kernel_version, '>=')
        fail_msg: |
          Kernel {{ kernel_version }} does not support native overlay2 for rootless Docker with SELinux.
          Required: {{ min_kernel_version }} or later.

          You can continue using fuse-overlayfs, or upgrade your kernel.
        success_msg: "Kernel {{ kernel_version }} supports native overlay2"

    - name: Check overlay Module is Loaded
      ansible.builtin.command: grep -q "^overlay " /proc/modules
      register: overlay_module_check
      changed_when: false
      failed_when: false

    - name: Load overlay Module if Not Loaded
      become: true
      community.general.modprobe:
        name: overlay
        state: present
      when: overlay_module_check.rc != 0

    - name: Verify overlay Module is Now Loaded
      ansible.builtin.command: grep -q "^overlay " /proc/modules
      changed_when: false

    # NOTE: Using command instead of systemd module because scope: user
    # doesn't work reliably in all Ansible execution contexts
    - name: Check if Rootless Docker is Running  # noqa: command-instead-of-module
      ansible.builtin.command: systemctl --user is-active docker.socket
      register: docker_socket_status
      failed_when: false
      changed_when: false

    - name: Try to Start Rootless Docker  # noqa: command-instead-of-module
      ansible.builtin.command: systemctl --user start docker.socket
      register: docker_start_result
      changed_when: docker_start_result.rc == 0
      failed_when: false
      when: docker_socket_status.rc != 0

    - name: Brief Pause for Docker Startup  # noqa: no-handler
      ansible.builtin.pause:
        seconds: 2
      when:
        - docker_start_result is defined
        - docker_start_result.rc is defined
        - docker_start_result.rc == 0

    - name: Check Current Docker Storage Driver
      ansible.builtin.command: docker info --format '{{ '{{' }}.Driver{{ '}}' }}'
      register: current_driver
      changed_when: false
      failed_when: false

    - name: Handle Docker Not Running (Fresh Install or Reset)
      ansible.builtin.set_fact:
        current_driver:
          stdout: "not_running"
      when: current_driver.rc is defined and current_driver.rc != 0

    - name: Display Current Driver
      ansible.builtin.debug:
        msg: "Current Docker storage driver: {{ current_driver.stdout }}"

    - name: Skip If Already Using overlay2
      ansible.builtin.meta: end_play
      when: current_driver.stdout == "overlay2"

    # ═══════════════════════════════════════════════════════════════════════
    # DATA ASSESSMENT (only if Docker is running)
    # ═══════════════════════════════════════════════════════════════════════

    - name: Check for Existing Docker Images
      ansible.builtin.command: docker images -q
      register: existing_images
      changed_when: false
      failed_when: false
      when: current_driver.stdout != "not_running"

    - name: Count Docker Images
      ansible.builtin.set_fact:
        image_count: "{{ existing_images.stdout_lines | default([]) | length }}"

    - name: Check for Existing Docker Containers
      ansible.builtin.command: docker ps -aq
      register: existing_containers
      changed_when: false
      failed_when: false
      when: current_driver.stdout != "not_running"

    - name: Count Docker Containers
      ansible.builtin.set_fact:
        container_count: "{{ existing_containers.stdout_lines | default([]) | length }}"

    - name: Check if Docker Data Directory Exists
      ansible.builtin.stat:
        path: "{{ docker_root }}"
      register: docker_root_stat

    - name: Get Docker Data Size
      become: true
      ansible.builtin.command: du -sh {{ docker_root }}
      register: docker_data_size
      changed_when: false
      when: docker_root_stat.stat.exists

    - name: Set Data Size to Zero if Directory Missing
      ansible.builtin.set_fact:
        docker_data_size:
          stdout: "0 (no data directory)"
      when: not docker_root_stat.stat.exists

    - name: Skip Migration if No Data and Not Running
      ansible.builtin.debug:
        msg: |
          No Docker data directory found and Docker is not running.
          Nothing to migrate - just configure overlay2 for fresh start.
      when:
        - not docker_root_stat.stat.exists
        - current_driver.stdout == "not_running"

    - name: Display Migration Warning
      ansible.builtin.pause:
        prompt: |

          ════════════════════════════════════════════════════════════════════════════════
          ⚠️  DOCKER STORAGE MIGRATION: fuse-overlayfs -> overlay2
          ════════════════════════════════════════════════════════════════════════════════

          Current driver:  {{ current_driver.stdout }}
          Target driver:   overlay2

          Existing data that will be DELETED:
            • Images:     {{ image_count }}
            • Containers: {{ container_count }} (including stopped)
            • Data size:  {{ docker_data_size.stdout | default('unknown') }}

          Benefits of native overlay2:
            • Significantly lower CPU usage (no FUSE userspace overhead)
            • Faster container startup and I/O
            • Better performance for heavy workloads

          After migration, you will need to:
            • Rebuild CCY containers: ccy --rebuild
            • Pull any Docker Hub images again

          ════════════════════════════════════════════════════════════════════════════════

          Type 'MIGRATE' to proceed, or press Ctrl+C to cancel
      register: user_confirmation
      when: (image_count | int > 0) or (container_count | int > 0) or docker_root_stat.stat.exists

    - name: Verify User Confirmation
      ansible.builtin.fail:
        msg: "Migration cancelled by user"
      when:
        - user_confirmation is defined
        - user_confirmation.user_input is defined
        - user_confirmation.user_input != 'MIGRATE'

    # ═══════════════════════════════════════════════════════════════════════
    # MIGRATION
    # ═══════════════════════════════════════════════════════════════════════

    - name: Stop Running Containers
      ansible.builtin.shell: docker stop $(docker ps -q) 2>/dev/null || true
      when: container_count | int > 0
      changed_when: true

    - name: Stop Rootless Docker Service  # noqa: command-instead-of-module
      ansible.builtin.command: systemctl --user stop docker.service
      failed_when: false
      changed_when: true

    - name: Stop Rootless Docker Socket  # noqa: command-instead-of-module
      ansible.builtin.command: systemctl --user stop docker.socket
      failed_when: false
      changed_when: true

    - name: Wait for Docker to Stop
      ansible.builtin.pause:
        seconds: 3

    - name: Remove Docker Data Directory
      become: true
      ansible.builtin.file:
        path: "{{ docker_root }}"
        state: absent

    - name: Ensure Docker Config Directory Exists
      ansible.builtin.file:
        path: "{{ docker_config_dir }}"
        state: directory
        mode: '0700'

    - name: Configure overlay2 Storage Driver
      ansible.builtin.copy:
        dest: "{{ docker_config_dir }}/daemon.json"
        content: |
          {
            "storage-driver": "overlay2"
          }
        mode: '0600'

    - name: Start Rootless Docker Socket  # noqa: command-instead-of-module
      ansible.builtin.command: systemctl --user start docker.socket
      register: start_socket_result
      changed_when: start_socket_result.rc == 0
      failed_when: false

    - name: Start Rootless Docker Service  # noqa: command-instead-of-module
      ansible.builtin.command: systemctl --user start docker.service
      register: start_service_result
      changed_when: start_service_result.rc == 0
      failed_when: false

    - name: Warn if Docker Failed to Start
      ansible.builtin.debug:
        msg: |
          WARNING: Docker failed to start. Unit files may be missing.
          Run the Docker playbook to restore: ansible-playbook playbooks/imports/optional/common/play-docker.yml
      when: start_socket_result.rc != 0 or start_service_result.rc != 0

    - name: Wait for Docker Service to Initialize
      ansible.builtin.pause:
        seconds: 3

    # ═══════════════════════════════════════════════════════════════════════
    # VERIFICATION
    # ═══════════════════════════════════════════════════════════════════════

    - name: Verify New Storage Driver
      ansible.builtin.command: docker info --format '{{ '{{' }}.Driver{{ '}}' }}'
      register: new_driver
      changed_when: false

    - name: Display Migration Result
      ansible.builtin.debug:
        msg: |
          ════════════════════════════════════════════════════════════════════════════════
          ✅ MIGRATION COMPLETE
          ════════════════════════════════════════════════════════════════════════════════

          Previous driver: {{ current_driver.stdout }}
          Current driver:  {{ new_driver.stdout }}

          Next steps:
            1. Rebuild CCY container: ccy --rebuild
            2. Pull any other images you need

          ════════════════════════════════════════════════════════════════════════════════

    - name: Fail If Migration Did Not Work
      ansible.builtin.fail:
        msg: |
          Migration failed! Expected overlay2 but got {{ new_driver.stdout }}

          Try manually:
            1. systemctl --user stop docker.service docker.socket
            2. rm -rf ~/.local/share/docker
            3. cat > ~/.config/docker/daemon.json << 'EOF'
               {"storage-driver": "overlay2"}
               EOF
            4. systemctl --user start docker.socket docker.service
            5. docker info | grep 'Storage Driver'
      when: new_driver.stdout != "overlay2"
