#!/usr/bin/env ansible-playbook
---
- hosts: desktop
  name: Claude DevTools (ccdt) - On-Demand Session Viewer Installation
  become: false
  vars:
    root_dir: "{{ inventory_dir }}/../../"
    ccdt_repo: "https://github.com/matt1398/claude-devtools"
    ccdt_src_dir: "/opt/claude-devtools"
    ccdt_image: "claude-devtools"
  vars_files:
    - "{{ inventory_dir }}/../../vars/container-defaults.yml"
  tasks:
    - name: Check if Container Engine is Installed
      ansible.builtin.command: which {{ container_engine }}
      register: container_engine_check
      failed_when: false
      changed_when: false

    - name: Verify Container Engine is Available
      ansible.builtin.fail:
        msg: |
          {{ container_engine }} is not installed or not in PATH.
          Please install {{ container_engine }} first.
          Run: ansible-playbook playbooks/imports/play-podman.yml
      when: container_engine_check.rc != 0

    - name: Check Container Engine Service is Accessible
      ansible.builtin.command: "{{ container_engine }} ps"
      register: container_service_check
      failed_when: false
      changed_when: false

    - name: Verify Container Engine Service
      ansible.builtin.fail:
        msg: |
          {{ container_engine }} is not accessible.
          Check: podman info
      when: container_service_check.rc != 0

    - name: Create claude-devtools Source Directory
      become: true
      ansible.builtin.file:
        path: "{{ ccdt_src_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Clone claude-devtools Repository
      become: true
      ansible.builtin.git:
        repo: "{{ ccdt_repo }}"
        dest: "{{ ccdt_src_dir }}"
        update: true
        force: false
      register: git_clone

    - name: Build claude-devtools Container Image
      ansible.builtin.command: >
        {{ container_engine }} build -t {{ ccdt_image }}:latest {{ ccdt_src_dir }}
      register: image_build
      changed_when: git_clone.changed or image_build.rc == 0

    - name: Ensure ~/.local/bin Directory Exists
      ansible.builtin.file:
        path: "/home/{{ user_login }}/.local/bin"
        state: directory
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: "0755"

    - name: Deploy ccdt Script
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/home/.local/bin/ccdt"
        dest: "/home/{{ user_login }}/.local/bin/ccdt"
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: "0755"

    - name: Deploy Bashrc Include for ccdt Alias
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/home/bashrc-includes/claude-devtools.bash"
        dest: "/home/{{ user_login }}/.bashrc-includes/claude-devtools.bash"
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: "0644"

    - name: Display Installation Summary
      ansible.builtin.debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "Claude DevTools (ccdt) Installation Complete"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "âœ… Image built: claude-devtools:latest (from github.com/matt1398/claude-devtools)"
          - "âœ… Script installed: ~/.local/bin/ccdt"
          - "âœ… Shell alias:      ccdt"
          - ""
          - "ğŸš€ Quick Start"
          - ""
          - "  Reload shell:"
          - "    source ~/.bashrc"
          - ""
          - "  View host Claude Code sessions:"
          - "    ccdt"
          - ""
          - "  View CCY project sessions (from project dir):"
          - "    cd ~/Projects/my-project"
          - "    ccdt"
          - ""
          - "  Force host sessions:"
          - "    ccdt --host"
          - ""
          - "  Explicit path:"
          - "    ccdt ~/Projects/my-project"
          - ""
          - "ğŸ“º Opens at: http://localhost:3456"
          - ""
          - "ğŸ’¡ Help:"
          - "    ccdt --help"
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
