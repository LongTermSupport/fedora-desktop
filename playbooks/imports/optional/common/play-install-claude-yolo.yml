---
#!/usr/bin/env ansible-playbook
- hosts: desktop
  name: Claude Code YOLO/Browser Mode - Container-based Installation
  become: false
  vars:
    root_dir: "{{ inventory_dir }}/../../"
    install_browser_mode: true # Set to false to skip browser mode installation
  tasks:
    - name: Check if Docker is Installed
      ansible.builtin.command: which docker
      register: docker_check
      failed_when: false
      changed_when: false

    - name: Verify Docker is Available
      ansible.builtin.fail:
        msg: |
          Docker is not installed or not in PATH.
          Please run the Docker installation playbook first:
            ansible-playbook playbooks/imports/optional/common/play-docker.yml
      when: docker_check.rc != 0

    - name: Check Docker Service is Running
      ansible.builtin.command: docker ps
      register: docker_service_check
      failed_when: false
      changed_when: false

    - name: Verify Docker Service
      ansible.builtin.fail:
        msg: |
          Docker service is not running.
          Please start Docker:
            systemctl --user start docker
      when: docker_service_check.rc != 0

    - name: Create Claude YOLO Base Directory
      become: true
      ansible.builtin.file:
        path: /opt/claude-yolo
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Create Custom Dockerfiles Directory
      become: true
      ansible.builtin.file:
        path: /opt/claude-yolo/custom-dockerfiles
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Copy Dockerfile
      become: true
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/var/local/claude-yolo/Dockerfile"
        dest: /opt/claude-yolo/Dockerfile
        owner: root
        group: root
        mode: "0644"
      tags:
        - scripts
        - dockerfile

    - name: Copy Entrypoint Script
      become: true
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/var/local/claude-yolo/entrypoint.sh"
        dest: /opt/claude-yolo/entrypoint.sh
        owner: root
        group: root
        mode: "0755"
      tags:
        - scripts
        - entrypoint

    - name: Copy CCY Startup Info File
      become: true
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/opt/claude-yolo/ccy-startup-info.txt"
        dest: /opt/claude-yolo/ccy-startup-info.txt
        owner: root
        group: root
        mode: "0644"
      tags:
        - scripts

    - name: Copy Custom Dockerfile Templates (Never Overwrite User Changes)
      become: true
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: "/opt/claude-yolo/custom-dockerfiles/{{ item | basename }}"
        owner: root
        group: root
        mode: "0644"
        force: false # NEVER overwrite - users can customize these
      loop:
        - "{{ root_dir }}/files/var/local/claude-yolo/Dockerfile.project-template"
        - "{{ root_dir }}/files/var/local/claude-yolo/Dockerfile.example-ansible"
        - "{{ root_dir }}/files/var/local/claude-yolo/Dockerfile.example-golang"
      tags:
        - scripts
        - templates

    # Shared library for DRY helpers (used by ccy and ccy-browser)
    - name: Create Shared Library Directory
      become: true
      ansible.builtin.file:
        path: /var/local/claude-yolo/lib
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Install Shared Helper Libraries
      become: true
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: "/var/local/claude-yolo/lib/{{ item | basename }}"
        owner: root
        group: root
        mode: "0755"
      loop:
        - "{{ root_dir }}/files/var/local/claude-yolo/lib/common.bash"
        - "{{ root_dir }}/files/var/local/claude-yolo/lib/ui-helpers.bash"
        - "{{ root_dir }}/files/var/local/claude-yolo/lib/ssh-handling.bash"
        - "{{ root_dir }}/files/var/local/claude-yolo/lib/token-management.bash"
        - "{{ root_dir }}/files/var/local/claude-yolo/lib/network-management.bash"
        - "{{ root_dir }}/files/var/local/claude-yolo/lib/dockerfile-custom.bash"
        - "{{ root_dir }}/files/var/local/claude-yolo/lib/session-management.bash"
        - "{{ root_dir }}/files/var/local/claude-yolo/lib/docker-health.bash"
      tags:
        - scripts
        - library

    # Remove old symlinks (cleanup from previous versions)
    - name: Remove Old Symlink in /usr/local/bin
      become: true
      ansible.builtin.file:
        path: /usr/local/bin/claude-yolo
        state: absent
      tags:
        - scripts
        - cleanup

    - name: Copy Wrapper Script to /var/local/
      become: true
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/var/local/claude-yolo/claude-yolo"
        dest: /var/local/claude-yolo/claude-yolo
        owner: root
        group: root
        mode: "0755"
      tags:
        - scripts
        - wrapper

    - name: Deploy Bashrc Include for Root
      become: true
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/home/bashrc-includes/claude-yolo.bash"
        dest: /root/.bashrc-includes/claude-yolo.bash
        owner: root
        group: root
        mode: "0644"

    - name: Deploy Bashrc Include for User
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/home/bashrc-includes/claude-yolo.bash"
        dest: /home/{{ user_login }}/.bashrc-includes/claude-yolo.bash
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: "0644"

    - name: Create Claude YOLO Root Directory
      ansible.builtin.file:
        path: /home/{{ user_login }}/.claude-tokens/ccy
        state: directory
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: "0700"

    - name: Create Claude YOLO Tokens Directory
      ansible.builtin.file:
        path: /home/{{ user_login }}/.claude-tokens/ccy/tokens
        state: directory
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: "0700"

    - name: Create Claude YOLO Projects Directory
      ansible.builtin.file:
        path: /home/{{ user_login }}/.claude-tokens/ccy/projects
        state: directory
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: "0700"

    - name: Calculate Dockerfile Hash for Build
      ansible.builtin.shell: md5sum /opt/claude-yolo/Dockerfile | cut -d' ' -f1 | cut -c1-16
      register: dockerfile_hash
      changed_when: false

    - name: Build Claude YOLO Container Image with Hash
      ansible.builtin.command: >
        docker build
        --build-arg DOCKERFILE_HASH={{ dockerfile_hash.stdout }}
        -t claude-yolo:latest
        /opt/claude-yolo
      register: docker_build
      changed_when: "'Successfully built' in docker_build.stdout or 'Successfully tagged' in docker_build.stdout"

    - name: Verify Container Image
      ansible.builtin.command: docker image inspect claude-yolo:latest
      register: image_verify
      changed_when: false

    # =========================================================================
    # Browser Mode Installation (Optional - controlled by install_browser_mode)
    # =========================================================================

    - name: Create Claude Browser Base Directory
      become: true
      ansible.builtin.file:
        path: /opt/claude-browser
        state: directory
        owner: root
        group: root
        mode: "0755"
      when: install_browser_mode
      tags:
        - browser

    - name: Copy Dockerfile for Browser Container
      become: true
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/var/local/claude-yolo/Dockerfile.browser"
        dest: /opt/claude-browser/Dockerfile
        owner: root
        group: root
        mode: "0644"
      when: install_browser_mode
      tags:
        - browser
        - dockerfile

    - name: Copy Browser Entrypoint Script
      become: true
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/var/local/claude-yolo/entrypoint-browser.sh"
        dest: /opt/claude-browser/entrypoint.sh
        owner: root
        group: root
        mode: "0755"
      when: install_browser_mode
      tags:
        - browser
        - entrypoint

    - name: Create chrome-ws Directory
      become: true
      ansible.builtin.file:
        path: /opt/claude-browser/chrome-ws
        state: directory
        owner: root
        group: root
        mode: "0755"
      when: install_browser_mode
      tags:
        - browser

    - name: Copy chrome-ws CLI Tool
      become: true
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/opt/claude-browser/chrome-ws/chrome-ws"
        dest: /opt/claude-browser/chrome-ws/chrome-ws
        owner: root
        group: root
        mode: "0755"
      when: install_browser_mode
      tags:
        - browser
        - chrome-ws

    - name: Copy chrome-ws Library
      become: true
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/opt/claude-browser/chrome-ws/chrome-ws-lib.js"
        dest: /opt/claude-browser/chrome-ws/chrome-ws-lib.js
        owner: root
        group: root
        mode: "0644"
      when: install_browser_mode
      tags:
        - browser
        - chrome-ws

    - name: Create Skills Directory
      become: true
      ansible.builtin.file:
        path: /opt/claude-browser/skills/browsing
        state: directory
        owner: root
        group: root
        mode: "0755"
      when: install_browser_mode
      tags:
        - browser

    - name: Copy chrome-ws Skills Documentation
      become: true
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: /opt/claude-browser/skills/browsing/
        owner: root
        group: root
        mode: "0644"
      loop:
        - "{{ root_dir }}/files/opt/claude-browser/skills/browsing/SKILL.md"
        - "{{ root_dir }}/files/opt/claude-browser/skills/browsing/COMMANDLINE-USAGE.md"
        - "{{ root_dir }}/files/opt/claude-browser/skills/browsing/EXAMPLES.md"
      when: install_browser_mode
      tags:
        - browser
        - skills

    - name: Copy Browser Startup Info File
      become: true
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/opt/claude-browser/ccb-startup-info.txt"
        dest: /opt/claude-browser/ccb-startup-info.txt
        owner: root
        group: root
        mode: "0644"
      when: install_browser_mode
      tags:
        - browser

    - name: Copy Browser Wrapper Script
      become: true
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/var/local/claude-yolo/claude-browser"
        dest: /var/local/claude-yolo/claude-browser
        owner: root
        group: root
        mode: "0755"
      when: install_browser_mode
      tags:
        - browser
        - wrapper

    - name: Deploy Bashrc Include for ccb Alias (Root)
      become: true
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/home/bashrc-includes/claude-browser.bash"
        dest: /root/.bashrc-includes/claude-browser.bash
        owner: root
        group: root
        mode: "0644"
      when: install_browser_mode
      tags:
        - browser

    - name: Deploy Bashrc Include for ccb Alias (User)
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/home/bashrc-includes/claude-browser.bash"
        dest: /home/{{ user_login }}/.bashrc-includes/claude-browser.bash
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: "0644"
      when: install_browser_mode
      tags:
        - browser

    - name: Create CCB Root Directory
      ansible.builtin.file:
        path: /home/{{ user_login }}/.claude-tokens/ccb
        state: directory
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: "0700"
      when: install_browser_mode
      tags:
        - browser

    - name: Create CCB Projects Directory
      ansible.builtin.file:
        path: /home/{{ user_login }}/.claude-tokens/ccb/projects
        state: directory
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: "0700"
      when: install_browser_mode
      tags:
        - browser

    - name: Calculate Browser Dockerfile Hash for Build
      ansible.builtin.shell: md5sum /opt/claude-browser/Dockerfile | cut -d' ' -f1 | cut -c1-16
      register: browser_dockerfile_hash
      changed_when: false
      when: install_browser_mode
      tags:
        - browser

    - name: Build Claude Browser Container Image with Hash
      ansible.builtin.command: >
        docker build
        --build-arg DOCKERFILE_HASH={{ browser_dockerfile_hash.stdout }}
        -t claude-browser:latest
        /opt/claude-browser
      register: browser_docker_build
      changed_when: "'Successfully built' in browser_docker_build.stdout or 'Successfully tagged' in browser_docker_build.stdout"
      when: install_browser_mode
      tags:
        - browser

    - name: Verify Browser Container Image
      ansible.builtin.command: docker image inspect claude-browser:latest
      register: browser_image_verify
      changed_when: false
      when: install_browser_mode
      tags:
        - browser

    # =========================================================================
    # Unified Installation Summary
    # =========================================================================

    - name: Display Unified Installation Summary
      ansible.builtin.debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "Claude Code Containers Installation Complete"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "âœ… CCY (General YOLO Mode)"
          - "   â€¢ Container: claude-yolo:latest"
          - "   â€¢ Alias: ccy"
          - "   â€¢ Tokens: ~/.claude-tokens/ccy/"
          - ""
          - "{{ 'âœ… CCB (Browser Mode)' if install_browser_mode else 'âŠ˜ CCB (Browser Mode) - Skipped' }}"
          - "{{ '   â€¢ Container: claude-browser:latest' if install_browser_mode else '' }}"
          - "{{ '   â€¢ Alias: ccb' if install_browser_mode else '' }}"
          - "{{ '   â€¢ chrome-ws CLI + Playwright MCP' if install_browser_mode else '' }}"
          - ""
          - "ğŸš€ Quick Start"
          - ""
          - "  Reload shell:"
          - "    source ~/.bashrc"
          - ""
          - "  General development:"
          - "    cd ~/Projects/your-project"
          - "    ccy"
          - ""
          - "{{ '  Browser automation:' if install_browser_mode else '' }}"
          - "{{ '    ccb' if install_browser_mode else '' }}"
          - ""
          - "ğŸ’¡ Token Management"
          - ""
          - "  Create/manage tokens (shared between ccy and ccb):"
          - "    ccy --create-token"
          - "    ccy --list-tokens"
          - "    ccy --token personal"
          - ""
          - "  First run:"
          - "    1. cd /your/project"
          - "    2. ccy (or ccb)"
          - "    3. Follow prompts for token setup"
          - "    4. Use /login in Claude Code"
          - ""
          - "âš™ï¸  Container Extensions"
          - ""
          - "  Project-specific Dockerfiles:"
          - "    ccy --custom-docker    # AI-guided creation"
          - "    ccy --custom           # Quick edit"
          - ""
          - "  Templates: /opt/claude-yolo/custom-dockerfiles/"
          - "    â€¢ Dockerfile.project-template"
          - "    â€¢ Dockerfile.example-ansible"
          - "    â€¢ Dockerfile.example-golang"
          - ""
          - "ğŸ“š More Info"
          - ""
          - "  ccy --help    # Show ccy options"
          - "{{ '  ccb --help    # Show ccb options' if install_browser_mode else '' }}"
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
