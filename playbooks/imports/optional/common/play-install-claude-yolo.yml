#!/usr/bin/env ansible-playbook
---
#!/usr/bin/env ansible-playbook
- hosts: desktop
  name: Claude Code YOLO/Browser Mode - Container-based Installation
  become: false
  vars:
    root_dir: "{{ inventory_dir }}/../../"
  vars_files:
    - "{{ inventory_dir }}/../../vars/container-defaults.yml"
  tasks:
    - name: Check if Container Engine is Installed
      ansible.builtin.command: which {{ container_engine }}
      register: container_engine_check
      failed_when: false
      changed_when: false

    - name: Verify Container Engine is Available
      ansible.builtin.fail:
        msg: |
          {{ container_engine }} is not installed or not in PATH.
          Please install {{ container_engine }} first.
          {% if container_engine == 'docker' %}
          Run: ansible-playbook playbooks/imports/optional/common/play-docker.yml
          {% else %}
          Run: ansible-playbook playbooks/imports/play-podman.yml
          {% endif %}
      when: container_engine_check.rc != 0

    - name: Check for podman-compose (Podman only)
      ansible.builtin.command: which podman-compose
      register: podman_compose_check
      failed_when: false
      changed_when: false
      when: container_engine == 'podman'

    - name: Verify podman-compose is Available (Podman only)
      ansible.builtin.fail:
        msg: |
          podman-compose is not installed.
          This is required for Docker Compose compatibility with Podman.

          Install it with:
          ansible-playbook playbooks/imports/play-podman.yml
      when:
        - container_engine == 'podman'
        - podman_compose_check.rc != 0

    - name: Check Container Engine Service is Running
      ansible.builtin.command: "{{ container_engine }} ps"
      register: container_service_check
      failed_when: false
      changed_when: false

    - name: Verify Container Engine Service
      ansible.builtin.fail:
        msg: |
          {{ container_engine }} service is not running or not accessible.
          {% if container_engine == 'docker' %}
          Please start Docker: systemctl --user start docker
          {% else %}
          Podman should work without a daemon. Check: podman info
          {% endif %}
      when: container_service_check.rc != 0

    - name: Create Claude YOLO Base Directory
      become: true
      ansible.builtin.file:
        path: /opt/claude-yolo
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Create Custom Dockerfiles Directory
      become: true
      ansible.builtin.file:
        path: /opt/claude-yolo/custom-dockerfiles
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Copy Dockerfile
      become: true
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/var/local/claude-yolo/Dockerfile"
        dest: /opt/claude-yolo/Dockerfile
        owner: root
        group: root
        mode: "0644"
      tags:
        - scripts
        - dockerfile

    - name: Copy Entrypoint Script
      become: true
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/var/local/claude-yolo/entrypoint.sh"
        dest: /opt/claude-yolo/entrypoint.sh
        owner: root
        group: root
        mode: "0755"
      tags:
        - scripts
        - entrypoint

    - name: Copy ctrl+z Patch Script (part of Docker build context)
      become: true
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/var/local/claude-yolo/ccy-ctrl-z-patch.js"
        dest: /opt/claude-yolo/ccy-ctrl-z-patch.js
        owner: root
        group: root
        mode: "0644"
      tags:
        - scripts
        - dockerfile

    - name: Create Documentation Directory
      become: true
      ansible.builtin.file:
        path: /opt/claude-yolo/docs
        state: directory
        owner: root
        group: root
        mode: "0755"
      tags:
        - scripts
        - docs

    - name: Copy CCY Startup Info File
      become: true
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/opt/claude-yolo/ccy-startup-info.txt"
        dest: /opt/claude-yolo/ccy-startup-info.txt
        owner: root
        group: root
        mode: "0644"
      tags:
        - scripts

    - name: Copy Documentation into Docker Build Context
      become: true
      ansible.builtin.copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: root
        group: root
        mode: "0644"
      loop:
        - src: "{{ root_dir }}/files/opt/claude-yolo/docs/CUSTOM-DOCKERFILES.txt"
          dest: /opt/claude-yolo/docs/CUSTOM-DOCKERFILES.txt
        - src: "{{ root_dir }}/files/opt/claude-yolo/docs/CCY-CCB-GUIDE.txt"
          dest: /opt/claude-yolo/docs/CCY-CCB-GUIDE.txt
      tags:
        - scripts
        - docs

    - name: Create Skills Directory in Docker Build Context
      become: true
      ansible.builtin.file:
        path: /opt/claude-yolo/skills/browsing
        state: directory
        owner: root
        group: root
        mode: "0755"
      tags:
        - scripts
        - skills

    - name: Copy Browsing Skills into Docker Build Context
      become: true
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: /opt/claude-yolo/skills/browsing/
        owner: root
        group: root
        mode: "0644"
      loop:
        - "{{ root_dir }}/files/opt/claude-yolo/skills/browsing/SKILL.md"
        - "{{ root_dir }}/files/opt/claude-yolo/skills/browsing/COMMANDLINE-USAGE.md"
        - "{{ root_dir }}/files/opt/claude-yolo/skills/browsing/EXAMPLES.md"
      tags:
        - scripts
        - skills

    - name: Copy Custom Dockerfile Templates (Never Overwrite User Changes)
      become: true
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: "/opt/claude-yolo/custom-dockerfiles/{{ item | basename }}"
        owner: root
        group: root
        mode: "0644"
        force: false # NEVER overwrite - users can customize these
      loop:
        - "{{ root_dir }}/files/var/local/claude-yolo/Dockerfile.project-template"
        - "{{ root_dir }}/files/var/local/claude-yolo/Dockerfile.example-ansible"
        - "{{ root_dir }}/files/var/local/claude-yolo/Dockerfile.example-golang"
      tags:
        - scripts
        - templates

    # Shared library for DRY helpers (used by ccy)
    - name: Create Shared Library Directory
      become: true
      ansible.builtin.file:
        path: /var/local/claude-yolo/lib
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Install Shared Helper Libraries
      become: true
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: "/var/local/claude-yolo/lib/{{ item | basename }}"
        owner: root
        group: root
        mode: "0755"
      loop:
        - "{{ root_dir }}/files/var/local/claude-yolo/lib/common.bash"
        - "{{ root_dir }}/files/var/local/claude-yolo/lib/ui-helpers.bash"
        - "{{ root_dir }}/files/var/local/claude-yolo/lib/ssh-handling.bash"
        - "{{ root_dir }}/files/var/local/claude-yolo/lib/token-management.bash"
        - "{{ root_dir }}/files/var/local/claude-yolo/lib/network-management.bash"
        - "{{ root_dir }}/files/var/local/claude-yolo/lib/dockerfile-custom.bash"
        - "{{ root_dir }}/files/var/local/claude-yolo/lib/docker-health.bash"
      tags:
        - scripts
        - library

    # Remove old symlinks (cleanup from previous versions)
    - name: Remove Old Symlink in /usr/local/bin
      become: true
      ansible.builtin.file:
        path: /usr/local/bin/claude-yolo
        state: absent
      tags:
        - scripts
        - cleanup

    - name: Copy Wrapper Script to /var/local/
      become: true
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/var/local/claude-yolo/claude-yolo"
        dest: /var/local/claude-yolo/claude-yolo
        owner: root
        group: root
        mode: "0755"
      tags:
        - scripts
        - wrapper

    - name: Deploy Bashrc Include for Root
      become: true
      ansible.builtin.template:
        src: "{{ root_dir }}/files/home/bashrc-includes/claude-yolo.bash.j2"
        dest: /root/.bashrc-includes/claude-yolo.bash
        owner: root
        group: root
        mode: "0644"

    - name: Deploy Bashrc Include for User
      ansible.builtin.template:
        src: "{{ root_dir }}/files/home/bashrc-includes/claude-yolo.bash.j2"
        dest: /home/{{ user_login }}/.bashrc-includes/claude-yolo.bash
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: "0644"

    - name: Create Claude YOLO Root Directory
      ansible.builtin.file:
        path: /home/{{ user_login }}/.claude-tokens/ccy
        state: directory
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: "0700"

    - name: Create Claude YOLO Tokens Directory
      ansible.builtin.file:
        path: /home/{{ user_login }}/.claude-tokens/ccy/tokens
        state: directory
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: "0700"

    - name: Create Claude YOLO Projects Directory
      ansible.builtin.file:
        path: /home/{{ user_login }}/.claude-tokens/ccy/projects
        state: directory
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: "0700"

    - name: Calculate Dockerfile Hash for Build
      ansible.builtin.shell: md5sum /opt/claude-yolo/Dockerfile | cut -d' ' -f1 | cut -c1-16
      register: dockerfile_hash
      changed_when: false

    - name: Build Claude YOLO Container Image with Hash
      ansible.builtin.command: >
        {{ container_engine }} build
        --build-arg DOCKERFILE_HASH={{ dockerfile_hash.stdout }}
        -t claude-yolo:latest
        /opt/claude-yolo
      register: container_build
      changed_when: "'Successfully built' in container_build.stdout or 'Successfully tagged' in container_build.stdout or container_build.rc == 0"

    - name: Verify Container Image
      ansible.builtin.command: "{{ container_engine }} image inspect claude-yolo:latest"
      register: image_verify
      changed_when: false

    # =========================================================================
    # CCB Artifact Cleanup â€” remove all remnants of the retired CCB system
    # =========================================================================

    - name: Remove claude-browser:latest Container Image
      ansible.builtin.command: "{{ container_engine }} rmi claude-browser:latest"
      register: rmi_result
      failed_when: false
      changed_when: rmi_result.rc == 0
      tags:
        - cleanup
        - browser

    - name: Remove /opt/claude-browser Build Context Directory
      become: true
      ansible.builtin.file:
        path: /opt/claude-browser
        state: absent
      tags:
        - cleanup
        - browser

    - name: Remove claude-browser Wrapper Script
      become: true
      ansible.builtin.file:
        path: /var/local/claude-yolo/claude-browser
        state: absent
      tags:
        - cleanup
        - browser

    - name: Remove ccb Bashrc Include (Root)
      become: true
      ansible.builtin.file:
        path: /root/.bashrc-includes/claude-browser.bash
        state: absent
      tags:
        - cleanup
        - browser

    - name: Remove ccb Bashrc Include (User)
      ansible.builtin.file:
        path: /home/{{ user_login }}/.bashrc-includes/claude-browser.bash
        state: absent
      tags:
        - cleanup
        - browser

    - name: Notify About CCB Token Data Preservation
      ansible.builtin.debug:
        msg:
          - "â„¹ï¸  CCB token data preserved at ~/.claude-tokens/ccb/"
          - "   Remove manually if no longer needed:"
          - "   rm -rf ~/.claude-tokens/ccb/"
      tags:
        - cleanup
        - browser

    # =========================================================================
    # claude-yolo-browser (Distrobox) Artifact Cleanup â€” retired experiment
    # =========================================================================

    - name: Remove claude-yolo-browser Wrapper Script
      become: true
      ansible.builtin.file:
        path: /var/local/claude-yolo/claude-yolo-browser
        state: absent
      tags:
        - cleanup
        - distrobox

    - name: Remove claude-yolo-browser Bashrc Include (Root)
      become: true
      ansible.builtin.file:
        path: /root/.bashrc-includes/claude-yolo-browser.bash
        state: absent
      tags:
        - cleanup
        - distrobox

    - name: Remove claude-yolo-browser Bashrc Include (User)
      ansible.builtin.file:
        path: /home/{{ user_login }}/.bashrc-includes/claude-yolo-browser.bash
        state: absent
      tags:
        - cleanup
        - distrobox

    - name: Remove playwright-tests Distrobox Container
      ansible.builtin.command: distrobox rm playwright-tests --force
      register: distrobox_rm_result
      failed_when: false
      changed_when: distrobox_rm_result.rc == 0
      tags:
        - cleanup
        - distrobox

    # =========================================================================
    # Installation Summary
    # =========================================================================

    - name: Display Installation Summary
      ansible.builtin.debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "Claude Code CCY Installation Complete"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "âœ… CCY â€” Claude Code YOLO Mode"
          - "   â€¢ Container: claude-yolo:latest"
          - "   â€¢ Alias: ccy"
          - "   â€¢ Tokens: ~/.claude-tokens/ccy/"
          - "   â€¢ Browser: agent-browser (Chromium) built in"
          - "   â€¢ Wayland display forwarding: automatic"
          - ""
          - "ğŸš€ Quick Start"
          - ""
          - "  Reload shell:"
          - "    source ~/.bashrc"
          - ""
          - "  General development:"
          - "    cd ~/Projects/your-project"
          - "    ccy"
          - ""
          - "  Browser automation (inside CCY container):"
          - "    agent-browser --help"
          - ""
          - "ğŸ’¡ Token Management"
          - ""
          - "  Create/manage tokens:"
          - "    ccy --create-token"
          - "    ccy --list-tokens"
          - "    ccy --token personal"
          - ""
          - "  First run:"
          - "    1. cd /your/project"
          - "    2. ccy"
          - "    3. Follow prompts for token setup"
          - "    4. Use /login in Claude Code"
          - ""
          - "âš™ï¸  Container Extensions"
          - ""
          - "  Project-specific Dockerfiles:"
          - "    ccy --custom-docker    # AI-guided creation"
          - "    ccy --custom           # Quick edit"
          - ""
          - "  Templates: /opt/claude-yolo/custom-dockerfiles/"
          - "    â€¢ Dockerfile.project-template"
          - "    â€¢ Dockerfile.example-ansible"
          - "    â€¢ Dockerfile.example-golang"
          - ""
          - "ğŸ“š More Info"
          - ""
          - "  ccy --help    # Show ccy options"
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
