---
#!/usr/bin/env ansible-playbook
- hosts: desktop
  name: NordVPN CLI Install and Configure
  become: true
  vars:
    root_dir: "{{ inventory_dir }}/../../"
  tasks:
    # @see https://support.nordvpn.com/hc/en-us/articles/20196094470929-Installing-NordVPN-on-Linux-distributions
    - name: Import NordVPN GPG Key
      ansible.builtin.rpm_key:
        state: present
        key: https://repo.nordvpn.com/gpg/nordvpn_public.asc

    - name: Add NordVPN Repository
      ansible.builtin.yum_repository:
        name: nordvpn
        description: NordVPN official repository
        baseurl: https://repo.nordvpn.com/yum/nordvpn/centos/$basearch
        enabled: true
        gpgcheck: false
        gpgkey: https://repo.nordvpn.com/gpg/nordvpn_public.asc

    - name: Install NordVPN Package
      ansible.builtin.dnf:
        name: nordvpn
        state: present

    - name: Add User to nordvpn Group
      ansible.builtin.user:
        name: "{{ user_login }}"
        groups: nordvpn
        append: true

    - name: Enable and Start nordvpnd Service
      ansible.builtin.systemd:
        name: nordvpnd
        state: started
        enabled: true

    - name: Install Gnome Shell Extension Installer
      ansible.builtin.shell: |
        cd /usr/bin
        wget -O gnome-shell-extension-installer "https://github.com/brunelli/gnome-shell-extension-installer/raw/1200bd8566b2fbc55f8ccc96f07394996dfc2da9/gnome-shell-extension-installer"
        chmod +x gnome-shell-extension-installer
      args:
        creates: /usr/bin/gnome-shell-extension-installer

    - name: Install NordVPN GNOME Shell Extension
      become: false
      ansible.builtin.command: gnome-shell-extension-installer --yes {{ item.id }}
      loop:
        - name: NordVPN Connect
          id: 1595
          # https://extensions.gnome.org/extension/1595/nordvpn-connect/

    - name: Display Login Instructions
      ansible.builtin.debug:
        msg:
          - "NordVPN CLI and GNOME extension installed successfully!"
          - ""
          - "IMPORTANT: You need to reboot for group membership to take effect."
          - ""
          - "After reboot:"
          - "  1. Log in to NordVPN: nordvpn login"
          - "  2. Restart GNOME Shell: Alt+F2, type 'r', press Enter"
          - "  3. The NordVPN icon will appear in your top bar"
          - ""
          - "Basic CLI commands:"
          - "  nordvpn connect              # Connect to best server"
          - "  nordvpn connect <country>    # Connect to specific country"
          - "  nordvpn disconnect           # Disconnect"
          - "  nordvpn status               # Check connection status"
          - "  nordvpn settings             # View settings"
