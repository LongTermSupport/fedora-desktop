#!/usr/bin/env ansible-playbook
- hosts: desktop
  name: Qobuz CLI Apps - Gapless HD Audio Streaming from Qobuz
  vars:
    root_dir: "{{ inventory_dir }}/../../"
    # Latest versions as of 2025-08
    # Check https://github.com/iamdb/hifi.rs/releases for updates
    hifiRsVersion: 0.3.8
    hifiRsUrl: "https://github.com/iamdb/hifi.rs/releases/download/v{{ hifiRsVersion }}/hifi-rs-x86_64-unknown-linux-gnu.tar.gz"
    hifiRsPath: "/home/{{ user_login }}/.local/bin/hifi-rs"
    # Check https://github.com/InputUsername/rescrobbled/releases for updates
    rescrobbledVersion: 0.8.0
    rescrobbledUrl: "https://github.com/InputUsername/rescrobbled/releases/download/v{{ rescrobbledVersion }}/rescrobbled"
    rescrobbledPath: "/home/{{ user_login }}/.local/bin/rescrobbled"
  tasks:
    - name: Install hifi-rs
      shell: |
        set -ex
        if [[ -f {{ hifiRsPath }} ]]; then
          installedVersion="$(hifi-rs --version | grep -Po '[0-9.]+')"
          desiredVersion="{{ hifiRsVersion }}"
          if  [[ "$installedVersion" == "$desiredVersion" ]]; then
            echo "installed version $installedVersion is the same as the desired version $desiredVersion"
            exit 0
          fi
        fi
        cd /home/{{ user_login }}/Downloads
        rm -rf hifi-rs*
        wget "{{ hifiRsUrl }}"        
        tar -xf hifi-rs-x86_64-unknown-linux-gnu.tar.gz
        mv -f hifi-rs "{{ hifiRsPath }}"
      args:
        executable: /bin/bash

    - name: Install Recsrobbled
      shell: |
        cd /home/{{ user_login }}/Downloads
        rm -rf rescrobbled*
        wget "{{ rescrobbledUrl }}"
        mv rescrobbled "{{ rescrobbledPath }}"
        chmod u+x "{{ rescrobbledPath }}"
      args:
        executable: /bin/bash
        creates: "{{ rescrobbledPath }}"

    - name: Create Rescrobbled Config Dir
      file:
        state: directory
        path: /home/{{ user_login }}/.config/rescrobbled/

    # Needs Last FM API Account
    # Visit https://www.last.fm/api/account/create
    - name: Configure Rescrobbled
      copy:
        content: |
          lastfm-key = "{{ lastfm_api_key }}"
          lastfm-secret = "{{ lastfm_api_secret }}"
        dest: /home/{{ user_login }}/.config/rescrobbled/config.toml

    - name: Create Systemd User Dir
      file:
        state: directory
        path: /home/{{ user_login }}/.config/systemd/user/

    - name: Rescrobbled Systemd Config
      copy:
        content: |
          [Unit]
          Description=An MPRIS scrobbler
          Documentation=https://github.com/InputUsername/rescrobbled
          Wants=network-online.target
          After=network-online.target
          
          [Service]
          ExecStart=%h/.local/bin/rescrobbled
          
          [Install]
          WantedBy=default.target
        dest: /home/{{ user_login }}/.config/systemd/user/rescrobbled.service

    - name: Check for Session File For Rescrobbled
      stat: 
        path: /home/{{ user_login }}/.config/rescrobbled/session
      register: rescrobbled_session_file

    - name: Manual Rescrobbled Setup Required
      block:
        - name: Display Setup Instructions
          pause:
            prompt: |
              
              ============================================
              RESCROBBLED SETUP REQUIRED
              ============================================
              
              Please do the following in a NEW terminal:
              1. Run: rescrobbled
              2. Enter your Last.fm login details
              3. Confirm it logs in properly
              4. Press Ctrl+C to exit rescrobbled
              
              Then press ENTER here to continue...
          
        - name: Check if Session File Now Exists
          stat:
            path: /home/{{ user_login }}/.config/rescrobbled/session
          register: rescrobbled_session_check
          
        - name: Verify Session File Created
          fail:
            msg: |
              Session file still not found at ~/.config/rescrobbled/session
              Please ensure you completed the rescrobbled login process.
              Run this playbook again after successfully logging in.
          when: not rescrobbled_session_check.stat.exists
      when: not rescrobbled_session_file.stat.exists | default(true)
      
    - name: Reload systemd daemon for user
      systemd:
        daemon_reload: yes
        scope: user
      
    - name: Start and Enable Rescrobbled Service
      systemd:
        name: rescrobbled
        state: started
        enabled: true
        scope: user
    
    - name: Verify Rescrobbled Service is Running
      command: systemctl --user is-active rescrobbled
      register: rescrobbled_status
      changed_when: false
      failed_when: rescrobbled_status.stdout != "active"
      
    - name: Display Success Message
      debug:
        msg: |
          ✓ Rescrobbled successfully installed and running!
          ✓ Your music will now be scrobbled to Last.fm
          
          To check status: systemctl --user status rescrobbled
          To view logs: journalctl --user -u rescrobbled -f

    - name: Create hifi-rs bashrc include file
      copy:
        content: |
          # hifi-rs play function to handle URLs
          play() {
              if [ -z "$1" ]; then
                  echo "Usage: play <qobuz_url>"
                  return 1
              fi
              hifi-rs play "$1"
          }
        dest: /home/{{ user_login }}/.bashrc-includes/hifi-rs
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0644'
    
