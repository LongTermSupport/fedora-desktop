#!/usr/bin/env ansible-playbook
- hosts: desktop
  name: Claude Code Containers - Install ccy and ccb
  become: false
  vars:
    root_dir: "{{ inventory_dir }}/../../"
  tasks:
    # ============================================================================
    # Prerequisites Check
    # ============================================================================
    - name: Check if Docker is Installed
      command: which docker
      register: docker_check
      failed_when: false
      changed_when: false

    - name: Verify Docker is Available
      fail:
        msg: |
          Docker is not installed or not in PATH.
          Please run the Docker installation playbook first:
            ansible-playbook playbooks/imports/optional/common/play-docker.yml
      when: docker_check.rc != 0

    - name: Check Docker Service is Running
      command: docker ps
      register: docker_service_check
      failed_when: false
      changed_when: false

    - name: Verify Docker Service
      fail:
        msg: |
          Docker service is not running.
          Please start Docker:
            systemctl --user start docker
      when: docker_service_check.rc != 0

    # ============================================================================
    # CCY (General YOLO Mode) Installation
    # ============================================================================
    - name: "CCY: Create Base Directory"
      become: true
      file:
        path: /opt/claude-yolo
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: "CCY: Create Custom Dockerfiles Directory"
      become: true
      file:
        path: /opt/claude-yolo/custom-dockerfiles
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: "CCY: Copy Dockerfile"
      become: true
      copy:
        src: "{{ root_dir }}/files/var/local/claude-yolo/Dockerfile"
        dest: /opt/claude-yolo/Dockerfile
        owner: root
        group: root
        mode: '0644'
      tags:
        - scripts
        - dockerfile

    - name: "CCY: Copy Entrypoint Script"
      become: true
      copy:
        src: "{{ root_dir }}/files/var/local/claude-yolo/entrypoint.sh"
        dest: /opt/claude-yolo/entrypoint.sh
        owner: root
        group: root
        mode: '0755'
      tags:
        - scripts
        - entrypoint

    - name: "CCY: Copy Startup Info File"
      become: true
      copy:
        src: "{{ root_dir }}/files/opt/claude-yolo/ccy-startup-info.txt"
        dest: /opt/claude-yolo/ccy-startup-info.txt
        owner: root
        group: root
        mode: '0644'

    - name: "CCY: Copy Custom Dockerfile Templates (Never Overwrite User Changes)"
      become: true
      copy:
        src: "{{ item }}"
        dest: "/opt/claude-yolo/custom-dockerfiles/{{ item | basename }}"
        owner: root
        group: root
        mode: '0644'
        force: no  # NEVER overwrite - users can customize these
      loop:
        - "{{ root_dir }}/files/var/local/claude-yolo/Dockerfile.project-template"
        - "{{ root_dir }}/files/var/local/claude-yolo/Dockerfile.example-ansible"
        - "{{ root_dir }}/files/var/local/claude-yolo/Dockerfile.example-golang"
      tags:
        - scripts
        - templates

    # Shared library for DRY helpers (used by both ccy and ccb)
    - name: "CCY: Create Shared Library Directory"
      become: true
      file:
        path: /var/local/claude-yolo/lib
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: "CCY: Install Shared Helper Libraries"
      become: true
      copy:
        src: "{{ item }}"
        dest: "/var/local/claude-yolo/lib/{{ item | basename }}"
        owner: root
        group: root
        mode: '0755'
      loop:
        - "{{ root_dir }}/files/var/local/claude-yolo/lib/common.bash"
        - "{{ root_dir }}/files/var/local/claude-yolo/lib/token-management.bash"
        - "{{ root_dir }}/files/var/local/claude-yolo/lib/ssh-handling.bash"
        - "{{ root_dir }}/files/var/local/claude-yolo/lib/network-management.bash"
        - "{{ root_dir }}/files/var/local/claude-yolo/lib/dockerfile-custom.bash"
        - "{{ root_dir }}/files/var/local/claude-yolo/lib/ui-helpers.bash"
      tags:
        - scripts
        - library

    # Remove old symlinks (cleanup from previous versions)
    - name: "CCY: Remove Old Symlink in /usr/local/bin"
      become: true
      file:
        path: /usr/local/bin/claude-yolo
        state: absent
      tags:
        - scripts
        - cleanup

    - name: "CCY: Copy Wrapper Script"
      become: true
      copy:
        src: "{{ root_dir }}/files/var/local/claude-yolo/claude-yolo"
        dest: /var/local/claude-yolo/claude-yolo
        owner: root
        group: root
        mode: '0755'
      tags:
        - scripts
        - wrapper

    - name: "CCY: Deploy Bashrc Include (Root)"
      become: true
      copy:
        src: "{{ root_dir }}/files/home/bashrc-includes/claude-yolo.bash"
        dest: /root/.bashrc-includes/claude-yolo.bash
        owner: root
        group: root
        mode: '0644'

    - name: "CCY: Deploy Bashrc Include (User)"
      copy:
        src: "{{ root_dir }}/files/home/bashrc-includes/claude-yolo.bash"
        dest: /home/{{ user_login }}/.bashrc-includes/claude-yolo.bash
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0644'

    - name: "CCY: Create Root Directory"
      file:
        path: /home/{{ user_login }}/.claude-tokens/ccy
        state: directory
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0700'

    - name: "CCY: Create Tokens Directory"
      file:
        path: /home/{{ user_login }}/.claude-tokens/ccy/tokens
        state: directory
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0700'

    - name: "CCY: Create Projects Directory"
      file:
        path: /home/{{ user_login }}/.claude-tokens/ccy/projects
        state: directory
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0700'

    - name: "CCY: Calculate Dockerfile Hash"
      shell: md5sum /opt/claude-yolo/Dockerfile | cut -d' ' -f1 | cut -c1-16
      register: ccy_dockerfile_hash
      changed_when: false

    - name: "CCY: Build Container Image"
      command: >
        docker build
        --build-arg DOCKERFILE_HASH={{ ccy_dockerfile_hash.stdout }}
        -t claude-yolo:latest
        /opt/claude-yolo
      register: ccy_docker_build
      changed_when: "'Successfully built' in ccy_docker_build.stdout or 'Successfully tagged' in ccy_docker_build.stdout"

    - name: "CCY: Verify Container Image"
      command: docker image inspect claude-yolo:latest
      register: ccy_image_verify
      changed_when: false

    # ============================================================================
    # CCB (Browser Mode) Installation
    # ============================================================================
    - name: "CCB: Create Base Directory"
      become: true
      file:
        path: /opt/claude-browser
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: "CCB: Copy Dockerfile"
      become: true
      copy:
        src: "{{ root_dir }}/files/var/local/claude-yolo/Dockerfile.browser"
        dest: /opt/claude-browser/Dockerfile
        owner: root
        group: root
        mode: '0644'
      tags:
        - scripts
        - dockerfile

    - name: "CCB: Copy Entrypoint Script"
      become: true
      copy:
        src: "{{ root_dir }}/files/var/local/claude-yolo/entrypoint-browser.sh"
        dest: /opt/claude-browser/entrypoint.sh
        owner: root
        group: root
        mode: '0755'
      tags:
        - scripts
        - entrypoint

    - name: "CCB: Create chrome-ws Directory"
      become: true
      file:
        path: /opt/claude-browser/chrome-ws
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: "CCB: Copy chrome-ws CLI Tool"
      become: true
      copy:
        src: "{{ root_dir }}/files/opt/claude-browser/chrome-ws/chrome-ws"
        dest: /opt/claude-browser/chrome-ws/chrome-ws
        owner: root
        group: root
        mode: '0755'
      tags:
        - scripts
        - chrome-ws

    - name: "CCB: Copy chrome-ws Library"
      become: true
      copy:
        src: "{{ root_dir }}/files/opt/claude-browser/chrome-ws/chrome-ws-lib.js"
        dest: /opt/claude-browser/chrome-ws/chrome-ws-lib.js
        owner: root
        group: root
        mode: '0644'
      tags:
        - scripts
        - chrome-ws

    - name: "CCB: Create Skills Directory"
      become: true
      file:
        path: /opt/claude-browser/skills/browsing
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: "CCB: Copy chrome-ws Skills Documentation"
      become: true
      copy:
        src: "{{ item }}"
        dest: /opt/claude-browser/skills/browsing/
        owner: root
        group: root
        mode: '0644'
      loop:
        - "{{ root_dir }}/files/opt/claude-browser/skills/browsing/SKILL.md"
        - "{{ root_dir }}/files/opt/claude-browser/skills/browsing/COMMANDLINE-USAGE.md"
        - "{{ root_dir }}/files/opt/claude-browser/skills/browsing/EXAMPLES.md"
      tags:
        - skills
        - chrome-ws

    - name: "CCB: Copy Startup Info File"
      become: true
      copy:
        src: "{{ root_dir }}/files/opt/claude-browser/ccb-startup-info.txt"
        dest: /opt/claude-browser/ccb-startup-info.txt
        owner: root
        group: root
        mode: '0644'

    - name: "CCB: Copy Wrapper Script"
      become: true
      copy:
        src: "{{ root_dir }}/files/var/local/claude-yolo/claude-browser"
        dest: /var/local/claude-yolo/claude-browser
        owner: root
        group: root
        mode: '0755'
      tags:
        - scripts
        - wrapper

    - name: "CCB: Deploy Bashrc Include (Root)"
      become: true
      copy:
        src: "{{ root_dir }}/files/home/bashrc-includes/claude-browser.bash"
        dest: /root/.bashrc-includes/claude-browser.bash
        owner: root
        group: root
        mode: '0644'

    - name: "CCB: Deploy Bashrc Include (User)"
      copy:
        src: "{{ root_dir }}/files/home/bashrc-includes/claude-browser.bash"
        dest: /home/{{ user_login }}/.bashrc-includes/claude-browser.bash
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0644'

    - name: "CCB: Create Root Directory"
      file:
        path: /home/{{ user_login }}/.claude-tokens/ccb
        state: directory
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0700'

    - name: "CCB: Create Projects Directory"
      file:
        path: /home/{{ user_login }}/.claude-tokens/ccb/projects
        state: directory
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0700'

    - name: "CCB: Calculate Dockerfile Hash"
      shell: md5sum /opt/claude-browser/Dockerfile | cut -d' ' -f1 | cut -c1-16
      register: ccb_dockerfile_hash
      changed_when: false

    - name: "CCB: Build Container Image"
      command: >
        docker build
        --build-arg DOCKERFILE_HASH={{ ccb_dockerfile_hash.stdout }}
        -t claude-browser:latest
        /opt/claude-browser
      register: ccb_docker_build
      changed_when: "'Successfully built' in ccb_docker_build.stdout or 'Successfully tagged' in ccb_docker_build.stdout"

    - name: "CCB: Verify Container Image"
      command: docker image inspect claude-browser:latest
      register: ccb_image_verify
      changed_when: false

    # ============================================================================
    # Installation Summary
    # ============================================================================
    - name: Display Installation Summary
      debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "Claude Code Containers Installation Complete"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "âœ… CCY (General YOLO Mode)"
          - "   â€¢ Container image: claude-yolo:latest"
          - "   â€¢ Wrapper script: /var/local/claude-yolo/claude-yolo"
          - "   â€¢ Bash alias: ccy"
          - "   â€¢ Token directory: ~/.claude-tokens/ccy/"
          - "   â€¢ Shared libraries: /var/local/claude-yolo/lib/"
          - ""
          - "âœ… CCB (Browser Mode)"
          - "   â€¢ Container image: claude-browser:latest"
          - "   â€¢ Wrapper script: /var/local/claude-yolo/claude-browser"
          - "   â€¢ Bash alias: ccb"
          - "   â€¢ chrome-ws CLI: Installed"
          - "   â€¢ Playwright MCP: Installed"
          - "   â€¢ Shares tokens with ccy"
          - "   â€¢ Separate project state: ~/.claude-tokens/ccb/"
          - ""
          - "ğŸ“‹ Features"
          - ""
          - "CCY Features:"
          - "  â€¢ General-purpose development container"
          - "  â€¢ Docker-based isolation"
          - "  â€¢ git, gh, Node.js, Python, ripgrep, jq, yq"
          - "  â€¢ Project-specific custom Dockerfiles"
          - "  â€¢ Docker network connectivity"
          - ""
          - "CCB Features:"
          - "  â€¢ All CCY features PLUS:"
          - "  â€¢ GUI browser support (X11/Wayland)"
          - "  â€¢ Playwright MCP for browser automation"
          - "  â€¢ chrome-ws CLI for Chrome DevTools Protocol"
          - "  â€¢ Chromium, Firefox, WebKit browsers"
          - "  â€¢ Claude Code browsing skills"
          - ""
          - "ğŸš€ First Run"
          - ""
          - "For CCY:"
          - "  cd ~/Projects/your-project"
          - "  ccy"
          - ""
          - "For CCB:"
          - "  cd ~/Projects/your-project"
          - "  ccb"
          - ""
          - "Both will prompt you to create a token on first run."
          - "Tokens are shared between ccy and ccb."
          - ""
          - "ğŸ’¡ Token Management"
          - ""
          - "  ccy --create-token     # Create new named token"
          - "  ccy --list-tokens      # List available tokens"
          - "  ccy --token personal   # Use specific token"
          - "  ccb --token personal   # Same token works for ccb"
          - ""
          - "ğŸ“š More Commands"
          - ""
          - "  ccy --help             # Show ccy options"
          - "  ccb --help             # Show ccb options"
          - "  ccy --custom           # Custom project Dockerfile"
          - "  ccy --connect          # Connect to Docker network"
          - ""
          - "âš ï¸  Security Notes"
          - ""
          - "  â€¢ YOLO mode bypasses all permission checks"
          - "  â€¢ Container isolation prevents unintended host access"
          - "  â€¢ Requires rootless Docker for safety"
          - "  â€¢ Tokens separate from desktop Claude Code"
          - ""
          - "ğŸ”„ Next Steps"
          - ""
          - "  1. Reload your shell: source ~/.bashrc"
          - "  2. Navigate to a project directory"
          - "  3. Run 'ccy' or 'ccb' to start"
          - "  4. Create a token when prompted"
          - "  5. Use /login in Claude Code to authenticate"
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
