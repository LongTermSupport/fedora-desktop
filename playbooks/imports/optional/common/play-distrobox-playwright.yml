#!/usr/bin/env ansible-playbook
---
- hosts: desktop
  name: Configure Playwright Distrobox for Browser Testing
  become: false
  vars:
    root_dir: "{{ inventory_dir }}/../../"
    distrobox_name: playwright-tests
    distrobox_image: ubuntu:22.04
    node_version: "20"

  tasks:
    # Preflight checks
    - name: Check if Distrobox is Installed
      command: which distrobox
      register: distrobox_check
      changed_when: false
      failed_when: false

    - name: Fail if Distrobox Not Installed
      fail:
        msg: |
          ERROR: Distrobox is not installed.

          Please install distrobox first:
            ansible-playbook playbooks/imports/optional/common/play-install-distrobox.yml
      when: distrobox_check.rc != 0

    # Container lifecycle management
    - name: Check if Playwright Container Exists
      shell: distrobox list --no-color | grep -w "{{ distrobox_name }}" || true
      register: container_exists
      changed_when: false

    - name: Create Playwright Distrobox Container
      command: >
        distrobox create
        --name {{ distrobox_name }}
        --image {{ distrobox_image }}
        --yes
      when: container_exists.stdout == ""
      register: container_created

    - name: Wait for Container to be Ready
      pause:
        seconds: 3
      when: container_created is changed

    # Node.js installation
    - name: Check if Node.js is Installed in Container
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c 'which node' || true
      register: node_check
      changed_when: false

    - name: Install Node.js in Playwright Container
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c '
          curl -fsSL https://deb.nodesource.com/setup_{{ node_version }}.x | sudo -E bash - &&
          sudo apt-get install -y nodejs
        '
      when: node_check.stdout == ""
      args:
        executable: /bin/bash

    # Playwright setup
    - name: Check if Playwright System Dependencies are Installed
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c 'dpkg -l | grep libgbm1' || true
      register: playwright_deps_check
      changed_when: false

    - name: Install Playwright System Dependencies
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c '
          npx -y playwright@latest install-deps chromium
        '
      when: playwright_deps_check.stdout == ""
      args:
        executable: /bin/bash

    - name: Check if Playwright Browsers are Installed
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c '
          test -d ~/.cache/ms-playwright/chromium-* && echo "installed" || echo "not installed"
        '
      register: browsers_check
      changed_when: false

    - name: Install Playwright Browsers (Chromium, Firefox, WebKit)
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c '
          npx -y playwright@latest install chromium firefox webkit
        '
      when: browsers_check.stdout.find('not installed') != -1
      args:
        executable: /bin/bash

    # User environment setup
    - name: Add playwright-test Alias to .bashrc
      blockinfile:
        path: "/home/{{ user_login }}/.bashrc"
        marker: "# {mark} ANSIBLE MANAGED: Playwright Distrobox"
        block: |
          # Quick access to Playwright testing container
          alias playwright-test='distrobox enter {{ distrobox_name }}'

          # Helper function to run Playwright commands from host
          playwright-run() {
            local current_dir="$PWD"
            distrobox enter {{ distrobox_name }} -- bash -c "cd '$current_dir' && \"\$@\""
          }
        create: false
        state: present

    - name: Ensure .local/bin Directory Exists
      file:
        path: "/home/{{ user_login }}/.local/bin"
        state: directory
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0755'

    - name: Create Helper Script for Container Management
      copy:
        dest: "/home/{{ user_login }}/.local/bin/playwright-distrobox"
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0755'
        content: |
          #!/usr/bin/env bash
          # Playwright Distrobox Management Script
          # Generated by Ansible - DO NOT EDIT MANUALLY

          set -euo pipefail

          CONTAINER_NAME="{{ distrobox_name }}"

          show_help() {
            cat << EOF
          Playwright Distrobox Management

          Usage: playwright-distrobox [COMMAND]

          Commands:
            enter         Enter the Playwright container (default)
            status        Show container status
            recreate      Remove and recreate the container
            update        Update browsers to latest version
            remove        Remove the container
            help          Show this help message

          Examples:
            playwright-distrobox enter
            playwright-distrobox status
            playwright-distrobox update

          For more information: docs/containerization.md
          EOF
          }

          check_exists() {
            if ! distrobox list --no-color | grep -qw "$CONTAINER_NAME"; then
              echo "ERROR: Container '$CONTAINER_NAME' does not exist"
              echo "Please run: ansible-playbook playbooks/imports/optional/common/play-distrobox-playwright.yml"
              exit 1
            fi
          }

          case "${1:-enter}" in
            enter)
              check_exists
              exec distrobox enter "$CONTAINER_NAME"
              ;;
            status)
              echo "Container: $CONTAINER_NAME"
              echo ""
              if distrobox list --no-color | grep -qw "$CONTAINER_NAME"; then
                echo "Status: EXISTS"
                distrobox list --no-color | grep -w "$CONTAINER_NAME"
                echo ""
                echo "Node.js version:"
                distrobox enter "$CONTAINER_NAME" -- node --version || echo "  Not installed"
                echo ""
                echo "Playwright browsers:"
                distrobox enter "$CONTAINER_NAME" -- bash -c '
                  if [ -d ~/.cache/ms-playwright ]; then
                    ls -1 ~/.cache/ms-playwright/ | grep -E "^(chromium|firefox|webkit)"
                  else
                    echo "  Not installed"
                  fi
                '
              else
                echo "Status: DOES NOT EXIST"
                echo ""
                echo "To create: ansible-playbook playbooks/imports/optional/common/play-distrobox-playwright.yml"
              fi
              ;;
            recreate)
              echo "Recreating container: $CONTAINER_NAME"
              echo ""
              if distrobox list --no-color | grep -qw "$CONTAINER_NAME"; then
                echo "Removing existing container..."
                distrobox rm "$CONTAINER_NAME" --force
              fi
              echo ""
              echo "Creating new container..."
              ansible-playbook playbooks/imports/optional/common/play-distrobox-playwright.yml
              ;;
            update)
              check_exists
              echo "Updating Playwright browsers in $CONTAINER_NAME..."
              distrobox enter "$CONTAINER_NAME" -- bash -c '
                npx -y playwright@latest install chromium firefox webkit
              '
              echo ""
              echo "Browsers updated successfully"
              ;;
            remove)
              check_exists
              echo "WARNING: This will remove the container: $CONTAINER_NAME"
              echo "Project files in ~/Projects/ will NOT be affected"
              echo ""
              read -p "Are you sure? (yes/no): " confirm
              if [ "$confirm" = "yes" ]; then
                distrobox rm "$CONTAINER_NAME" --force
                echo "Container removed"
              else
                echo "Cancelled"
              fi
              ;;
            help|--help|-h)
              show_help
              ;;
            *)
              echo "ERROR: Unknown command: $1"
              echo ""
              show_help
              exit 1
              ;;
          esac

    - name: Ensure .local/bin is in PATH
      lineinfile:
        path: "/home/{{ user_login }}/.bashrc"
        line: 'export PATH="$HOME/.local/bin:$PATH"'
        state: present
        create: false

    # Verification
    - name: Verify Playwright Container Configuration
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c '
          echo "Node.js: $(node --version)"
          echo "npm: $(npm --version)"
          echo "Browsers: $(ls -1 ~/.cache/ms-playwright/ 2>/dev/null | grep -E "^(chromium|firefox|webkit)" | wc -l) installed"
        '
      register: verification
      changed_when: false

    - name: Display Configuration Summary
      debug:
        msg:
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "Playwright Distrobox Configuration Complete"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - ""
          - "Container: {{ distrobox_name }}"
          - "Base Image: {{ distrobox_image }}"
          - "{{ verification.stdout }}"
          - ""
          - "Quick Commands:"
          - "  playwright-test              # Enter container"
          - "  playwright-distrobox status  # Show status"
          - "  playwright-distrobox update  # Update browsers"
          - "  playwright-distrobox help    # Show all commands"
          - ""
          - "Usage in Projects:"
          - "  cd ~/Projects/my-project/tests"
          - "  playwright-test              # Enter container"
          - "  npm install                  # Install project deps"
          - "  npm test                     # Run tests (GUI on desktop)"
          - ""
          - "Features:"
          - "  ✓ Ubuntu 22.04 (Playwright officially supported)"
          - "  ✓ Node.js LTS v{{ node_version }}"
          - "  ✓ Chromium, Firefox, WebKit browsers"
          - "  ✓ GUI support (X11/Wayland automatic)"
          - "  ✓ Shared across all projects in ~/Projects/"
          - "  ✓ Each project keeps own node_modules/"
          - ""
          - "Benefits:"
          - "  • Zero Fedora desktop pollution"
          - "  • ~400MB browsers shared across projects"
          - "  • Different Playwright versions per project"
          - "  • Browser windows visible on desktop"
          - ""
          - "Documentation: docs/containerization.md"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
