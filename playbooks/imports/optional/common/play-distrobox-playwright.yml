#!/usr/bin/env ansible-playbook
---
- hosts: desktop
  name: Configure Playwright Distrobox for Browser Testing
  become: false
  vars:
    root_dir: "{{ inventory_dir }}/../../"
    distrobox_name: playwright-tests
    distrobox_image: ubuntu:22.04
    node_version: "20"

  tasks:
    # Preflight checks
    - name: Check if Distrobox is Installed
      command: which distrobox
      register: distrobox_check
      changed_when: false
      failed_when: false

    - name: Fail if Distrobox Not Installed
      fail:
        msg: |
          ERROR: Distrobox is not installed.

          Please install distrobox first:
            ansible-playbook playbooks/imports/optional/common/play-install-distrobox.yml
      when: distrobox_check.rc != 0

    # Container lifecycle management
    - name: Check if Playwright Container Exists
      shell: distrobox list --no-color | grep -w "{{ distrobox_name }}" || true
      register: container_exists
      changed_when: false

    - name: Create Playwright Distrobox Container
      command: >
        distrobox create
        --name {{ distrobox_name }}
        --image {{ distrobox_image }}
        --yes
      when: container_exists.stdout == ""
      register: container_created

    - name: Wait for Container to be Ready
      pause:
        seconds: 3
      when: container_created is changed

    # Node.js installation
    - name: Check if Node.js is Installed in Container
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c 'which node' || true
      register: node_check
      changed_when: false

    - name: Install Node.js in Playwright Container
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c '
          curl -fsSL https://deb.nodesource.com/setup_{{ node_version }}.x | sudo -E bash - &&
          sudo apt-get install -y nodejs
        '
      when: node_check.stdout == ""
      args:
        executable: /bin/bash

    # Playwright setup
    - name: Check if Playwright System Dependencies are Installed
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c 'dpkg -l | grep libgbm1' || true
      register: playwright_deps_check
      changed_when: false

    - name: Install Playwright System Dependencies
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c '
          npx -y playwright@latest install-deps chromium
        '
      when: playwright_deps_check.stdout == ""
      args:
        executable: /bin/bash

    - name: Check if Playwright Browsers are Installed
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c '
          test -d ~/.cache/ms-playwright/chromium-* && echo "installed" || echo "not installed"
        '
      register: browsers_check
      changed_when: false

    - name: Install Playwright Browsers (Chromium, Firefox, WebKit)
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c '
          npx -y playwright@latest install chromium firefox webkit
        '
      when: browsers_check.stdout.find('not installed') != -1
      args:
        executable: /bin/bash

    # Development tools installation (feature parity with claude-yolo Docker)
    - name: Install Essential Development Tools
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c '
          sudo apt-get update && sudo apt-get install -y --no-install-recommends \
            git \
            vim \
            nano \
            ripgrep \
            jq \
            curl \
            wget \
            ca-certificates \
            openssh-client \
            python3 \
            python3-pip \
            bash-completion \
            less \
            tree \
            unzip
        '
      args:
        executable: /bin/bash

    # GitHub CLI installation
    - name: Check if GitHub CLI is Installed
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c 'command -v gh' || true
      register: gh_check
      changed_when: false

    - name: Install GitHub CLI
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c '
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg &&
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg &&
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null &&
          sudo apt-get update &&
          sudo apt-get install -y gh
        '
      when: gh_check.stdout == ""
      args:
        executable: /bin/bash

    # yq installation
    - name: Check if yq is Installed
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c 'command -v yq' || true
      register: yq_check
      changed_when: false

    - name: Install yq (YAML processor)
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c '
          sudo wget -qO /usr/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 &&
          sudo chmod +x /usr/bin/yq
        '
      when: yq_check.stdout == ""
      args:
        executable: /bin/bash

    # SSH configuration (home directory shared, so SSH keys already accessible)
    - name: Configure SSH in Container
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c '
          # SSH directory is shared from host, just ensure permissions
          if [ -d ~/.ssh ]; then
            chmod 700 ~/.ssh
            chmod 600 ~/.ssh/id* 2>/dev/null || true
          fi
        '
      args:
        executable: /bin/bash

    # Git configuration (shared from host via home directory)
    - name: Verify Git Configuration Accessible
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c '
          git config --global user.name || echo "Git config shared from host"
        '
      register: git_config_check
      changed_when: false

    # Claude Code installation
    - name: Check if Claude Code is Installed in Container
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c 'command -v claude' || true
      register: claude_check
      changed_when: false

    - name: Install Claude Code in Playwright Container
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c '
          curl -fsSL https://storage.googleapis.com/anthropic-cli/install.sh | bash
        '
      when: claude_check.stdout == ""
      args:
        executable: /bin/bash

    # User environment setup
    - name: Add playwright-test Alias to .bashrc
      blockinfile:
        path: "/home/{{ user_login }}/.bashrc"
        marker: "# {mark} ANSIBLE MANAGED: Playwright Distrobox"
        block: |
          # Quick access to Playwright testing container
          alias playwright-test='distrobox enter {{ distrobox_name }}'

          # Helper function to run Playwright commands from host
          playwright-run() {
            local current_dir="$PWD"
            distrobox enter {{ distrobox_name }} -- bash -c "cd '$current_dir' && \"\$@\""
          }
        create: false
        state: present

    - name: Ensure .local/bin Directory Exists
      file:
        path: "/home/{{ user_login }}/.local/bin"
        state: directory
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0755'

    - name: Create Helper Script for Container Management
      copy:
        dest: "/home/{{ user_login }}/.local/bin/playwright-distrobox"
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0755'
        content: |
          #!/usr/bin/env bash
          # Playwright Distrobox Management Script
          # Generated by Ansible - DO NOT EDIT MANUALLY

          set -euo pipefail

          CONTAINER_NAME="{{ distrobox_name }}"

          show_help() {
            cat << EOF
          Playwright Distrobox Management

          Usage: playwright-distrobox [COMMAND]

          Commands:
            enter         Enter the Playwright container (default)
            status        Show container status
            recreate      Remove and recreate the container
            update        Update browsers to latest version
            remove        Remove the container
            help          Show this help message

          Examples:
            playwright-distrobox enter
            playwright-distrobox status
            playwright-distrobox update

          For more information: docs/containerization.md
          EOF
          }

          check_exists() {
            if ! distrobox list --no-color | grep -qw "$CONTAINER_NAME"; then
              echo "ERROR: Container '$CONTAINER_NAME' does not exist"
              echo "Please run: ansible-playbook playbooks/imports/optional/common/play-distrobox-playwright.yml"
              exit 1
            fi
          }

          case "${1:-enter}" in
            enter)
              check_exists
              exec distrobox enter "$CONTAINER_NAME"
              ;;
            status)
              echo "Container: $CONTAINER_NAME"
              echo ""
              if distrobox list --no-color | grep -qw "$CONTAINER_NAME"; then
                echo "Status: EXISTS"
                distrobox list --no-color | grep -w "$CONTAINER_NAME"
                echo ""
                echo "Node.js version:"
                distrobox enter "$CONTAINER_NAME" -- node --version || echo "  Not installed"
                echo ""
                echo "Playwright browsers:"
                distrobox enter "$CONTAINER_NAME" -- bash -c '
                  if [ -d ~/.cache/ms-playwright ]; then
                    ls -1 ~/.cache/ms-playwright/ | grep -E "^(chromium|firefox|webkit)"
                  else
                    echo "  Not installed"
                  fi
                '
              else
                echo "Status: DOES NOT EXIST"
                echo ""
                echo "To create: ansible-playbook playbooks/imports/optional/common/play-distrobox-playwright.yml"
              fi
              ;;
            recreate)
              echo "Recreating container: $CONTAINER_NAME"
              echo ""
              if distrobox list --no-color | grep -qw "$CONTAINER_NAME"; then
                echo "Removing existing container..."
                distrobox rm "$CONTAINER_NAME" --force
              fi
              echo ""
              echo "Creating new container..."
              ansible-playbook playbooks/imports/optional/common/play-distrobox-playwright.yml
              ;;
            update)
              check_exists
              echo "Updating Playwright browsers in $CONTAINER_NAME..."
              distrobox enter "$CONTAINER_NAME" -- bash -c '
                npx -y playwright@latest install chromium firefox webkit
              '
              echo ""
              echo "Browsers updated successfully"
              ;;
            remove)
              check_exists
              echo "WARNING: This will remove the container: $CONTAINER_NAME"
              echo "Project files in ~/Projects/ will NOT be affected"
              echo ""
              read -p "Are you sure? (yes/no): " confirm
              if [ "$confirm" = "yes" ]; then
                distrobox rm "$CONTAINER_NAME" --force
                echo "Container removed"
              else
                echo "Cancelled"
              fi
              ;;
            help|--help|-h)
              show_help
              ;;
            *)
              echo "ERROR: Unknown command: $1"
              echo ""
              show_help
              exit 1
              ;;
          esac

    - name: Ensure .local/bin is in PATH
      lineinfile:
        path: "/home/{{ user_login }}/.bashrc"
        line: 'export PATH="$HOME/.local/bin:$PATH"'
        state: present
        create: false

    # Claude Code Browser Automation Mode (DRY architecture)
    - name: Create Claude YOLO Library Directory
      become: true
      file:
        path: /var/local/claude-yolo/lib
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Install Shared Helper Library
      become: true
      copy:
        src: "{{ root_dir }}/files/var/local/claude-yolo/lib/common.bash"
        dest: /var/local/claude-yolo/lib/common.bash
        owner: root
        group: root
        mode: '0755'

    - name: Install claude-yolo-browser Command
      become: true
      copy:
        src: "{{ root_dir }}/files/var/local/claude-yolo/claude-yolo-browser"
        dest: /var/local/claude-yolo/claude-yolo-browser
        owner: root
        group: root
        mode: '0755'

    - name: Install ccy-browser Bash Aliases
      copy:
        src: "{{ root_dir }}/files/home/bashrc-includes/claude-yolo-browser.bash"
        dest: "/home/{{ user_login }}/.bashrc-includes/claude-yolo-browser.bash"
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0644'

    # Verification
    - name: Verify Playwright Container Configuration
      shell: |
        distrobox enter {{ distrobox_name }} -- bash -c '
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Container Environment:"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Node.js: $(node --version 2>/dev/null || echo "not found")"
          echo "npm: $(npm --version 2>/dev/null || echo "not found")"
          echo "Playwright Browsers: $(ls -1 ~/.cache/ms-playwright/ 2>/dev/null | grep -E "^(chromium|firefox|webkit)" | wc -l) installed"
          echo ""
          echo "Development Tools:"
          echo "  git: $(git --version 2>/dev/null | cut -d\" \" -f3 || echo "not found")"
          echo "  gh: $(gh --version 2>/dev/null | head -1 | cut -d\" \" -f3 || echo "not found")"
          echo "  ripgrep: $(rg --version 2>/dev/null | head -1 | cut -d\" \" -f2 || echo "not found")"
          echo "  jq: $(jq --version 2>/dev/null | cut -d\"-\" -f2 || echo "not found")"
          echo "  yq: $(yq --version 2>/dev/null | cut -d\" \" -f4 || echo "not found")"
          echo "  python3: $(python3 --version 2>/dev/null | cut -d\" \" -f2 || echo "not found")"
          echo "  vim: $(vim --version 2>/dev/null | head -1 | grep -oP \"(?<=VIM - Vi IMproved )[0-9.]+\" || echo "not found")"
          echo ""
          echo "Claude Code:"
          echo "  $(claude --version 2>/dev/null || echo "not found")"
          echo ""
          echo "SSH & Git Config:"
          echo "  SSH keys: $(ls -1 ~/.ssh/id* 2>/dev/null | wc -l) keys found"
          echo "  Git user: $(git config --global user.name 2>/dev/null || echo "not configured")"
          echo "  Git email: $(git config --global user.email 2>/dev/null || echo "not configured")"
        '
      register: verification
      changed_when: false

    - name: Display Configuration Summary
      debug:
        msg:
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "Playwright Distrobox Configuration Complete"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - ""
          - "Container: {{ distrobox_name }}"
          - "Base Image: {{ distrobox_image }}"
          - ""
          - "{{ verification.stdout }}"
          - ""
          - "Quick Commands:"
          - "  ccy-browser                  # Claude Code with MCP browser automation (YOLO mode)"
          - "  playwright-test              # Enter container manually"
          - "  playwright-distrobox status  # Show status"
          - "  playwright-distrobox update  # Update browsers"
          - ""
          - "Interactive MCP Browser Automation:"
          - "  cd ~/Projects/my-project"
          - "  ccy-browser"
          - "  # Ask Claude to explore/debug web applications"
          - "  # Watch browsers execute in real-time on your desktop"
          - "  # Claude uses MCP to control Playwright interactively"
          - ""
          - "Manual Test Development:"
          - "  cd ~/Projects/my-project/tests"
          - "  playwright-test              # Enter container"
          - "  npm install && npm test      # Run tests manually"
          - ""
          - "Environment Features:"
          - "  ✓ Full development environment (git, gh, ripgrep, jq, yq, vim)"
          - "  ✓ Claude Code with YOLO mode"
          - "  ✓ Node.js LTS v{{ node_version }}"
          - "  ✓ Playwright browsers (Chromium, Firefox, WebKit)"
          - "  ✓ GUI support (X11/Wayland automatic)"
          - "  ✓ SSH keys and git config (shared from host)"
          - "  ✓ Python 3 with pip"
          - "  ✓ All Claude Code dependencies"
          - ""
          - "Key Benefits:"
          - "  • Watch Claude Code control browsers through MCP"
          - "  • Interactive debugging with visual feedback"
          - "  • Full dev tooling (same as claude-yolo Docker)"
          - "  • Zero desktop pollution (isolated environment)"
          - "  • Seamless GUI integration (Distrobox magic)"
          - ""
          - "Use Cases:"
          - "  • MCP browser automation and exploration"
          - "  • Interactive web scraping development"
          - "  • Visual debugging of browser tests"
          - "  • Acceptance test engineering"
          - ""
          - "Documentation: docs/containerization.md"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
