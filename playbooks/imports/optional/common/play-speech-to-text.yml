#!/usr/bin/env ansible-playbook
---
#!/usr/bin/env ansible-playbook
# Speech-to-Text GNOME Extension with GPU-accelerated Whisper (faster-whisper)
#
# Prerequisites: NVIDIA drivers installed via play-nvidia.yml
#
# Usage: Press Insert key to toggle recording. Text auto-pastes when stopped.
# Model: Configurable via stt_model in host_vars/localhost.yml (default: small)
#        Options: tiny, base, small, medium, large-v3
- hosts: desktop
  name: Speech-to-Text Extension
  become: true
  vars:
    root_dir: "{{ inventory_dir }}/../../"
    extension_name: speech-to-text@fedora-desktop
    extension_src: "{{ root_dir }}/extensions/{{ extension_name }}"
    extension_dest: "/home/{{ user_login }}/.local/share/gnome-shell/extensions/{{ extension_name }}"
    # Whisper model size: tiny, base, small, medium, large-v3
    # Both batch and streaming modes share the same model cache (~/.cache/huggingface/hub/)
    faster_whisper_model: "{{ stt_model | default('small') }}"
    # Language code for transcription (e.g., "en" for English)
    # Set to empty string "" for auto-detect (not recommended)
    stt_language_code: "{{ stt_language | default('en') }}"
  tasks:
    # =========================================================================
    # System Dependencies
    # =========================================================================

    - name: Install System Dependencies
      ansible.builtin.dnf:
        name:
          - sox
          - ydotool
          - wl-clipboard
          - python3-pip
          - zenity
          - wev  # Wayland event viewer for debugging keybindings
        state: present

    - name: Stop User ydotool Service if Running
      become: true
      become_user: "{{ user_login }}"
      ansible.builtin.systemd:
        name: ydotool
        scope: user
        state: stopped
        enabled: false
      failed_when: false

    - name: Create ydotool System Service Override Directory
      ansible.builtin.file:
        path: /etc/systemd/system/ydotool.service.d
        state: directory
        mode: '0755'

    - name: Configure ydotool System Service with User-accessible Socket
      ansible.builtin.copy:
        dest: /etc/systemd/system/ydotool.service.d/override.conf
        mode: '0644'
        content: |
          [Service]
          ExecStart=
          ExecStart=/usr/bin/ydotoold --socket-path=/run/ydotool.socket --socket-perm=0666
      register: ydotool_override

    - name: Reload Systemd for ydotool Override
      ansible.builtin.systemd:
        daemon_reload: true
      when: ydotool_override.changed

    - name: Enable and Start System ydotool Daemon
      ansible.builtin.systemd:
        name: ydotool
        enabled: true
        state: restarted

    - name: Wait for ydotool Socket
      ansible.builtin.wait_for:
        path: /run/ydotool.socket
        state: present
        timeout: 10

    # =========================================================================
    # faster-whisper with GPU acceleration
    # =========================================================================

    - name: Install faster-whisper with CUDA Support
      become: true
      become_user: "{{ user_login }}"
      ansible.builtin.pip:
        name:
          - faster-whisper
          - nvidia-cublas-cu12
          - nvidia-cudnn-cu12==9.*
          - textual
        extra_args: --user
        state: present

    - name: Find CUDA Library Paths
      become: true
      become_user: "{{ user_login }}"
      ansible.builtin.shell: |
        python3 -c "
        import os
        try:
            import nvidia.cublas
            import nvidia.cudnn
            cublas = os.path.join(nvidia.cublas.__path__[0], 'lib')
            cudnn = os.path.join(nvidia.cudnn.__path__[0], 'lib')
            print(f'{cublas}:{cudnn}')
        except (ImportError, IndexError):
            print('')
        "
      register: cuda_lib_paths
      changed_when: false

    - name: Create faster-whisper Shell Wrapper
      ansible.builtin.copy:
        dest: "/home/{{ user_login }}/.local/bin/faster-whisper-transcribe"
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0755'
        content: |
          #!/bin/bash
          # Set CUDA library paths before running Python
          export LD_LIBRARY_PATH="{{ cuda_lib_paths.stdout }}${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"
          exec python3 ~/.local/bin/faster-whisper-transcribe.py "$@"

    - name: Create faster-whisper Python Script
      ansible.builtin.copy:
        dest: "/home/{{ user_login }}/.local/bin/faster-whisper-transcribe.py"
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0644'
        content: |
          #!/usr/bin/env python3
          """GPU-accelerated speech-to-text using faster-whisper with streaming output"""
          import sys
          import os
          from faster_whisper import WhisperModel

          def main():
              stream_mode = '--stream' in sys.argv
              args = [a for a in sys.argv[1:] if a != '--stream']

              if len(args) < 1:
                  print("Usage: faster-whisper-transcribe [--stream] <audio-file>", file=sys.stderr)
                  sys.exit(1)

              audio_file = args[0]
              if not os.path.exists(audio_file):
                  print(f"Error: File not found: {audio_file}", file=sys.stderr)
                  sys.exit(1)

              model_size = os.environ.get('WHISPER_MODEL', '{{ faster_whisper_model }}')
              language = os.environ.get('WHISPER_LANGUAGE', '{{ stt_language_code }}') or None

              # Try GPU first, fall back to CPU
              try:
                  model = WhisperModel(model_size, device="cuda", compute_type="float16")
              except Exception as e:
                  print(f"GPU not available ({e}), using CPU", file=sys.stderr)
                  model = WhisperModel(model_size, device="cpu", compute_type="int8")

              # Force language if configured (avoids auto-detect errors)
              segments, info = model.transcribe(audio_file, beam_size=5, language=language)

              if stream_mode:
                  # Stream segments as they arrive
                  all_text = []
                  for segment in segments:
                      text = segment.text.strip()
                      if text:
                          all_text.append(text)
                          print(text, flush=True)
                  # Print final combined result on last line
                  final = " ".join(all_text)
                  if final:
                      final = final[0].upper() + final[1:] if len(final) > 1 else final.upper()
                      print(f"\n---FINAL---\n{final}", flush=True)
              else:
                  # Batch mode - collect all then output
                  text = " ".join([segment.text.strip() for segment in segments])
                  if text:
                      text = text[0].upper() + text[1:] if len(text) > 1 else text.upper()
                  print(text)

          if __name__ == "__main__":
              main()

    # =========================================================================
    # RealtimeSTT Streaming Mode
    # =========================================================================
    # Provides real-time transcription - transcribes while you speak.
    # Enable via extension menu: "Streaming mode (instant)"
    #
    # WARNING: First install can take MANY MINUTES (5-15+) due to large downloads
    # (PyTorch ~2GB, plus many dependencies). Subsequent runs are instant.

    - name: Install RealtimeSTT for Streaming Mode (WARNING - CAN TAKE MANY MINUTES ON FIRST RUN)
      become: true
      become_user: "{{ user_login }}"
      ansible.builtin.pip:
        name:
          - RealtimeSTT
        extra_args: --user
        state: present

    - name: Install PortAudio for RealtimeSTT (System Dependency)
      ansible.builtin.dnf:
        name:
          - portaudio-devel
          - python3-devel
        state: present

    - name: Stop wsi-stream-server if Running (to pick up updated scripts)
      become: true
      become_user: "{{ user_login }}"
      ansible.builtin.shell:
        cmd: pkill -f wsi-stream-server
      register: pkill_result
      changed_when: pkill_result.rc == 0
      failed_when: pkill_result.rc not in [0, 1]  # 1 = no process found, that's fine

    - name: Deploy Streaming Script (wsi-stream)
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/home/.local/bin/wsi-stream"
        dest: "/home/{{ user_login }}/.local/bin/wsi-stream"
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0755'

    - name: Deploy Streaming Server Script (wsi-stream-server)
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/home/.local/bin/wsi-stream-server"
        dest: "/home/{{ user_login }}/.local/bin/wsi-stream-server"
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0755'

    - name: Deploy Whisper Model Manager (wsi-model-manager)
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/home/.local/bin/wsi-model-manager"
        dest: "/home/{{ user_login }}/.local/bin/wsi-model-manager"
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0755'

    # =========================================================================
    # GNOME Extension
    # =========================================================================

    - name: Ensure Directories Exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0755'
      loop:
        - "/home/{{ user_login }}/.local/bin"
        - "/home/{{ user_login }}/.local/share/speech-to-text"
        - "{{ extension_dest }}"
        - "{{ extension_dest }}/schemas"

    - name: Copy Extension Files
      ansible.builtin.copy:
        src: "{{ extension_src }}/{{ item }}"
        dest: "{{ extension_dest }}/{{ item }}"
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0644'
      loop:
        - extension.js
        - metadata.json

    - name: Copy GSettings Schema
      ansible.builtin.copy:
        src: "{{ extension_src }}/schemas/org.gnome.shell.extensions.speech-to-text.gschema.xml"
        dest: "{{ extension_dest }}/schemas/"
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0644'
      register: schema_copy

    - name: Compile GSettings Schema
      ansible.builtin.command:
        cmd: glib-compile-schemas "{{ extension_dest }}/schemas"
      when: schema_copy.changed
      register: schema_compile
      changed_when: true
      failed_when: schema_compile.rc != 0

    - name: Copy WSI Script
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/home/.local/bin/wsi"
        dest: "/home/{{ user_login }}/.local/bin/wsi"
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0755'

    # =========================================================================
    # Claude Code Post-Processing Integration
    # =========================================================================

    - name: Create Speech-to-Text Config Directory
      ansible.builtin.file:
        path: "/home/{{ user_login }}/.config/speech-to-text"
        state: directory
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0755'

    - name: Deploy Claude Processing Script
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/home/.local/bin/wsi-claude-process"
        dest: "/home/{{ user_login }}/.local/bin/wsi-claude-process"
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0755'

    - name: Backup Existing Claude Prompt Templates (if different from source)
      ansible.builtin.copy:
        src: "/home/{{ user_login }}/.config/speech-to-text/{{ item }}"
        dest: "/home/{{ user_login }}/.config/speech-to-text/{{ item }}.bak"
        remote_src: true
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0644'
        force: true
      loop:
        - claude-prompt-corporate.txt
        - claude-prompt-natural.txt
      when: lookup('file', root_dir + '/files/home/.config/speech-to-text/' + item, errors='ignore') != lookup('file', '/home/' + user_login + '/.config/speech-to-text/' + item, errors='ignore')
      failed_when: false  # Don't fail if file doesn't exist yet

    - name: Deploy Claude Prompt Templates
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/home/.config/speech-to-text/{{ item }}"
        dest: "/home/{{ user_login }}/.config/speech-to-text/{{ item }}"
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0644'
        force: true
      loop:
        - claude-prompt-corporate.txt
        - claude-prompt-natural.txt

    # =========================================================================
    # Extension Reload
    # =========================================================================

    - name: Check if Extension is Currently Enabled
      become: true
      become_user: "{{ user_login }}"
      ansible.builtin.shell:
        cmd: gnome-extensions list --enabled | grep -q "{{ extension_name }}"
      register: extension_enabled
      changed_when: false
      failed_when: false

    - name: Disable Extension (to force reload)
      become: true
      become_user: "{{ user_login }}"
      ansible.builtin.command:
        cmd: gnome-extensions disable {{ extension_name }}
      when: extension_enabled.rc == 0
      register: disable_result
      changed_when: disable_result.rc == 0
      failed_when: false

    - name: Wait for Extension to Unload
      ansible.builtin.pause:
        seconds: 2
      when: extension_enabled.rc == 0

    - name: Enable Extension
      become: true
      become_user: "{{ user_login }}"
      ansible.builtin.command:
        cmd: gnome-extensions enable {{ extension_name }}
      register: enable_result
      changed_when: "'is now enabled' in enable_result.stderr or enable_result.rc == 0"
      failed_when: false

    - name: Extension Reload Complete
      ansible.builtin.debug:
        msg: "âœ“ Speech-to-Text extension reloaded successfully"
      when: extension_enabled.rc == 0
