---
#!/usr/bin/env ansible-playbook
# Speech-to-Text GNOME Extension with GPU-accelerated Whisper (faster-whisper)
#
# Prerequisites: NVIDIA drivers installed via play-nvidia.yml
#
# Usage: Press Insert key to toggle recording. Text auto-pastes when stopped.
# Model: Configurable via stt_model in host_vars/localhost.yml (default: small)
#        Options: tiny, base, small, medium, large-v3
- hosts: desktop
  name: Speech-to-Text Extension
  become: true
  vars:
    root_dir: "{{ inventory_dir }}/../../"
    extension_name: speech-to-text@fedora-desktop
    extension_src: "{{ root_dir }}/extensions/{{ extension_name }}"
    extension_dest: "/home/{{ user_login }}/.local/share/gnome-shell/extensions/{{ extension_name }}"
    faster_whisper_model: "{{ stt_model | default('small') }}"
  tasks:
    # =========================================================================
    # System Dependencies
    # =========================================================================

    - name: Install System Dependencies
      ansible.builtin.dnf:
        name:
          - sox
          - wtype
          - wl-clipboard
          - python3-pip
        state: present

    # =========================================================================
    # faster-whisper with GPU acceleration
    # =========================================================================

    - name: Install faster-whisper with CUDA Support
      become: true
      become_user: "{{ user_login }}"
      ansible.builtin.pip:
        name:
          - faster-whisper
          - nvidia-cublas-cu12
          - nvidia-cudnn-cu12==9.*
        extra_args: --user
        state: present

    - name: Find CUDA Library Paths
      become: true
      become_user: "{{ user_login }}"
      ansible.builtin.shell: |
        python3 -c "
        import os
        try:
            import nvidia.cublas
            import nvidia.cudnn
            cublas = os.path.join(nvidia.cublas.__path__[0], 'lib')
            cudnn = os.path.join(nvidia.cudnn.__path__[0], 'lib')
            print(f'{cublas}:{cudnn}')
        except (ImportError, IndexError):
            print('')
        "
      register: cuda_lib_paths
      changed_when: false

    - name: Create faster-whisper Shell Wrapper
      ansible.builtin.copy:
        dest: "/home/{{ user_login }}/.local/bin/faster-whisper-transcribe"
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0755'
        content: |
          #!/bin/bash
          # Set CUDA library paths before running Python
          export LD_LIBRARY_PATH="{{ cuda_lib_paths.stdout }}${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"
          exec python3 ~/.local/bin/faster-whisper-transcribe.py "$@"

    - name: Create faster-whisper Python Script
      ansible.builtin.copy:
        dest: "/home/{{ user_login }}/.local/bin/faster-whisper-transcribe.py"
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0644'
        content: |
          #!/usr/bin/env python3
          """GPU-accelerated speech-to-text using faster-whisper"""
          import sys
          import os
          from faster_whisper import WhisperModel

          def main():
              if len(sys.argv) < 2:
                  print("Usage: faster-whisper-transcribe <audio-file>", file=sys.stderr)
                  sys.exit(1)

              audio_file = sys.argv[1]
              if not os.path.exists(audio_file):
                  print(f"Error: File not found: {audio_file}", file=sys.stderr)
                  sys.exit(1)

              model_size = os.environ.get('WHISPER_MODEL', '{{ faster_whisper_model }}')

              # Try GPU first, fall back to CPU
              try:
                  model = WhisperModel(model_size, device="cuda", compute_type="float16")
              except Exception as e:
                  print(f"GPU not available ({e}), using CPU", file=sys.stderr)
                  model = WhisperModel(model_size, device="cpu", compute_type="int8")

              segments, info = model.transcribe(audio_file, beam_size=5)
              text = " ".join([segment.text.strip() for segment in segments])

              if text:
                  text = text[0].upper() + text[1:] if len(text) > 1 else text.upper()

              print(text)

          if __name__ == "__main__":
              main()

    # =========================================================================
    # GNOME Extension
    # =========================================================================

    - name: Ensure Directories Exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0755'
      loop:
        - "/home/{{ user_login }}/.local/bin"
        - "{{ extension_dest }}"
        - "{{ extension_dest }}/schemas"

    - name: Copy Extension Files
      ansible.builtin.copy:
        src: "{{ extension_src }}/{{ item }}"
        dest: "{{ extension_dest }}/{{ item }}"
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0644'
      loop:
        - extension.js
        - metadata.json

    - name: Copy GSettings Schema
      ansible.builtin.copy:
        src: "{{ extension_src }}/schemas/org.gnome.shell.extensions.speech-to-text.gschema.xml"
        dest: "{{ extension_dest }}/schemas/"
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0644'
      register: schema_copy

    - name: Compile GSettings Schema
      ansible.builtin.command:
        cmd: glib-compile-schemas "{{ extension_dest }}/schemas"
      when: schema_copy.changed

    - name: Copy WSI Scripts
      ansible.builtin.copy:
        src: "{{ extension_src }}/{{ item }}"
        dest: "/home/{{ user_login }}/.local/bin/{{ item }}"
        owner: "{{ user_login }}"
        group: "{{ user_login }}"
        mode: '0755'
      loop:
        - wsi
        - wsi-transcribe

    - name: Enable Extension
      become: true
      become_user: "{{ user_login }}"
      ansible.builtin.command:
        cmd: gnome-extensions enable {{ extension_name }}
      register: enable_result
      changed_when: "'is now enabled' in enable_result.stderr or enable_result.rc == 0"
      failed_when: false
