---
#!/usr/bin/env ansible-playbook
# Speech-to-Text Tools for Linux - Local AI Processing
# Installs multiple STT tools optimized for different desktop environments
#
# Tools installed:
# - Blurt: GNOME Shell extension (âœ… Best for GNOME users)
# - Sonori: Wayland overlay app (âš ï¸  GNOME: CLI mode only)
#
# @see https://github.com/QuantiusBenignus/blurt
# @see https://github.com/0xPD33/sonori
- hosts: desktop
  name: Install Speech-to-Text Tools
  become: false
  vars:
    root_dir: "{{ inventory_dir }}/../.."
    sonori_version: "0.6.1"
    sonori_install_dir: "/opt/sonori"
    sonori_url: "https://github.com/0xPD33/sonori/releases/download/v{{ sonori_version }}/Sonori-{{ sonori_version }}-x86_64.AppImage"
    blurt_repo: "https://github.com/QuantiusBenignus/blurt.git"
    # Whisper model selection - can be overridden in host_vars/localhost.yml
    # Options: tiny.en (87MB), small.en (497MB), medium.en (1.83GB), large-v3 (3.39GB)
    whisper_model: "{{ whisper_model_size | default('medium.en') }}"
    whisper_model_url: "https://huggingface.co/Mozilla/whisperfile/resolve/main/whisper-{{ whisper_model }}.llamafile"
  tasks:
    # =========================================================================
    # Detect Environment and User Paths
    # =========================================================================

    - name: Get Real User Home Directory
      ansible.builtin.shell: echo "$HOME"
      register: real_user_home
      changed_when: false

    - name: Detect Desktop Environment
      ansible.builtin.shell: echo "$XDG_CURRENT_DESKTOP"
      register: desktop_env
      changed_when: false

    - name: Check for NVIDIA GPU
      ansible.builtin.command: which nvidia-smi
      register: nvidia_check
      failed_when: false
      changed_when: false

    - name: Set Desktop Environment Facts
      ansible.builtin.set_fact:
        is_gnome: "{{ 'GNOME' in desktop_env.stdout }}"
        is_kde: "{{ 'KDE' in desktop_env.stdout }}"
        has_nvidia: "{{ nvidia_check.rc == 0 }}"
        user_home: "{{ real_user_home.stdout }}"
        blurt_extension_dir: "{{ real_user_home.stdout }}/.local/share/gnome-shell/extensions/blurt@quantiusbenignus.local"

    # =========================================================================
    # Install Common Dependencies
    # =========================================================================

    - name: Install Common STT Dependencies
      become: true
      ansible.builtin.package:
        name: "{{ packages }}"
        state: present
      vars:
        packages:
          # Audio processing
          - pipewire
          - pipewire-pulseaudio
          - sox
          # Clipboard utilities
          - xsel # X11 clipboard
          - wl-clipboard # Wayland clipboard (wl-copy)
          # Network tools
          - curl
          # AppImage support
          - fuse
          # Vulkan GPU acceleration (all GPUs)
          - vulkan-loader
          - vulkan-tools

    # =========================================================================
    # Install Whisper Backend (Backend for Blurt)
    # =========================================================================

    - name: Create User Local Bin Directory
      ansible.builtin.file:
        path: "{{ user_home }}/.local/bin"
        state: directory
        mode: "0755"

    - name: Create User Local Share Directory
      ansible.builtin.file:
        path: "{{ user_home }}/.local/share"
        state: directory
        mode: "0755"

    # Fedora's whisper-cpp package only provides libraries, not binaries
    # Use whisperfile (portable llamafile) instead - works with Blurt
    # Model size configurable via whisper_model_size in host_vars/localhost.yml
    # Default: medium.en (1.83GB) - excellent accuracy
    # Options: tiny.en (87MB), small.en (497MB), medium.en (1.83GB), large-v3 (3.39GB)
    - name: Download Whisperfile (Portable Whisper with Embedded Model)
      ansible.builtin.get_url:
        url: "{{ whisper_model_url }}"
        dest: "{{ user_home }}/.local/bin/whisperfile"
        mode: "0755"
      when: is_gnome

    - name: Create Transcribe Symlink for Blurt Compatibility
      ansible.builtin.file:
        src: "{{ user_home }}/.local/bin/whisperfile"
        dest: "{{ user_home }}/.local/bin/transcribe"
        state: link
      when: is_gnome

    # =========================================================================
    # Install Blurt GNOME Extension (GNOME only)
    # =========================================================================

    - name: Clone Blurt Repository
      ansible.builtin.git:
        repo: "{{ blurt_repo }}"
        dest: "/tmp/blurt"
        version: main
        force: true
      when: is_gnome

    - name: Create GNOME Extensions Directory
      ansible.builtin.file:
        path: "{{ blurt_extension_dir }}"
        state: directory
        mode: "0755"
      when: is_gnome

    - name: Install Blurt Extension Files
      ansible.builtin.shell: |
        # Extension files are in repo root, copy specific files/dirs
        cd /tmp/blurt
        cp -r extension.js metadata.json prefs.js stylesheet.css resources schemas {{ blurt_extension_dir }}/
      when: is_gnome
      changed_when: true

    - name: Install Enhanced WSI Script (Blurt Orchestrator with Debug Support)
      ansible.builtin.copy:
        src: "{{ root_dir }}/files/var/local/blurt/wsi"
        dest: "{{ user_home }}/.local/bin/wsi"
        mode: "0755"
      when: is_gnome

    # Note: Cannot enable extension until GNOME Shell is restarted
    # User must restart GNOME Shell first, then enable manually

    # =========================================================================
    # Install Sonori (All Desktop Environments)
    # =========================================================================

    - name: Create Sonori Installation Directory
      become: true
      ansible.builtin.file:
        path: "{{ sonori_install_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Download Sonori AppImage
      become: true
      ansible.builtin.get_url:
        url: "{{ sonori_url }}"
        dest: "{{ sonori_install_dir }}/sonori.appimage"
        owner: root
        group: root
        mode: "0755"
        checksum: "" # No checksums provided in releases

    - name: Create Sonori Symlink
      become: true
      ansible.builtin.file:
        src: "{{ sonori_install_dir }}/sonori.appimage"
        dest: /usr/local/bin/sonori
        state: link

    - name: Create Sonori Desktop Entry
      become: true
      ansible.builtin.copy:
        dest: /usr/local/share/applications/sonori.desktop
        owner: root
        group: root
        mode: "0644"
        content: |
          [Desktop Entry]
          Name=Sonori{% if is_gnome %} (CLI Mode){% endif %}

          Comment=Local AI Speech-to-Text{% if is_gnome %} - Use: sonori --cli{% endif %}

          Exec=/usr/local/bin/sonori{% if is_gnome %} --cli{% endif %}

          Icon=audio-input-microphone
          Terminal={% if is_gnome %}true{% else %}false{% endif %}

          Type=Application
          Categories=Audio;AudioVideo;Utility;
          Keywords=transcription;speech-to-text;AI;voice;

    - name: Update Desktop Database
      become: true
      ansible.builtin.command: update-desktop-database /usr/local/share/applications
      changed_when: false

    # =========================================================================
    # Display Installation Summary
    # =========================================================================

    - name: Display Installation Summary
      ansible.builtin.debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "Speech-to-Text Tools Installation Complete"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "Desktop Environment: {{ desktop_env.stdout }}"
          - "GPU: {{ 'NVIDIA' if has_nvidia else 'Integrated (Mesa)' }}"
          - ""
          - "{% if is_gnome %}âœ… BLURT - GNOME Shell Extension (RECOMMENDED){% endif %}"
          - "{% if is_gnome %}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€{% endif %}"
          - "{% if is_gnome %}   â€¢ Keyboard shortcut: CTRL+ALT+A (default){% endif %}"
          - "{% if is_gnome %}   â€¢ Works in ANY text input field{% endif %}"
          - "{% if is_gnome %}   â€¢ Fully offline - no cloud services{% endif %}"
          - "{% if is_gnome %}   â€¢ Backend: whisperfile ({{ whisper_model }} model){% endif %}"
          - "{% if is_gnome %}   â€¢ Extension location: ~/.local/share/gnome-shell/extensions/{% endif %}"
          - "{% if is_gnome %}   â€¢ NOT ENABLED YET - see Quick Start below{% endif %}"
          - "{% if is_gnome %}{% endif %}"
          - "âœ… SONORI - Wayland Speech-to-Text App"
          - "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          - "   â€¢ Version: v{{ sonori_version }}"
          - "{% if is_gnome %}   â€¢ GNOME users: Use CLI mode only{% endif %}"
          - "{% if is_gnome %}   â€¢ Command: sonori --cli{% endif %}"
          - "{% if is_gnome %}   â€¢ GUI overlay requires wlr-layer-shell (not in GNOME){% endif %}"
          - "{% if not is_gnome %}   â€¢ Command: sonori{% endif %}"
          - "{% if not is_gnome %}   â€¢ GUI overlay: Transparent floating window{% endif %}"
          - "   â€¢ GPU acceleration: Vulkan{% if has_nvidia %} (NVIDIA){% endif %}"
          - "   â€¢ Location: /usr/local/bin/sonori"
          - ""
          - "ğŸ“¦ Dependencies Installed:"
          - "{% if is_gnome %}   â€¢ whisperfile (portable llamafile in ~/.local/bin){% endif %}"
          - "   â€¢ Audio: pipewire, sox"
          - "   â€¢ Clipboard: xsel (X11), wl-copy (Wayland)"
          - "   â€¢ GPU: Vulkan runtime{% if has_nvidia %} + NVIDIA drivers{% endif %}"
          - ""
          - "ğŸ¤ Quick Start (Blurt):"
          - "{% if is_gnome %}   1. REQUIRED: Restart GNOME Shell first{% endif %}"
          - "{% if is_gnome %}      â†’ Press ALT+F2, type 'r', press ENTER{% endif %}"
          - "{% if is_gnome %}      â†’ Or log out and log back in{% endif %}"
          - "{% if is_gnome %}   2. Test manually first (optional but recommended):{% endif %}"
          - "{% if is_gnome %}      â†’ Run: ~/.local/bin/wsi -d{% endif %}"
          - "{% if is_gnome %}      â†’ Speak for 2-3 seconds, then stop and wait{% endif %}"
          - "{% if is_gnome %}      â†’ Should show dependencies, recording, and transcribed text{% endif %}"
          - "{% if is_gnome %}   3. Enable Blurt extension:{% endif %}"
          - "{% if is_gnome %}      â†’ Open Extensions app (search in Activities){% endif %}"
          - "{% if is_gnome %}      â†’ Toggle Blurt ON{% endif %}"
          - "{% if is_gnome %}      â†’ Or run: gnome-extensions enable blurt@quantiusbenignus.local{% endif %}"
          - "{% if is_gnome %}   4. Click any text field{% endif %}"
          - "{% if is_gnome %}   5. Press CTRL+ALT+A and speak{% endif %}"
          - "{% if is_gnome %}   6. Text appears automatically when you stop speaking{% endif %}"
          - "{% if not is_gnome %}   â€¢ Launch: sonori (from Applications or terminal){% endif %}"
          - "{% if not is_gnome %}   â€¢ Floating overlay will appear{% endif %}"
          - ""
          - "âš™ï¸  Model Downloads:"
          - "{% if is_gnome %}   â€¢ Blurt: Embedded in whisperfile ({{ whisper_model }}){% endif %}"
          - "   â€¢ Sonori: Downloads small.en model on first run (~500MB)"
          - ""
          - "ğŸ” GPU Verification:"
          - "   â€¢ vulkaninfo | grep -i 'device name'"
          - "{% if has_nvidia %}   â€¢ nvidia-smi{% endif %}"
          - "{% if has_nvidia %}   â€¢ Ensure NVIDIA Vulkan drivers: play-nvidia.yml{% endif %}"
          - ""
          - "âš™ï¸  Configuration Options:"
          - "{% if is_gnome %}   â€¢ Change Blurt model: Set whisper_model_size in host_vars/localhost.yml{% endif %}"
          - "{% if is_gnome %}     Options: tiny.en (87MB), small.en (497MB), medium.en (1.83GB), large-v3 (3.39GB){% endif %}"
          - "{% if is_gnome %}     Default: medium.en{% endif %}"
          - ""
          - "ğŸ“š More Information:"
          - "   â€¢ Blurt: https://github.com/QuantiusBenignus/blurt"
          - "   â€¢ Sonori: https://github.com/0xPD33/sonori"
          - "   â€¢ Whisper.cpp: https://github.com/ggml-org/whisper.cpp"
          - ""
          - "ğŸ’¡ Troubleshooting:"
          - "{% if is_gnome %}   â€¢ Blurt not working? Test manually: ~/.local/bin/wsi -d{% endif %}"
          - "{% if is_gnome %}   â€¢ Debug mode shows: dependencies, versions, full error output{% endif %}"
          - "{% if is_gnome %}   â€¢ Check GNOME Shell logs: journalctl /usr/bin/gnome-shell --since '5 min ago' | grep -i blurt{% endif %}"
          - "{% if is_gnome %}   â€¢ Test whisperfile: ~/.local/bin/whisperfile --help{% endif %}"
          - "   â€¢ Sonori overlay crash on GNOME? Use: sonori --cli"
          - "   â€¢ Missing Sonori models? Check ~/.cache/sonori/"
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
