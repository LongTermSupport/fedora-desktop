#!/usr/bin/env python3
"""
Git Account Helper - Detect GitHub accounts from git remotes and manage identities.

This script is part of the git account management system. It provides CLI commands
for detecting which GitHub account a repository belongs to based on remote URLs,
caching email addresses, and providing repository information.

Commands:
  detect [repo-path]     - Detect account alias from git remote URL
  email <username>       - Get email for username (with caching)
  info [repo-path]       - Output JSON with full repository info

Configuration:
  Accounts: ~/.config/git-account-helper/accounts.json
  Cache: ~/.cache/git-account-helper/

Generated by Ansible - DO NOT EDIT MANUALLY
"""

import sys
import json
import re
import subprocess
from pathlib import Path
from typing import Optional, Dict, Any


class GitAccountHelper:
    """Main helper class for git account detection and management."""

    def __init__(self):
        """Initialize with account configuration."""
        # Embedded account configuration from Ansible
        self.accounts = {{ github_accounts | to_json }}

        # Reverse mapping: username -> alias
        self.username_to_alias = {v: k for k, v in self.accounts.items()}

        # Cache directory
        self.cache_dir = Path.home() / '.cache' / 'git-account-helper'
        self.cache_dir.mkdir(parents=True, exist_ok=True)

    def get_git_remote_url(self, repo_path: Optional[str] = None) -> Optional[str]:
        """
        Get the git remote URL for a repository.

        Tries 'origin' first, then falls back to first available remote.

        Args:
            repo_path: Path to git repository (default: current directory)

        Returns:
            Remote URL or None if not found
        """
        git_args = ['git']
        if repo_path:
            git_args.extend(['-C', repo_path])

        try:
            # Try origin first
            result = subprocess.run(
                git_args + ['config', '--get', 'remote.origin.url'],
                capture_output=True,
                text=True,
                check=False
            )
            if result.returncode == 0 and result.stdout.strip():
                return result.stdout.strip()

            # Fallback: get first available remote
            result = subprocess.run(
                git_args + ['remote'],
                capture_output=True,
                text=True,
                check=False
            )
            if result.returncode == 0 and result.stdout.strip():
                first_remote = result.stdout.strip().split('\n')[0]
                result = subprocess.run(
                    git_args + ['config', '--get', f'remote.{first_remote}.url'],
                    capture_output=True,
                    text=True,
                    check=False
                )
                if result.returncode == 0 and result.stdout.strip():
                    return result.stdout.strip()

            return None

        except Exception as e:
            print(f"Error getting remote URL: {e}", file=sys.stderr)
            return None

    def detect_account_from_url(self, url: str) -> Optional[str]:
        """
        Detect account alias from a git remote URL.

        Looks for pattern: git@github.com-ALIAS: in SSH URLs

        Args:
            url: Git remote URL

        Returns:
            Account alias or None if not detected
        """
        # Pattern: git@github.com-ALIAS:owner/repo.git
        # Match both with and without .git suffix
        pattern = r'git@github\.com-([^:]+):'
        match = re.search(pattern, url)

        if match:
            alias = match.group(1)
            # Verify this is a known account
            if alias in self.accounts:
                return alias
            else:
                print(f"Warning: Unknown account alias '{alias}' in URL", file=sys.stderr)
                return None

        # Check for standard github.com URL (not account-specific)
        if 'github.com' in url and 'github.com-' not in url:
            print("Error: Repository uses standard github.com remote", file=sys.stderr)
            print("Cannot auto-detect account. Use git-<alias> commands or reconfigure remote.", file=sys.stderr)
            return None

        # Not a GitHub SSH URL with account - might be GitLab, HTTPS, etc.
        return None

    def get_email_cached(self, username: str) -> str:
        """
        Get email for a GitHub username with caching.

        Strategy:
        1. Check cache file first
        2. Try gh api /users/{username}
        3. Fallback to {username}@users.noreply.github.com

        Args:
            username: GitHub username

        Returns:
            Email address
        """
        cache_file = self.cache_dir / f'{username}.email'

        # Check cache
        if cache_file.exists():
            try:
                return cache_file.read_text().strip()
            except Exception as e:
                print(f"Warning: Error reading cache for {username}: {e}", file=sys.stderr)

        # Try gh API
        email = self.fetch_email_from_api(username)

        # Fallback to noreply
        if not email:
            email = f'{username}@users.noreply.github.com'

        # Cache the result
        try:
            cache_file.write_text(email)
        except Exception as e:
            print(f"Warning: Error caching email for {username}: {e}", file=sys.stderr)

        return email

    def fetch_email_from_api(self, username: str) -> Optional[str]:
        """
        Fetch email from GitHub API using gh CLI.

        Args:
            username: GitHub username

        Returns:
            Email address or None if not available
        """
        try:
            result = subprocess.run(
                ['gh', 'api', f'/users/{username}', '--jq', '.email'],
                capture_output=True,
                text=True,
                check=False,
                timeout=5
            )

            if result.returncode == 0 and result.stdout.strip():
                email = result.stdout.strip()
                # gh returns "null" as string if email is not public
                if email and email != 'null' and '@' in email:
                    return email

            return None

        except subprocess.TimeoutExpired:
            print(f"Warning: Timeout fetching email for {username}", file=sys.stderr)
            return None
        except FileNotFoundError:
            print("Warning: gh CLI not found, using fallback email", file=sys.stderr)
            return None
        except Exception as e:
            print(f"Warning: Error fetching email for {username}: {e}", file=sys.stderr)
            return None

    def cmd_detect(self, repo_path: Optional[str] = None) -> int:
        """
        Detect command: Output account alias or exit with error.

        Args:
            repo_path: Path to repository (default: current directory)

        Returns:
            0 on success, 1 on failure
        """
        url = self.get_git_remote_url(repo_path)

        if not url:
            print("Error: No git remote found", file=sys.stderr)
            print("Use git-<alias> commands for repos without remotes", file=sys.stderr)
            return 1

        alias = self.detect_account_from_url(url)

        if not alias:
            # Error messages already printed by detect_account_from_url
            return 1

        print(alias)
        return 0

    def cmd_email(self, username: str) -> int:
        """
        Email command: Output email address for username.

        Args:
            username: GitHub username

        Returns:
            0 on success, 1 on failure
        """
        if not username:
            print("Error: Username required", file=sys.stderr)
            print("Usage: git-account-helper email <username>", file=sys.stderr)
            return 1

        email = self.get_email_cached(username)
        print(email)
        return 0

    def cmd_info(self, repo_path: Optional[str] = None) -> int:
        """
        Info command: Output JSON with full repository information.

        Args:
            repo_path: Path to repository (default: current directory)

        Returns:
            0 on success, 1 on failure
        """
        info: Dict[str, Any] = {
            'remote_url': None,
            'alias': None,
            'username': None,
            'email': None,
            'ssh_key': None,
            'error': None
        }

        url = self.get_git_remote_url(repo_path)

        if not url:
            info['error'] = 'No git remote found'
            print(json.dumps(info, indent=2))
            return 1

        info['remote_url'] = url

        alias = self.detect_account_from_url(url)

        if not alias:
            info['error'] = 'Could not detect account from remote URL'
            print(json.dumps(info, indent=2))
            return 1

        info['alias'] = alias

        # Get username for this alias
        username = self.accounts.get(alias)
        if username:
            info['username'] = username
            info['email'] = self.get_email_cached(username)
            info['ssh_key'] = f'~/.ssh/github_{alias}'

        print(json.dumps(info, indent=2))
        return 0

    def cmd_list_accounts(self) -> int:
        """
        List all configured accounts.

        Returns:
            0 on success
        """
        print(json.dumps(self.accounts, indent=2))
        return 0


def main():
    """Main entry point."""
    if len(sys.argv) < 2:
        print("Git Account Helper", file=sys.stderr)
        print("", file=sys.stderr)
        print("Usage:", file=sys.stderr)
        print("  git-account-helper detect [repo-path]", file=sys.stderr)
        print("  git-account-helper email <username>", file=sys.stderr)
        print("  git-account-helper info [repo-path]", file=sys.stderr)
        print("  git-account-helper list", file=sys.stderr)
        return 1

    helper = GitAccountHelper()
    command = sys.argv[1]

    if command == 'detect':
        repo_path = sys.argv[2] if len(sys.argv) > 2 else None
        return helper.cmd_detect(repo_path)

    elif command == 'email':
        if len(sys.argv) < 3:
            print("Error: Username required", file=sys.stderr)
            print("Usage: git-account-helper email <username>", file=sys.stderr)
            return 1
        return helper.cmd_email(sys.argv[2])

    elif command == 'info':
        repo_path = sys.argv[2] if len(sys.argv) > 2 else None
        return helper.cmd_info(repo_path)

    elif command == 'list':
        return helper.cmd_list_accounts()

    else:
        print(f"Error: Unknown command '{command}'", file=sys.stderr)
        print("Valid commands: detect, email, info, list", file=sys.stderr)
        return 1


if __name__ == '__main__':
    sys.exit(main())
