#!/usr/bin/bash
# gshell-nested - Launch nested GNOME Shell for extension testing
# Automatically calculates window size slightly smaller than current screen

set -e

# Default: 85% of screen size
SCALE=0.85
WIDTH=""
HEIGHT=""

usage() {
    cat <<EOF
Usage: gshell-nested [OPTIONS]

Launch nested GNOME Shell in a window for extension testing.

Options:
  --res WIDTH HEIGHT    Override window size (e.g., --res 1280 720)
  --fullscreen         Use full screen size (100%)
  --scale PERCENT      Percentage of screen size (default: 85)
  -h, --help           Show this help

Examples:
  gshell-nested                    # Auto-detect at 85% of screen
  gshell-nested --res 1280 720     # Fixed 1280x720 window
  gshell-nested --fullscreen       # Use full screen size
  gshell-nested --scale 90         # 90% of screen size

Notes:
  - Extensions from ~/.local/share/gnome-shell/extensions/ are available
  - Press CTRL+Q or close window to exit nested mode
  - Some features may behave differently than real session
  - Clipboard and notifications work within nested instance
EOF
}

# Parse arguments
while [ $# -gt 0 ]; do
    case "$1" in
        --res)
            WIDTH="$2"
            HEIGHT="$3"
            shift 3
            ;;
        --fullscreen)
            SCALE=1.0
            shift
            ;;
        --scale)
            SCALE=$(echo "scale=2; $2 / 100" | bc)
            shift 2
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            echo "Error: Unknown option $1" >&2
            usage >&2
            exit 1
            ;;
    esac
done

# If width/height not specified, use default
if [ -z "$WIDTH" ] || [ -z "$HEIGHT" ]; then
    WIDTH=1920
    HEIGHT=1080
    echo "Using default resolution: ${WIDTH}x${HEIGHT}"

    # Calculate scaled size
    if [ "$SCALE" != "1.0" ]; then
        ORIG_WIDTH=$WIDTH
        ORIG_HEIGHT=$HEIGHT
        WIDTH=$(echo "$WIDTH * $SCALE" | bc | cut -d'.' -f1)
        HEIGHT=$(echo "$HEIGHT * $SCALE" | bc | cut -d'.' -f1)
        PERCENT=$(echo "$SCALE * 100" | bc | cut -d'.' -f1)
        echo "Scaling to ${PERCENT}%: ${WIDTH}x${HEIGHT} (from ${ORIG_WIDTH}x${ORIG_HEIGHT})"
    fi
fi

echo "Starting nested GNOME Shell at ${WIDTH}x${HEIGHT}..."
echo "Press CTRL+Q, CTRL+C, or close window to exit"
echo ""

# Trap signals for clean exit
cleanup() {
    echo ""
    echo "Shutting down nested GNOME Shell..."
    # Kill the nested shell if still running
    if [ -n "$GSHELL_PID" ] && kill -0 "$GSHELL_PID" 2>/dev/null; then
        kill "$GSHELL_PID" 2>/dev/null
        wait "$GSHELL_PID" 2>/dev/null
    fi
    exit 0
}

trap cleanup SIGINT SIGTERM

# Kill any existing nested GNOME Shell sessions (but NOT the main session)
echo "Checking for existing nested GNOME Shell sessions..."
NESTED_PIDS=$(ps aux | grep 'gnome-shell --nested --wayland' | grep -v grep | awk '{print $2}')
if [ -n "$NESTED_PIDS" ]; then
    echo "Found existing nested sessions, killing: $NESTED_PIDS"
    echo "$NESTED_PIDS" | xargs kill 2>/dev/null || true
    sleep 1
fi

# Set resolution and launch nested GNOME Shell
MUTTER_DEBUG_DUMMY_MODE_SPECS="${WIDTH}x${HEIGHT}" \
    dbus-run-session -- gnome-shell --nested --wayland &
GSHELL_PID=$!

# Wait for process to exit
wait "$GSHELL_PID"
EXIT_CODE=$?

echo "Nested GNOME Shell exited with code $EXIT_CODE"
exit $EXIT_CODE
