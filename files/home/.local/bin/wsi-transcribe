#!/usr/bin/bash
# wsi-transcribe - Transcribe audio file with whisper
# Called by speech-to-text GNOME extension
# Usage: wsi-transcribe <audio-file>

set -e

AUDIO_FILE="$1"

if [ -z "$AUDIO_FILE" ] || [ ! -f "$AUDIO_FILE" ]; then
    echo "Error: Audio file not found: $AUDIO_FILE" >&2
    exit 1
fi

WHISPERFILE="transcribe"
NTHR=$(( $(getconf _NPROCESSORS_ONLN) / 2 ))

# Resample to 16kHz (whisper requirement)
RESAMPLED="${AUDIO_FILE}.16k.wav"
sox "$AUDIO_FILE" "$RESAMPLED" rate 16k 2>/dev/null

# Check duration and pad if needed (whisper requires min 1 second)
audio_duration=$(soxi -D "$RESAMPLED" 2>/dev/null | cut -d. -f1)
if [ -n "$audio_duration" ] && [ "$audio_duration" -lt 1 ]; then
    sox "$RESAMPLED" "${RESAMPLED}.padded" pad 0 1 2>/dev/null
    mv "${RESAMPLED}.padded" "$RESAMPLED"
fi

# Transcribe with whisperfile
str="$("$WHISPERFILE" -t "$NTHR" -nt -f "$RESAMPLED" 2>/dev/null)"

# Clean up
rm -f "$RESAMPLED"

# Post-process transcription
# Remove non-speech artifacts: (wind blowing), [background noise], etc.
str="${str/\(*\)}"
str="${str/\[*\]}"

# Remove leading newlines
str="${str#$'\n'}"
str="${str#$'\n'}"

# Remove leading whitespace and capitalize
str="${str##+([[:space:]])}"
str="${str^}"

# Output transcribed text (or empty if nothing detected)
echo "$str"
