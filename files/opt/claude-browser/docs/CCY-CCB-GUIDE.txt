================================================================================
CCY / CCB SYSTEM GUIDE
================================================================================

This guide is for Claude agents running inside a CCY or CCB container.
It explains how the container system works, how to customise it, and where
everything lives.

TABLE OF CONTENTS
-----------------
1. What is CCY / CCB?
2. What is in this container?
3. Dockerfile Fallback Priority (READ THIS)
4. How to add tools to this container
5. The ARG BASE_IMAGE pattern (shared Dockerfiles)
6. Rebuilding and updating
7. File locations reference
8. How to help the user set up a new project


================================================================================
1. WHAT IS CCY / CCB?
================================================================================

ccy = "Claude Code YOLO" - Claude Code running in Docker with
      --dangerously-skip-permissions so the agent can act without prompts.
      General-purpose development mode.

ccb = "Claude Code Browser" - everything in ccy PLUS:
      - Playwright MCP (browser_* tools)
      - agent-browser CLI (token-efficient multi-page automation)
      - chrome-ws CLI (Chrome DevTools Protocol)
      - Chromium, Firefox, WebKit browsers
      - Headed browser windows on the user's desktop (Wayland/X11)

Both are launched from the host by running `ccy` or `ccb` in a project
directory. The container mounts /workspace (the project), provides a token
for Claude Code auth, and launches Claude Code.

Both use the same long-lived OAuth token pool (~/.claude-tokens/ccy/tokens/).

State lives in /workspace/.claude/ (project-local, gitignored for runtime
state but custom configs like Dockerfiles and agents are tracked).


================================================================================
2. WHAT IS IN THIS CONTAINER?
================================================================================

BASE TOOLS (both ccy and ccb):
  git, gh (GitHub CLI), ssh, ripgrep, jq, yq, vim, nano, htop, curl, wget
  Node.js 20, npm, Python 3, pip
  Claude Code (latest version, auto-updated)
  tini (PID 1 signal handling)

CCB ADDITIONALLY:
  Playwright MCP server (@playwright/mcp)
  Playwright browsers: Chrome, Chromium, Firefox, WebKit
  agent-browser CLI (token-efficient browser automation, 93% context reduction)
  chrome-ws CLI (Chrome DevTools Protocol)
  Wayland/X11 display support (browser windows appear on host desktop)

PROJECT-SPECIFIC TOOLS (if a custom Dockerfile exists for this project):
  Whatever the project's .claude/ccy/Dockerfile installs.
  Run `cat /workspace/.claude/ccy/Dockerfile` to see what was added.

DOCUMENTATION (this container):
  CCY/CCB system guide:    THIS FILE
  Dockerfile guide:        See section 4 below for the path


================================================================================
3. DOCKERFILE FALLBACK PRIORITY (READ THIS)
================================================================================

When ccy or ccb starts, it looks for a custom Dockerfile in this order:

  FOR CCY:
    1. .claude/ccy/Dockerfile   → builds claude-yolo:<project-name>
    2. (none)                   → uses claude-yolo:latest base only

  FOR CCB:
    1. .claude/ccb/Dockerfile   → builds claude-browser:<project-name>
    2. .claude/ccy/Dockerfile   → builds claude-browser:<project-name>
                                   (same file, but with BASE_IMAGE overridden
                                    to claude-browser:latest automatically)
    3. (none)                   → uses claude-browser:latest base only

KEY INSIGHT: Most projects only need .claude/ccy/Dockerfile.
  - ccy uses it with claude-yolo:latest as the base
  - ccb uses the same file with claude-browser:latest as the base
  - The result: project tools + browser tools in one ccb container

The only reason to create a separate .claude/ccb/Dockerfile is when you need
tools that are CCB-specific (rare). If it exists, ccb uses it exclusively.


================================================================================
4. HOW TO ADD TOOLS TO THIS CONTAINER
================================================================================

Tell the user to create/edit .claude/ccy/Dockerfile in the project root.
Use the ARG BASE_IMAGE pattern (section 5) so it works for both ccy and ccb.

The user can do this with:
  ccy --custom-docker   # AI-guided: Claude investigates project, proposes tools
  ccy --custom          # Template-based: pick from Ansible/Go/generic templates
  ccb --custom-docker   # Same but for ccb context

After editing, the user rebuilds with:
  ccy --rebuild         # Rebuilds ccy project image
  ccb --rebuild         # Rebuilds ccb project image

The container auto-rebuilds when the Dockerfile hash changes on next launch.

For detailed Dockerfile best practices (cache mounts, layer ordering, etc.):
  CCY container: cat /opt/claude-yolo/docs/CUSTOM-DOCKERFILES.txt
  CCB container: cat /opt/claude-browser/docs/CUSTOM-DOCKERFILES.txt


================================================================================
5. THE ARG BASE_IMAGE PATTERN (SHARED DOCKERFILES)
================================================================================

To make one Dockerfile work for both ccy and ccb, use this pattern:

  ARG BASE_IMAGE=claude-yolo:latest
  FROM ${BASE_IMAGE}

  # Project-specific tools (same for ccy and ccb)
  RUN apt-get update && apt-get install -y --no-install-recommends \
      your-tools-here \
      && rm -rf /var/lib/apt/lists/*

When ccy builds this:  uses default BASE_IMAGE=claude-yolo:latest
When ccb builds this:  automatically passes --build-arg BASE_IMAGE=claude-browser:latest

The resulting images:
  claude-yolo:<project-name>   = project tools on top of ccy base
  claude-browser:<project-name> = project tools on top of ccb base (with browsers)

WITHOUT the ARG BASE_IMAGE pattern (hardcoded FROM):
  FROM claude-yolo:latest  ← ccb can't override this, so ccb won't get project tools
                             when using the shared Dockerfile fallback.

If you see a project Dockerfile that uses hardcoded FROM, recommend updating it.


================================================================================
6. REBUILDING AND UPDATING
================================================================================

Rebuild after Dockerfile changes (run on HOST, not in container):
  ccy --rebuild    # Forces rebuild of ccy project image
  ccb --rebuild    # Forces rebuild of ccb project image

Auto-rebuild triggers:
  - Dockerfile hash changed (detected on startup)
  - Base image version bumped (detected on startup)
  - --rebuild flag passed explicitly

Version checking:
  - Container version checked against REQUIRED_CONTAINER_VERSION in wrapper
  - Mismatch triggers automatic rebuild
  - Version cache: ~/.cache/claude-yolo-version-check / claude-browser-version-check

Update Claude Code inside container:
  ccy --rebuild    # Rebuilds with latest @anthropic-ai/claude-code from npm

If a Dockerfile build fails, ccy shows an AI-assisted fix prompt:
  ccy --disable-custom-docker --prompt "$(cat /tmp/ccy-fix-dockerfile-*.txt)"


================================================================================
7. FILE LOCATIONS REFERENCE
================================================================================

INSIDE THE CONTAINER:
  /workspace/                          Project files (host mount, read/write)
  /workspace/.claude/                  Claude Code project state
  /workspace/.claude/ccy/Dockerfile    Project CCY/CCB Dockerfile (if exists)
  /workspace/.claude/ccb/Dockerfile    Project CCB-specific Dockerfile (if exists)
  /root/.claude/                       → symlinked to /workspace/.claude/ccy/
  /opt/claude-yolo/                    CCY system files (ccy container only)
  /opt/claude-yolo/docs/               CCY documentation (ccy container only)
  /opt/claude-browser/                 CCB system files (ccb container only)
  /opt/claude-browser/docs/            CCB documentation (ccb container only)
  /opt/claude-browser/mcp_servers.json Playwright MCP config (ccb only)

ON THE HOST (not accessible from container):
  /var/local/claude-yolo/claude-yolo   CCY wrapper script
  /var/local/claude-yolo/claude-browser CCB wrapper script
  /opt/claude-yolo/Dockerfile          CCY base Dockerfile
  /opt/claude-browser/Dockerfile.browser CCB base Dockerfile
  ~/.claude-tokens/ccy/tokens/         OAuth token pool (both ccy and ccb)
  ~/.cache/claude-yolo-version-check   Version check cache

GIT-TRACKED PROJECT FILES:
  .claude/ccy/Dockerfile   Custom container config (TRACK THIS)
  .claude/ccb/Dockerfile   CCB-specific config (TRACK THIS if it exists)
  .claude/agents/          Custom agents
  .claude/hooks/           Git hooks for Claude Code
  .claude/commands/        Slash commands

NOT TRACKED (gitignored runtime state):
  .claude/ccy/             Session state, history, databases
  .claude/settings.json    User preferences


================================================================================
8. HOW TO HELP THE USER SET UP A NEW PROJECT
================================================================================

If a user asks you to set up CCY/CCB for a project, or if you notice the
container is missing tools the project needs:

1. EXPLAIN the situation:
   "This container is running from the base claude-yolo:latest image.
   I can see this project uses [X tools] that aren't in the container.
   We should create a custom Dockerfile to add them permanently."

2. OFFER to create the Dockerfile:
   "I can help you create .claude/ccy/Dockerfile. Shall I investigate the
   project and propose what to install?"

3. CREATE the Dockerfile using ARG BASE_IMAGE pattern (section 5).
   File location: /workspace/.claude/ccy/Dockerfile

4. INSTRUCT the user to rebuild (they do this on the HOST):
   "Exit this session (Ctrl+D), then run: ccy --rebuild && ccy"
   Or for CCB: "Exit, then run: ccb --rebuild && ccb"

5. COMMIT the Dockerfile:
   "Add .claude/ccy/Dockerfile to git so the whole team gets it."

The user can also run `ccy --custom-docker` from the host for a guided
creation workflow that doesn't require an active session.

================================================================================
END OF GUIDE
================================================================================
