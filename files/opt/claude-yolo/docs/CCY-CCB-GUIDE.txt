================================================================================
CCY SYSTEM GUIDE
================================================================================

This guide is for Claude agents running inside a CCY container.
It explains how the container system works, how to customise it, and where
everything lives.

TABLE OF CONTENTS
-----------------
1. What is CCY?
2. What is in this container?
3. Dockerfile fallback priority (READ THIS)
4. How to add tools to this container
5. Rebuilding and updating
6. File locations reference
7. How to help the user set up a new project


================================================================================
1. WHAT IS CCY?
================================================================================

ccy = "Claude Code YOLO" - Claude Code running in a container with
      --dangerously-skip-permissions so the agent can act without prompts.
      General-purpose development mode with browser automation included.

Launched from the host by running `ccy` in a project directory. The container
mounts /workspace (the project), provides a token for Claude Code auth, and
launches Claude Code.

State lives in /workspace/.claude/ (project-local, gitignored for runtime
state but custom configs like Dockerfiles and agents are tracked).


================================================================================
2. WHAT IS IN THIS CONTAINER?
================================================================================

BASE TOOLS:
  git, gh (GitHub CLI), ssh, ripgrep, jq, yq, vim, nano, htop, curl, wget
  Node.js 20, npm, Python 3, pip
  Claude Code (latest version, auto-updated)
  tini (PID 1 signal handling)

BROWSER AUTOMATION:
  agent-browser CLI (token-efficient Chromium automation)
  Chromium (system install with Wayland/X11 support)
  Browser windows appear on host desktop when Wayland is available

PROJECT-SPECIFIC TOOLS (if a custom Dockerfile exists for this project):
  Whatever the project's .claude/ccy/Dockerfile installs.
  Run `cat /workspace/.claude/ccy/Dockerfile` to see what was added.

DOCUMENTATION (this container):
  CCY system guide:     cat /opt/claude-yolo/docs/CCY-CCB-GUIDE.txt
  Dockerfile guide:     cat /opt/claude-yolo/docs/CUSTOM-DOCKERFILES.txt
  Skills:               ls /root/.claude/skills/


================================================================================
3. DOCKERFILE FALLBACK PRIORITY (READ THIS)
================================================================================

When ccy starts, it looks for a custom Dockerfile in this order:

  1. .claude/ccy/Dockerfile   → builds claude-yolo:<project-name>
  2. (none)                   → uses claude-yolo:latest base only

Create .claude/ccy/Dockerfile to add project-specific tools permanently.
See section 4 for how to create one.


================================================================================
4. HOW TO ADD TOOLS TO THIS CONTAINER
================================================================================

Tell the user to create/edit .claude/ccy/Dockerfile in the project root.

The user can do this with:
  ccy --custom-docker   # AI-guided: Claude investigates project, proposes tools
  ccy --custom          # Template-based: pick from Ansible/Go/generic templates

After editing, the user rebuilds with:
  ccy --rebuild         # Rebuilds ccy project image

The container auto-rebuilds when the Dockerfile hash changes on next launch.

For detailed Dockerfile best practices (cache mounts, layer ordering, etc.):
  cat /opt/claude-yolo/docs/CUSTOM-DOCKERFILES.txt


================================================================================
5. REBUILDING AND UPDATING
================================================================================

Rebuild after Dockerfile changes (run on HOST, not in container):
  ccy --rebuild    # Forces rebuild of ccy project image

Auto-rebuild triggers:
  - Dockerfile hash changed (detected on startup)
  - Base image version bumped (detected on startup)
  - --rebuild flag passed explicitly

Version checking:
  - Container version checked against REQUIRED_CONTAINER_VERSION in wrapper
  - Mismatch triggers automatic rebuild
  - Version cache: ~/.cache/claude-yolo-version-check

Update Claude Code inside container:
  ccy --rebuild    # Rebuilds with latest @anthropic-ai/claude-code from npm

If a Dockerfile build fails, ccy shows an AI-assisted fix prompt:
  ccy --disable-custom-docker --prompt "$(cat /tmp/ccy-fix-dockerfile-*.txt)"


================================================================================
6. FILE LOCATIONS REFERENCE
================================================================================

INSIDE THE CONTAINER:
  /workspace/                          Project files (host mount, read/write)
  /workspace/.claude/                  Claude Code project state
  /workspace/.claude/ccy/Dockerfile    Project Dockerfile (if exists)
  /root/.claude/                       → symlinked to /workspace/.claude/ccy/
  /root/.claude/skills/                Built-in skills (e.g. browsing/)
  /opt/claude-yolo/                    CCY system files
  /opt/claude-yolo/docs/               CCY documentation
  /root/.agent-browser/config.json     agent-browser Chromium config

ON THE HOST (not accessible from container):
  /var/local/claude-yolo/claude-yolo   CCY wrapper script
  /opt/claude-yolo/Dockerfile          CCY base Dockerfile
  ~/.claude-tokens/ccy/tokens/         OAuth token pool
  ~/.cache/claude-yolo-version-check   Version check cache

GIT-TRACKED PROJECT FILES:
  .claude/ccy/Dockerfile   Custom container config (TRACK THIS)
  .claude/agents/          Custom agents
  .claude/hooks/           Git hooks for Claude Code
  .claude/commands/        Slash commands

NOT TRACKED (gitignored runtime state):
  .claude/ccy/             Session state, history, databases
  .claude/settings.json    User preferences


================================================================================
7. HOW TO HELP THE USER SET UP A NEW PROJECT
================================================================================

If a user asks you to set up CCY for a project, or if you notice the
container is missing tools the project needs:

1. EXPLAIN the situation:
   "This container is running from the base claude-yolo:latest image.
   I can see this project uses [X tools] that aren't in the container.
   We should create a custom Dockerfile to add them permanently."

2. OFFER to create the Dockerfile:
   "I can help you create .claude/ccy/Dockerfile. Shall I investigate the
   project and propose what to install?"

3. CREATE the Dockerfile at /workspace/.claude/ccy/Dockerfile.

4. INSTRUCT the user to rebuild (they do this on the HOST):
   "Exit this session (Ctrl+D), then run: ccy --rebuild && ccy"

5. COMMIT the Dockerfile:
   "Add .claude/ccy/Dockerfile to git so the whole team gets it."

The user can also run `ccy --custom-docker` from the host for a guided
creation workflow that doesn't require an active session.

================================================================================
END OF GUIDE
================================================================================
