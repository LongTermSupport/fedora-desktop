#!/bin/bash
# Claude Code YOLO Mode Wrapper
# Runs Claude Code with --dangerously-skip-permissions in isolated Docker container

set -e

IMAGE_NAME="claude-yolo:latest"
DOCKERFILE_DIR="/opt/claude-yolo"
VERSION_CACHE="$HOME/.cache/claude-yolo-version"
CACHE_DURATION=3600  # 1 hour in seconds

# Show help if requested
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    cat << 'EOF'
Claude Code YOLO Mode (ccy) - Container-based execution with --dangerously-skip-permissions

Usage: ccy [OPTIONS] [CLAUDE_ARGS...]

Wrapper Options:
  --rebuild         Force rebuild of container image (clears cache)
  --debug           Enable debug output (bash -x)
  --ssh-key PATH    SSH private key to mount (can be specified multiple times)
  --help, -h        Show this help message

All other arguments are passed directly to Claude Code with --dangerously-skip-permissions

Features:
  • Runs in isolated Docker container with git/gh
  • Auto-updates Claude Code (cached for 1 hour)
  • Mounts current directory as /workspace
  • Files created have correct host user ownership
  • Shares Claude auth, SSH keys, and gh config (read-only)

Security:
  ⚠  YOLO mode bypasses all permission checks
  ✓  Container isolation prevents unintended host access
  ✓  Cannot run as root user (safety check)

Examples:
  ccy                           # Start Claude Code YOLO mode
  ccy --rebuild                 # Rebuild container and start
  ccy "implement feature X"     # Start with specific task

EOF

    # Check if container image exists to show Claude Code help
    if docker image inspect "$IMAGE_NAME" &> /dev/null 2>&1; then
        echo "════════════════════════════════════════════════════════════════════════════════"
        echo "Claude Code Help (from container):"
        echo "════════════════════════════════════════════════════════════════════════════════"
        echo ""
        # Run claude --help in container to show actual Claude Code options
        docker run --rm --entrypoint claude "$IMAGE_NAME" --help 2>/dev/null || echo "Note: Container exists but Claude Code help unavailable"
    else
        echo "════════════════════════════════════════════════════════════════════════════════"
        echo "Claude Code Help:"
        echo "════════════════════════════════════════════════════════════════════════════════"
        echo ""
        echo "Container image not built yet. Run 'ccy --rebuild' first to build the container,"
        echo "then run 'ccy --help' again to see Claude Code options."
    fi

    exit 0
fi

# Check for wrapper flags
FORCE_REBUILD=false
DEBUG_MODE=false
SSH_KEYS=()
CLAUDE_ARGS=()
NEXT_IS_SSH_KEY=false

for arg in "$@"; do
    if [ "$NEXT_IS_SSH_KEY" = true ]; then
        if [ ! -f "$arg" ]; then
            echo "ERROR: SSH key not found: $arg"
            exit 1
        fi
        SSH_KEYS+=("$arg")
        NEXT_IS_SSH_KEY=false
    elif [ "$arg" = "--rebuild" ]; then
        FORCE_REBUILD=true
    elif [ "$arg" = "--debug" ]; then
        DEBUG_MODE=true
        set -x
    elif [ "$arg" = "--ssh-key" ]; then
        NEXT_IS_SSH_KEY=true
    else
        CLAUDE_ARGS+=("$arg")
    fi
done

# Discover github_ SSH keys if no --ssh-key was passed
# These keys are managed by play-github-cli-multi.yml which creates keys with
# the pattern ~/.ssh/github_<alias> for each configured GitHub account.
# See: playbooks/imports/optional/common/play-github-cli-multi.yml:163-183
if [ ${#SSH_KEYS[@]} -eq 0 ]; then
    GITHUB_KEYS=($(find "$HOME/.ssh" -type f -name "github_*" ! -name "*.pub" 2>/dev/null | sort))

    if [ ${#GITHUB_KEYS[@]} -gt 0 ]; then
        echo ""
        echo "════════════════════════════════════════════════════════════════════════════════"
        echo "SSH Key Selection for Claude YOLO"
        echo "════════════════════════════════════════════════════════════════════════════════"
        echo ""
        echo "No SSH key was specified with --ssh-key flag."
        echo ""
        echo "Available GitHub SSH keys (managed by play-github-cli-multi.yml):"
        echo ""
        echo "  0) Continue without SSH key (git push will NOT work)"
        echo ""

        for i in "${!GITHUB_KEYS[@]}"; do
            key_name=$(basename "${GITHUB_KEYS[$i]}")
            echo "  $((i+1))) ${GITHUB_KEYS[$i]}"
        done

        echo ""
        echo "You can also specify keys manually with: ccy --ssh-key <path>"
        echo ""
        read -p "Select SSH key [0-${#GITHUB_KEYS[@]}]: " selection
        echo ""

        if [ -z "$selection" ]; then
            echo "No selection made. Exiting."
            exit 1
        fi

        if [ "$selection" = "0" ]; then
            echo "⚠  Continuing WITHOUT SSH key - git push operations will fail"
            echo ""
        elif [ "$selection" -ge 1 ] && [ "$selection" -le ${#GITHUB_KEYS[@]} ]; then
            SSH_KEYS+=("${GITHUB_KEYS[$((selection-1))]}")
            echo "✓ Selected: ${GITHUB_KEYS[$((selection-1))]}"
            echo ""
        else
            echo "ERROR: Invalid selection: $selection"
            exit 1
        fi

        echo "════════════════════════════════════════════════════════════════════════════════"
        echo ""
    else
        echo ""
        echo "════════════════════════════════════════════════════════════════════════════════"
        echo "⚠  WARNING: No SSH Keys Available"
        echo "════════════════════════════════════════════════════════════════════════════════"
        echo ""
        echo "No github_ SSH keys found in ~/.ssh/"
        echo "Git push operations will NOT work without SSH keys."
        echo ""
        echo "To set up GitHub SSH keys, run:"
        echo "  ansible-playbook playbooks/imports/optional/common/play-github-cli-multi.yml"
        echo ""
        echo "Or specify a key manually:"
        echo "  ccy --ssh-key ~/.ssh/id_ed25519"
        echo ""
        read -p "Press Enter to continue WITHOUT SSH key, or Ctrl+C to cancel: "
        echo ""
        echo "════════════════════════════════════════════════════════════════════════════════"
        echo ""
    fi
fi

# Get current user's UID and GID for proper file ownership
HOST_UID=$(id -u)
HOST_GID=$(id -g)

# Safety check: Never run as root (UID 0)
if [ "$HOST_UID" -eq 0 ]; then
    echo "ERROR: Cannot run Claude Code YOLO mode as root user (UID 0)"
    echo "This is a security restriction for --dangerously-skip-permissions mode"
    echo "Please run this command as a regular user, not with sudo or as root"
    exit 1
fi

# Safety check: Only run in rootless Docker
DOCKER_CONTEXT=$(docker context inspect 2>/dev/null | grep -o '"Name": *"[^"]*"' | head -1 | cut -d'"' -f4)
if [ "$DOCKER_CONTEXT" != "rootless" ]; then
    echo "ERROR: Claude Code YOLO mode requires rootless Docker"
    echo "Current Docker context: ${DOCKER_CONTEXT:-default}"
    echo ""
    echo "This is a security requirement because:"
    echo "  • YOLO mode bypasses all permission checks"
    echo "  • Running in rootless Docker provides isolation"
    echo "  • Non-rootless Docker would give actual root privileges"
    echo ""
    echo "To set up rootless Docker:"
    echo "  1. Install: dockerd-rootless-setuptool.sh install"
    echo "  2. Switch context: docker context use rootless"
    echo ""
    echo "Or run the Docker playbook:"
    echo "  ansible-playbook playbooks/imports/optional/common/play-docker.yml"
    exit 1
fi

# Ensure cache directory exists
mkdir -p "$(dirname "$VERSION_CACHE")"

# Force rebuild if --rebuild flag was provided
if [ "$FORCE_REBUILD" = true ]; then
    echo "Forcing container rebuild..."
    if [ ! -f "$DOCKERFILE_DIR/Dockerfile" ]; then
        echo "Error: Dockerfile not found at $DOCKERFILE_DIR/Dockerfile"
        echo "Please run the ansible playbook: playbooks/imports/optional/common/play-install-claude-yolo.yml"
        exit 1
    fi
    docker build --no-cache -t "$IMAGE_NAME" "$DOCKERFILE_DIR"
    # Clear version cache to force Claude Code update check
    rm -f "$VERSION_CACHE"
    echo "✓ Container image rebuilt successfully"
fi

# Check if Docker image exists
if ! docker image inspect "$IMAGE_NAME" &> /dev/null; then
    echo "Building Claude YOLO container image (first time setup)..."
    if [ ! -f "$DOCKERFILE_DIR/Dockerfile" ]; then
        echo "Error: Dockerfile not found at $DOCKERFILE_DIR/Dockerfile"
        echo "Please run the ansible playbook: playbooks/imports/optional/common/play-install-claude-yolo.yml"
        exit 1
    fi
    docker build -t "$IMAGE_NAME" "$DOCKERFILE_DIR"
    echo "✓ Container image built successfully"
fi

# Check if Claude Code needs updating (with caching to keep it fast)
should_update_claude=false
if [ -f "$VERSION_CACHE" ]; then
    # Check cache age
    cache_age=$(($(date +%s) - $(stat -c %Y "$VERSION_CACHE" 2>/dev/null || echo 0)))
    if [ $cache_age -gt $CACHE_DURATION ]; then
        should_update_claude=true
    fi
else
    should_update_claude=true
fi

# Update Claude Code in container if needed
if [ "$should_update_claude" = true ]; then
    echo "Checking for Claude Code updates..."
    docker run --rm --entrypoint sh "$IMAGE_NAME" -c "npm update -g @anthropic-ai/claude-code 2>&1" | grep -v "npm WARN" || true
    # Update cache timestamp
    touch "$VERSION_CACHE"
fi

# Create temp directory for config files to copy into container
CONFIG_TEMP="/tmp/claude-yolo-$$"
mkdir -p "$CONFIG_TEMP"
chmod 755 "$CONFIG_TEMP"

# Copy Claude Code credentials
cp "$HOME/.claude/.credentials.json" "$CONFIG_TEMP/credentials.json"
chmod 644 "$CONFIG_TEMP/credentials.json"

# Copy Claude Code settings
cp "$HOME/.claude/settings.json" "$CONFIG_TEMP/settings.json"
chmod 644 "$CONFIG_TEMP/settings.json"

# Copy global config and modify installMethod for container
jq '.installMethod = "npm"' "$HOME/.claude.json" > "$CONFIG_TEMP/config.json"
chmod 644 "$CONFIG_TEMP/config.json"

# Copy git config
cp "$HOME/.gitconfig" "$CONFIG_TEMP/gitconfig"
chmod 644 "$CONFIG_TEMP/gitconfig"

# Cleanup function
cleanup() {
    rm -rf "$CONFIG_TEMP"
}
trap cleanup EXIT

# Build SSH key mount arguments and extract GitHub account
SSH_MOUNTS=()
SSH_KEY_PATHS=()
GITHUB_USERNAME=""

for i in "${!SSH_KEYS[@]}"; do
    SSH_MOUNTS+=("-v" "${SSH_KEYS[$i]}:/root/.ssh/key_$i:ro")
    SSH_KEY_PATHS+=("/root/.ssh/key_$i")

    # Extract GitHub username by testing SSH connection with the key
    # This works for any SSH key (github_ or otherwise)
    # ssh -T will respond with: "Hi <username>! You've successfully authenticated..."
    GITHUB_USERNAME=$(ssh -T -i "${SSH_KEYS[$i]}" -o IdentitiesOnly=yes -o StrictHostKeyChecking=no git@github.com 2>&1 | grep -oP "Hi \K[^!]+")

    if [ -z "$GITHUB_USERNAME" ]; then
        echo "ERROR: SSH key authentication to GitHub failed: ${SSH_KEYS[$i]}"
        echo ""
        echo "The selected SSH key is not registered with any GitHub account."
        echo ""
        echo "To fix this:"
        echo "  1. Go to https://github.com/settings/keys"
        echo "  2. Click 'New SSH key'"
        echo "  3. Add the public key from: ${SSH_KEYS[$i]}.pub"
        echo ""
        echo "Or set up GitHub keys with:"
        echo "  ansible-playbook playbooks/imports/optional/common/play-github-cli-multi.yml"
        exit 1
    fi

    echo "✓ Detected GitHub account for SSH key: $GITHUB_USERNAME"
done

# Get GitHub token from gh CLI
if ! command -v gh &> /dev/null; then
    echo "ERROR: gh (GitHub CLI) not found"
    echo "Install it with: ansible-playbook playbooks/imports/play-git-configure-and-tools.yml"
    exit 1
fi

# If we detected a GitHub username from SSH key, get the account-specific token
# This requires play-github-cli-multi.yml to be configured and shell reloaded
if [ -n "$GITHUB_USERNAME" ] && [ ${#SSH_KEYS[@]} -gt 0 ]; then
    # Extract alias from the first SSH key
    key_basename=$(basename "${SSH_KEYS[0]}")
    if [[ "$key_basename" =~ ^github_(.+)$ ]]; then
        alias="${BASH_REMATCH[1]}"
        token_func="gh-token-${alias}"

        # Load gh aliases if not already loaded (script runs in subshell)
        if ! type "$token_func" &>/dev/null; then
            if [ -f "$HOME/.bashrc-includes/gh-aliases.inc.bash" ]; then
                source "$HOME/.bashrc-includes/gh-aliases.inc.bash"
            fi
        fi

        # Check if the gh-token-<alias> function exists (from play-github-cli-multi.yml)
        if ! type "$token_func" &>/dev/null; then
            echo "ERROR: GitHub multi-account function not found: $token_func"
            echo ""
            echo "Selected SSH key: ${SSH_KEYS[0]}"
            echo "Expected file: ~/.bashrc-includes/gh-aliases.inc.bash"
            echo "Expected function: $token_func"
            echo ""
            echo "Required: gh-token-<alias> functions from play-github-cli-multi.yml"
            echo ""
            echo "To fix:"
            echo "  1. Run: ansible-playbook playbooks/imports/optional/common/play-github-cli-multi.yml"
            echo "  2. Verify: ls -la ~/.bashrc-includes/gh-aliases.inc.bash"
            echo "  3. Verify: grep $token_func ~/.bashrc-includes/gh-aliases.inc.bash"
            exit 1
        fi

        # Get the token for the specific account
        GH_TOKEN=$($token_func 2>/dev/null)
        if [ -z "$GH_TOKEN" ]; then
            echo "ERROR: Failed to retrieve token for account: $GITHUB_USERNAME"
            echo ""
            echo "Function $token_func returned no token."
            echo "Account is not authenticated with gh CLI."
            echo ""
            echo "Fix: ansible-playbook playbooks/imports/optional/common/play-github-cli-multi.yml"
            exit 1
        fi

        echo "✓ Retrieved token for GitHub account: $GITHUB_USERNAME (via $token_func)"
    fi
else
    # No GitHub username detected - fall back to default token
    GH_TOKEN=$(gh auth token 2>/dev/null)

    if [ -z "$GH_TOKEN" ]; then
        echo "ERROR: Not authenticated with GitHub CLI"
        echo ""
        echo "Run: gh auth login"
        echo ""
        echo "For multi-account setup with github_ SSH keys, run:"
        echo "  ansible-playbook playbooks/imports/optional/common/play-github-cli-multi.yml"
        exit 1
    fi
fi

# Convert SSH_KEY_PATHS array to colon-separated string
SSH_KEY_PATHS_STR=$(IFS=:; echo "${SSH_KEY_PATHS[*]}")

# Run container with config files mounted temporarily
# The entrypoint script will copy these files to the proper locations inside the container
# All Claude Code state (history, todos, projects) stays inside container and is discarded
docker run -it --rm \
    -v "$PWD:/workspace" \
    -v "$CONFIG_TEMP:/tmp/claude-config-import:ro" \
    "${SSH_MOUNTS[@]}" \
    -e "GH_TOKEN=$GH_TOKEN" \
    -e "GITHUB_USERNAME=$GITHUB_USERNAME" \
    -e "DEBUG_MODE=$DEBUG_MODE" \
    -e "SSH_KEY_PATHS=$SSH_KEY_PATHS_STR" \
    -w /workspace \
    "$IMAGE_NAME" \
    claude --dangerously-skip-permissions "${CLAUDE_ARGS[@]}"
